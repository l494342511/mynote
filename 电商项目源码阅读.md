# 电商项目源码阅读

## 1. 商城系统模块

### 1.1 商城用户系统功能模块

![img](%E7%94%B5%E5%95%86%E9%A1%B9%E7%9B%AE%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB.assets/16e1c01073e25aed)

### 1.2 商城后台管理系统功能模块

![img](%E7%94%B5%E5%95%86%E9%A1%B9%E7%9B%AE%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB.assets/16e1c01073d93ae4)

## 2. 商城系统页面基本结构

### 2.1 电商用户界面基本结构

**商城主页**

![img](%E7%94%B5%E5%95%86%E9%A1%B9%E7%9B%AE%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB.assets/16e37443f5359d55)

**个人中心**

![img](https://user-gold-cdn.xitu.io/2019/11/5/16e37443f4f2ad36?imageslim)

### 2.2 电商后台管理界面基本结构

![img](%E7%94%B5%E5%95%86%E9%A1%B9%E7%9B%AE%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB.assets/16e37443eba00051)

## 3. 验证码系统(kaptcha)

### 3.1 验证码生成

引入依赖

```xml
<dependency>
    <groupId>com.github.penggle</groupId>
    <artifactId>kaptcha</artifactId>
    <version>2.3.2</version>
</dependency>
```

配置验证码组件，设置属性

```java
@Component
public class kaptchaConfig {
    @Bean
    public com.google.code.kaptcha.impl.DefaultKaptcha getDefaultKaptcha(){
        DefaultKaptcha defaultKaptcha = new DefaultKaptcha();
        Properties properties = new Properties();
        properties.put("KAPTCHA_BORDER","no");//边框
        properties.put("KAPTCHA_TEXTPRODUCER_FONT_COLOR","black");//字体颜色
        properties.put("KAPTCHA_IMAGE_WIDTH","160");//图片宽
        properties.put("KAPTCHA_IMAGE_HEIGHT","40");//图片高
        properties.put("KAPTCHA_TEXTPRODUCER_FONT_SIZE","30");//字体大小
        properties.put("KAPTCHA_TEXTPRODUCER_CHAR_LENGTH","5");//验证码长度
        properties.put("KAPTCHA_TEXTPRODUCER_FONT_NAMES","宋体,楷体,微软雅黑");//字体
        Config config = new Config(properties);
        defaultKaptcha.setConfig(config);
        return defaultKaptcha;
    }
}
```

后端生成验证码

```java
@Autowired
private DefaultKaptcha captchaProducer;

@GetMapping("/kaptcha")
public void defaultKaptcha(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse) throws Exception {
    byte[] captchaOutputStream = null;
    ByteArrayOutputStream imgOutputStream = new ByteArrayOutputStream();//一个字节型输出流用来输出验证码图片
    try {
        //生产验证码字符串并保存到session中
        String verifyCode = captchaProducer.createText();
        httpServletRequest.getSession().setAttribute("verifyCode", verifyCode);//发送验证码的文字
        BufferedImage challenge = captchaProducer.createImage(verifyCode);
        ImageIO.write(challenge, "jpg", imgOutputStream);
    } catch (IllegalArgumentException e) {
        httpServletResponse.sendError(HttpServletResponse.SC_NOT_FOUND);
        return;
    }
    captchaOutputStream = imgOutputStream.toByteArray();
    httpServletResponse.setHeader("Cache-Control", "no-store");
    httpServletResponse.setHeader("Pragma", "no-cache");
    httpServletResponse.setDateHeader("Expires", 0);
    httpServletResponse.setContentType("image/jpeg");
    ServletOutputStream responseOutputStream = httpServletResponse.getOutputStream();
    responseOutputStream.write(captchaOutputStream);
    responseOutputStream.flush();
    responseOutputStream.close();
}
```

前端显示验证码，点击可验证和刷新（在这调verify接口，并且将输入框中的文字作为参数输入接口）

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>验证码测试</title>
</head>
<body>
<img src="/kaptcha"
     onclick="this.src='/kaptcha?d='+new Date()*1">
<input type="text" maxlength="5" id="code" placeholder="请输入验证码">
<button id="verify">验证</button>
</body>
<script src="jquery.js"></script>
<script type="text/javascript">
    $(function () {
        $("#verify").click(function () {
            var code = $("#code").val();
            $.ajax({
                type: 'GET',//方法类型
                url: '/verify?code=' + code,
                success: function (result) {
                    alert(result);
                },
                error: function () {
                    alert("请求失败");
                }
            });
        })
    });
</script>
</html>
```

### 3.2 验证码验证

验证验证码（@ResponseBody返回的是字符串）

```java
@GetMapping("/verify")
@ResponseBody
public String verify(@RequestParam("code") String code, HttpSession session) {
    if (StringUtils.isEmpty(code)) {
        return "验证码不能为空";
    }
    String kaptchaCode = session.getAttribute("verifyCode") + "";//获取验证码的文字
    if (StringUtils.isEmpty(kaptchaCode) || !code.equals(kaptchaCode)) {
        return "验证码错误";
    }
    return "验证成功";
}
```

## 4. 登录系统

### 4.1 登录的实现

登录的基本实现只需要做一次数据库匹配：

1. 数据库中储存的密码应该是经加密后的密码
2. 需要匹配的属性有用户名、密码以及验证码
3. 登录状态应该是持续的，不能每个网页都需要登录一次

**登录使用的数据库语句**

mybatis的\<resultMap>标签用来指定实体类和数据库属性名之间的对应关系，注意指定命名空间

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ltd.newbee.mall.dao.AdminMapper">
    <resultMap id="BaseResultMap" type="ltd.newbee.mall.entity.AdminUser">
        <id column="admin_user_id" jdbcType="INTEGER" property="adminUserId" />
        <result column="login_user_name" jdbcType="VARCHAR" property="loginUserName" />
        <result column="login_password" jdbcType="VARCHAR" property="loginPassword" />
        <result column="nick_name" jdbcType="VARCHAR" property="nickName" />
        <result column="locked" jdbcType="TINYINT" property="locked" />
    </resultMap>
    <sql id="Base_Column_List">
    admin_user_id, login_user_name, login_password, nick_name, locked
  </sql>

    <select id="login" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List" />
        from tb_newbee_mall_admin_user
        where login_user_name = #{userName,jdbcType=VARCHAR} AND login_password=#{password,jdbcType=VARCHAR} AND locked = 0
    </select>

</mapper>
```

**对应的mapper**

```java
public interface AdminMapper {

    /**
     * 登陆方法
     *
     * @param userName
     * @param password
     * @return
     */
    AdminUser login(@Param("userName") String userName, @Param("password") String password);

}
```

**对应的业务层**

```java
@Service
public class AdminUserServiceImpl implements AdminUserService {

    @Resource
    private AdminMapper adminMapper;

    @Override
    public AdminUser login(String userName, String password) {
        String passwordMd5 = MD5Util.MD5Encode(password, "UTF-8");
        return adminMapper.login(userName, passwordMd5);
    }
}
```

**实现接口**

```java
@Controller
@RequestMapping("/admin")
public class AdminController {

    @Resource
    private AdminUserService adminUserService;

    @GetMapping({"/login"})
    public String login() {
        return "admin/login";
    }

    @PostMapping(value = "/login")
    public String login(@RequestParam("userName") String userName,
                        @RequestParam("password") String password,
                        @RequestParam("verifyCode") String verifyCode,
                        HttpSession session) {
        if (StringUtils.isEmpty(verifyCode)) {
            session.setAttribute("errorMsg", "验证码不能为空");
            return "admin/login";
        }
        if (StringUtils.isEmpty(userName) || StringUtils.isEmpty(password)) {
            session.setAttribute("errorMsg", "用户名或密码不能为空");
            return "admin/login";
        }
        String kaptchaCode = session.getAttribute("verifyCode") + "";
        if (StringUtils.isEmpty(kaptchaCode) || !verifyCode.equals(kaptchaCode)) {
            session.setAttribute("errorMsg", "验证码错误");
            return "admin/login";
        }
        AdminUser adminUser = adminUserService.login(userName, password);
        if (adminUser != null) {
            session.setAttribute("loginUser", adminUser.getNickName());
            session.setAttribute("loginUserId", adminUser.getAdminUserId());
            //session过期时间设置为7200秒 即两小时
            //session.setMaxInactiveInterval(60 * 60 * 2);
            return "redirect:/admin/index";
        } else {
            session.setAttribute("errorMsg", "登录信息错误");
            return "admin/login";
        }
    }

    @GetMapping({"/index"})
    public String index() {
        return "admin/index";
    }

}
```

### 4.2 登录状态的保存

保存登录状态的方式有两种，用的较多的是浏览器的cookie，在Java的web开发中也常常使用session

#### 4.2.1 cookie的实现

**存储**

```java
//通过 Cookie 存储
Cookie cookie = new Cookie("userName",xxxxx);
```

**验证**

```java
//通过 Cookie 获取需要验证的数据并进行比对校验
Cookie cookies[] = request.getCookies();
if (cookies != null){
    for (int i = 0; i < cookies.length; i++)
           {
               Cookie cookie = cookies[i];
               if (name.equals(cookie.getName()))
               {
                    return cookie;
               }
           }
}
```

#### 4.2.2 session的实现

**存储**

```java
//通过 Session 存储
session.setAttribute("userName",xxxxx);
```

**验证**

```java
//通过session获取需要验证的数据并进行比对校验
session.getAttribute("userName");
```

