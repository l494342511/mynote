# 变构团项目阅读笔记

[TOC]



## 0. 问题

| 问题                                                | 解答                                                         |
| --------------------------------------------------- | ------------------------------------------------------------ |
| @PostMapping, @GetMapping 的区别                    | @PostMapping实际上是@RequestMapping(method=Request.Post) post请求是安全的，请求内容不会被存储在浏览器缓存中，一般用来提交表单或者上传文件；get请求是不安全的，请求会被存在浏览器缓存中； |
| 为什么不用@Autowired注入而用final                   | @Autowired不被推荐，容易造成循环依赖，空指针依赖等问题；建议使用final加构造器的方式； |
| serviceImpl类为什么用@RequiredArgsConstructor       | 构造器+final的方式实现依赖注入                               |
| @ApiModelProperty                                   | n                                                            |
| 没有根据用户id查询角色或者资源的接口                | n                                                            |
| shiro如何记录当前用户的id                           | n                                                            |
| 什么是导航页码                                      | n                                                            |
| shiro中resources.getPermission是什么                | n                                                            |
| shiro同时登录多个用户时的session管理                | n                                                            |
| D9lab 接入api                                       | n                                                            |
| 小程序授权登录的code从哪来                          | 可以在前端使用js调用wx.login()接口获得                       |
| 微信controller接口的入参是前端先调用vxAPI传进来的吗 | n                                                            |
| 为什么支付信息里团购规则和团购记录id只能出现一个    | n                                                            |
| 支付时入参中的签名的作用是？怎么生成有效的签名？    | n                                                            |
| 用户支付controller中的异步调用的作用？              | n                                                            |
| d9lab api中的notifyModel？                          | n                                                            |
| 团购下单为什么不用检查参团/发团资格或者是否支付     | n                                                            |
| 参团和开团接口怎么不需要支付                        | n                                                            |





## 1.项目结构

### 1.1 admin

### 1.2 portal

### 1.3 pojo

### 1.4 common

## 2. 管理员模块

### 2.1 权限管理模块

#### 2.1.1 权限管理框架

| 组件           | 描述                                                         |
| -------------- | ------------------------------------------------------------ |
| 用户(user)     | 用户对应一个真实的账户                                       |
| 角色(role)     | 每个角色拥有各自的资源使用权限, 一个用户可以被分配多个角色,一个角色可以被分配多个资源 |
| 资源(resource) | 一个角色可以被分配多个资源, 被分配了资源代表了拥有该角色的用户也就拥有了使用该资源的权限, 资源可以理解为可以做的事 |

**三者间的关系: **用户对应多个角色, 角色对应多个资源, 角色间接的连接了用户和资源, 简化和规定了资源的分配



#### 2.1.2 权限管理接口

##### 1.**分配角色接口: /user/resignRoleToUser **

**参数**

| 参数                | 描述   |
| ------------------- | ------ |
| Long userId         | 用户id |
| String roleIdString | 角色id |

**代码**

```java
@ApiOperation("为用户指定角色")
@PostMapping("/resignRoleToUser")
public CommonResult resignRoleToUser(@NonNull @RequestParam Long userId,
                                     @NotBlank @RequestParam String roleIdString){
    int result = sysUserRoleService.assignRole2User(userId,roleIdString);
    if (result >= 0) {
        return CommonResult.success("为用户分配角色成功");
    }
    return CommonResult.failed("为用户分配角色失败");
}
```

**逻辑**

| 层级 | 实现逻辑                                                     |
| ---- | :----------------------------------------------------------- |
| 接口 | 1. 执行分配方法 2. 验证执行结果                              |
| 服务 | 1. 清空用户拥有的服务 2. 由输入的参数生成对应的sysUserRole对象 3. 入库并返回被影响的数据的行数 |

##### 2. 指定角色资源接口: /roleResource/assignResourceToRole

**参数:**

| 参数                    | 描述   |
| ----------------------- | ------ |
| Long roleId             | 角色id |
| String resourceIdString | 资源id |

**代码:**

```java
@ApiOperation("指定角色资源")
@PostMapping("/assignResourceToRole")
public CommonResult assignResourceToRole(@NonNull @RequestParam Long roleId,
                                         @NotBlank @RequestParam String resourceIdString){
    int result = roleResourceService.assignResource2Role(roleId, resourceIdString);
    if (result == 0) {
        return CommonResult.failed("批量插入失败，数据库插入有问题");
    }
        return CommonResult.success("为角色指定资源成功");

}
```

**逻辑:**

| 层级   | 逻辑                                                         |
| ------ | ------------------------------------------------------------ |
| 接口层 | 1. 执行业务 2. 校验业务执行结果                              |
| 业务层 | 2. 清空角色对应资源 2. 由输入的参数生成对应的sysRoleResources对象 3. 入库并返回被影响的数据的行数 |

#### 2.1.3 登录管理接口

##### 1. 登录接口

```java
@RequestMapping(value = "/login", method = RequestMethod.POST)
public CommonResult login(HttpServletRequest httpServletRequest,
                          @NotBlank @RequestParam String username,
                          @NotBlank @RequestParam String password){

    LoginVo loginVo = sysUserService.loginAdmin(IpUtil.getIpAddr(httpServletRequest),username,password);

    return CommonResult.success(loginVo,"登陆成功");
}
```

通过账号密码进行登录，并返回一个loginVO

**实现类**

```java
@Override
public LoginVo loginAdmin(String loginIp, String username, String password) {
    UsernamePasswordToken token = new UsernamePasswordToken(username, password);
    SecurityUtils.getSubject().login(token);
    SysUser sysUser = sysUserMapper.selectByPrimaryKey(ShiroUtil.getUserId());
    SysUser newSysUser = new SysUser();
    newSysUser.setId(sysUser.getId());
    newSysUser.setLastLoginIp(loginIp);
    newSysUser.setLastLoginTime(new Date());
    newSysUser.setLoginCount(sysUser.getLoginCount() + 1);
    sysUserMapper.updateByPrimaryKeySelective(newSysUser);
    LoginVo loginVo = new LoginVo();
    loginVo.setToken(ShiroUtil.getSession().getId());
    loginVo.setAdminType(ShiroUtil.getAdminType());
    return loginVo;
}
```

登录并且更新数据库中用户的信息：ip、上次登录时间、登录次数

返回的loginVO包含token和角色id

##### 2. 注销接口

```java
@RequestMapping(value = "/logout", method = RequestMethod.POST)
public CommonResult logout(){
    ShiroUtil.getSubject().logout();
    return CommonResult.success("退出成功");
}
```

注销当前用户

#### 2.1.4 静态资源管理接口（角色）

##### 0. 角色domain

```java
@Data
public class RoleParams {
    private Long id;

    @NotBlank(message = "角色名称不能为空")
    private String name;

    @NotBlank(message = "角色描述不能为空")
    private String description;
}
```

##### 1. 增加角色

```java
@ApiOperation("增加角色")
@PostMapping("/addOneRole")
public CommonResult addOneRole(@Valid @RequestBody RoleParams roleParams){
    int result = sysRoleService.insertOneRole(roleParams);
    if (result >= 0) {
        return CommonResult.success("添加角色成功");
    }
    return CommonResult.failed("资源角色失败");
}
```

**服务层**

```java
public Integer insertOneRole(RoleParams roleParams) {
    SysRole sysRole = new SysRole();
    BeanUtil.copyProperties(roleParams,sysRole);
    sysRole.setAvailable(SysStatusEnum.AVAILABLE.getCode());
    sysRole.setCreateTime(new Date());
    sysRole.setUpdateTime(new Date());
    return sysRoleMapper.insertSelective(sysRole);
}
```

角色信息包括名字和id，并且增加创建日期和更新日期

##### 2. 更新角色

```java
@ApiOperation("更新角色")
@PostMapping("/updateRole")
public CommonResult updateRole(@Valid @RequestBody RoleParams roleParams){
    int result = sysRoleService.updateRole(roleParams);
    if (result >= 0) {
        return CommonResult.success("更新角色成功");
    }
    return CommonResult.failed("角色更新失败");
}
```

**服务层**

```java
@Override
public Integer updateRole(RoleParams roleParams) {
    SysRole sysRole = new SysRole();
    BeanUtil.copyProperties(roleParams,sysRole);
    sysRole.setUpdateTime(new Date());
    return sysRoleMapper.updateByPrimaryKeySelective(sysRole);
}
```

##### 3. 获取所有角色

**参数**

| 参数   | 描述       |
| ------ | ---------- |
| 页码   | 默认值为1  |
| 页容量 | 默认值为10 |

**接口**

```java
@ApiOperation("获取所有角色")
@GetMapping("/getRoleList")
public CommonResult getAdminList( @RequestParam(value="pageNum",defaultValue = "1") Integer pageNum,
                                  @RequestParam(value="size",defaultValue ="10") Integer size){
    CommonPage<RoleVo> roleVos = sysRoleService.listRoles(pageNum, size);
    if (roleVos != null) {
        return CommonResult.success(roleVos,"获取角色列表成功");
    }
    return CommonResult.failed("获取角色列表失败");
}
```

**服务层**

```java
@Override
public CommonPage<RoleVo> listRoles(Integer pageNum, Integer size) {
    PageHelper.startPage(pageNum, size);
    List<SysRole> roleList=sysRoleMapper.selectByExample(new SysRoleExample());
    List<RoleVo> roleVoList=roleList.stream().map(this::tans2Vo).collect(Collectors.toList());
    return CommonPage.restPage(roleVoList);
}
```

查到的数据转换为vo用于展示

**转换展示层方法**

```java
private RoleVo tans2Vo(SysRole sysRole){
    RoleVo roleVo = new RoleVo();
    BeanUtil.copyProperties(sysRole,roleVo);
    return roleVo;
}
```

##### 4. 根据角色id删除角色

```java
@ApiOperation("根据角色id删除角色")
@GetMapping("/deleteOneRoleByRoleId")
public CommonResult deleteOneRoleByRoleId(@NotNull @RequestParam Long roleId){
    int deleteResult = sysRoleService.deleteOneRole(roleId);
    if (deleteResult >= 0) {
        return CommonResult.success("删除角色成功");
    }
    return CommonResult.failed("删除角色失败");
}
```

**服务层**

```java
@Override
@Transactional
public Integer deleteOneRole(Long roleId) {
    sysRoleMapper.deleteByPrimaryKey(roleId);
    SysRoleResourcesExample roleResourcesExample = new SysRoleResourcesExample();
    roleResourcesExample.createCriteria().andRoleIdEqualTo(roleId);
    sysRoleResourcesMapper.deleteByExample(roleResourcesExample);
    SysUserRoleExample userRoleExample = new SysUserRoleExample();
    userRoleExample.createCriteria().andRoleIdEqualTo(roleId);
    return sysUserRoleMapper.deleteByExample(userRoleExample);
}
```

使用@Transactional进行标注，在出问题时进行事务回滚

删除角色和与角色相关联的用户信息

#### 2.1.5 静态资源管理接口（资源）

##### 1. 添加资源

```java
@ApiOperation("添加资源")
@PostMapping(value="/addOneResource")
public CommonResult addOneResource(@Valid @RequestBody ResourceParams resourceParams){
   return sysResourcesService.insertOneResource(resourceParams);
}
```

**服务层**

```java
@Override
public CommonResult insertOneResource(ResourceParams resourceParams) {
    SysResourcesExample example = new SysResourcesExample();
    example.createCriteria().andUrlEqualTo(resourceParams.getUrl());
    List<SysResources> oldResource = sysResourcesMapper.selectByExample(example);
    if (CollectionUtils.isNotEmpty(oldResource)) {
        return CommonResult.failed("URL资源重复");
    }
    SysResources sysResources = new SysResources();
    BeanUtil.copyProperties(resourceParams,sysResources);
    sysResources.setAvailable(SysStatusEnum.AVAILABLE.getCode());
    sysResources.setCreateTime(new Date());
    sysResources.setUpdateTime(new Date());
    int row = sysResourcesMapper.insertSelective(sysResources);
    if (row >= 0) {
        return CommonResult.success("添加成功");
    }
    return CommonResult.failed("添加失败");
}
```

禁止重复添加相同资源

##### 2. 更新资源

```java
@ApiOperation("更新资源")
@PostMapping("/updateResource")
public CommonResult updateResource(@Valid @RequestBody ResourceParams resourceParams){
    int result = sysResourcesService.updateResource(resourceParams);
    if (result >= 0) {
        return CommonResult.success("更新资源成功");
    }
    return CommonResult.failed("更新添加失败");
}
```

**服务层**

```java
@Override
public Integer updateResource(ResourceParams resourceParams) {
    SysResources sysResources = new SysResources();
    BeanUtil.copyProperties(resourceParams,sysResources);
    sysResources.setUpdateTime(new Date());
    return sysResourcesMapper.updateByPrimaryKeySelective(sysResources);
}
```

##### 3. 获取所有资源

```java
@ApiOperation("获取所有资源")
@GetMapping("/getResourceList")
public CommonResult getResourceList(){
    List<ResourceVo> resourceVoList=sysResourcesService.listResourceVos();
    if (!resourceVoList.isEmpty()) {
        return CommonResult.success(resourceVoList, "获取所有资源成功");
    }
    return CommonResult.failed("获取所有资源失败");
}
```

**服务层**

```java
@Override
public List<ResourceVo> listResourceVos() {
    List<SysResources> sysResourcesList = sysResourcesMapper.selectByExample(new SysResourcesExample());
    return transform2TreeResourceVo(sysResourcesList);
}
```

返回vo并转换为树形结构

##### 4. 删除资源

```java
@ApiOperation("删除资源")
@GetMapping("/deleteOneResource")
public CommonResult deleteOneResource(@NotNull @RequestParam Long resourceId){
    int result = sysResourcesService.deleteOneResource(resourceId);
    if (result >= 0) {
        return CommonResult.success("删除资源成功");
    }
    return CommonResult.failed("删除添加失败");
}
```

**服务层**

```java
@Override
@Transactional
public Integer deleteOneResource(Long resourceId) {
    sysResourcesMapper.deleteByPrimaryKey(resourceId);
    SysRoleResourcesExample example = new SysRoleResourcesExample();
    example.createCriteria().andResourcesIdEqualTo(resourceId);
    return sysRoleResourcesMapper.deleteByExample(example);
}
```

删除资源和资源相关联的角色的数据

##### 1. 根据角色获得资源

```java
@ApiOperation("根据角色获取所有资源")
@GetMapping("/getResourceVosByRoleId")
public CommonResult getResourceVosByRoleId(@NotNull @RequestParam Long roleId){
    List<ResourceVo> resourceVos = sysRoleService.listResourceVosByRoleId(roleId);
    if (resourceVos != null) {
        return CommonResult.success(resourceVos,"获取角色资源成功");
    }
    return CommonResult.failed("获取角色资源失败");
}
```

**服务层**

```java
@Override
public List<ResourceVo> listResourceVosByRoleId(Long roleId) {
      return sysResourcesService.listResourceVosByRoleId(roleId); 
}
```

```java
@Override
public List<ResourceVo> listResourceVosByRoleId(Long roleId) {
    List<SysResources> sysResourcesList = sysResourcesMapper.listResourcesByRoleId(roleId);
    return transform2TreeResourceVo(sysResourcesList);
}
```

转换为树型结构展示

#### 2.1.6 静态资源管理接口（用户）

##### 0. 用户domain

```java
@Data
public class UserParams {

    private Long id;

    @NotBlank(message="用戶姓名不能為空")
    private String username;

    @NotBlank(message="密碼不能為空")
    private String password;

    private String mobile;

    @NotNull
    private Byte gender;

    @NotNull
    private Integer userType;

    private String remark;

}
```

##### 1. 增加系统管理员

```java
@ApiOperation("增加系统管理员用户")
@PostMapping("/addOneUser")
public CommonResult addOneUser(HttpServletRequest httpServletRequest,
                            @Valid @RequestBody UserParams userParams){
    SysUser result = sysUserService.insertOneUser(IpUtil.getIpAddr(httpServletRequest),userParams);
    if (result != null) {
        return CommonResult.success("添加用户成功");
    }
    return CommonResult.failed("添加用户失败");
}
```

**服务层**

```java
@Override
public SysUser insertOneUser(String RegIp, UserParams userParams) {
    SysUser sysUser = new SysUser();
    BeanUtil.copyProperties(userParams,sysUser);
    sysUser.setStatus(SysStatusEnum.AVAILABLE.getCode());
    sysUser.setPassword(Md5Util.encrypt(userParams.getPassword()));
    sysUser.setRegIp(RegIp);
    int result = sysUserMapper.insertSelective(sysUser);
    if (result >= 0) {
        return sysUser;
    }
    return null;
}
```

密码用MD5编码

##### 2.  获取当前用户资源

```java
@ApiOperation(value = "获取用户的资源列表")
@GetMapping("/getResourcesByUser")
public CommonResult listResourcesByUser(){
    Long userId = ShiroUtil.getUserId();
    List<ResourceVo> resourceVos = sysResourcesService.listResourceVosByUserId(userId);
    if (CollectionUtils.isNotEmpty(resourceVos)) {
        return CommonResult.success(resourceVos,"获取树形资源成功");
    }
    return CommonResult.failed("没有此用户的资源");
}
```

根据用户id查询并且转换为树型结构返回

**服务层**

```java
@Override
public List<ResourceVo> listResourceVosByUserId(Long userId) {
    List<SysResources> sysResourcesList = listResourcesByUserId(userId);
    return transform2TreeResourceVo(sysResourcesList);
}
```

**构建树形资源列表方法:**

**实现方法:** SysResources对象包含父节点的id, 通过比较点的父节点id和节点id来构建树形列表

**构建方法:**

```java
public List<ResourceVo> transform2TreeResourceVo(List<SysResources> sysResources){
     List<ResourceVo>  resourceVos = sysResources.stream()
             .filter(sysResource -> sysResource.getParentId().equals(0L))
             .map(sysResource->covert(sysResource,sysResources))
             .collect(Collectors.toList());

     return resourceVos;
}
```

通过流进行遍历操作, filter()方法过滤判断结果为false的元素, 在这个方法中,是用于留下父结点id为0的节点, 也就是第一级节点. 然后使用map为这些第一级节点生成子树, 子树以ResourceVo的形式返回.

**子树构建方法:**

```java
public ResourceVo covert(SysResources sysResources, List<SysResources> ResourceNodes){
    //转换成Vo
    ResourceVo resourceVo = transform2Vo(sysResources);
    List<ResourceVo> subResourceNodes=ResourceNodes.stream()
            .filter(subResourceNode->subResourceNode.getParentId().equals(resourceVo.getId()))
            .map(subResourceNode->covert(subResourceNode,ResourceNodes))
            .sorted(Comparator.comparing(ResourceVo::getSort))
            .collect(Collectors.toList());
    resourceVo.setResourceNodeList(subResourceNodes);
    return resourceVo;
}
```

| 参数          | 描述             |
| ------------- | ---------------- |
| sysResources  | 操作的根节点     |
| ResourceNodes | 操作的所有节点集 |

通过流遍历所有的节点, 如果一个节点的父结点id与当前根节点id相同, 则将该节点加入当前根节点的子节点列表中, 并做递归操作

**转换为vo: **

```java
public ResourceVo transform2Vo(SysResources sysResources){
    ResourceVo resourceVo = new ResourceVo();
    BeanUtil.copyProperties(sysResources,resourceVo);
    return resourceVo;
}
```

##### 3. 获取所有管理员

```java
@ApiOperation("获取所有管理员列表")
@GetMapping("/getAdminList")
public CommonResult getAdminList( @RequestParam(value="page",defaultValue = "1") Integer page,
                                  @RequestParam(value="size",defaultValue ="10") Integer size){
   CommonPage<UserVo> userVos = sysUserService.listAdmins(page, size);
    if (userVos != null) {
        return CommonResult.success(userVos,"获取管理员列表成功");
    }
    return CommonResult.failed("获取管理员列表失败");
}
```

**服务层**

```java
@Override
public CommonPage<UserVo> listAdmins(Integer page, Integer size) {
    PageHelper.startPage(page,size);
    List<UserVo> userVoList = userCustomMapper.listUserVos();
    return CommonPage.restPage(userVoList);
}
```

根据分页信息进行查询并且转换为vo

##### 4. 删除用户

```java
@ApiOperation(value = "删除用户")
@PostMapping("/deleteOneUser")
public CommonResult deleteOneUser(@RequestParam Long userId){
    int result = sysUserService.deleteOneAdminUser(userId);
    if (result >= 0) {
        return CommonResult.success("删除角色成功");
    }
    return CommonResult.failed("删除角色失败");
}
```

**服务层**

```java
@Override
@Transactional
public Integer deleteOneAdminUser(Long userId) {
    SysUser sysUser = sysUserMapper.selectByPrimaryKey(userId);
    if (UserTypeEnum.INSTITUTION_ADMIN.getCode().equals(sysUser.getUserType())) {
        InstitutionSysUserExample institutionSysUserExample = new InstitutionSysUserExample();
        institutionSysUserExample.createCriteria().andSysUserIdEqualTo(userId);
        institutionSysUserMapper.deleteByExample(institutionSysUserExample);
    }
    sysUserMapper.deleteByPrimaryKey(userId);
    SysUserRoleExample sysUserRoleExample = new SysUserRoleExample();
    sysUserRoleExample.createCriteria().andUserIdEqualTo(userId);
    return sysUserRoleMapper.deleteByExample(sysUserRoleExample);
}
```

如果管理员用户还是机构管理员，也要在机构相关表中删除他的信息，用@Transactional进行事务回滚

##### 5. 更新用户

```java
@ApiOperation(value = "更行用户")
@PostMapping("/updateUser")
public CommonResult updateUser(@RequestBody UserParams userParams) {
    int result = sysUserService.updateUser(userParams);
    if (result >= 0) {
        return CommonResult.success("更新管理员信息成功");
    }
    return CommonResult.failed("更新管理员信息失败");
}
```

**服务层**

```java
@Override
public Integer updateUser(UserParams userParams) {
    SysUser sysUser = new SysUser();
    BeanUtil.copyProperties(userParams, sysUser);
    if (userParams.getPassword() != null) {
        sysUser.setPassword(Md5Util.encrypt(userParams.getPassword()));
    }
    return sysUserMapper.updateByPrimaryKeySelective(sysUser);
}
```

根据id更新用户信息

### 2.2 商品管理模块

#### 2.2.1 商品资源管理接口

##### 0. 商品domain

**商品参数**

```java
@Data
public class ProductParams {
    
    @NotBlank
    private String productName;//商品名
    
    @NotBlank
    private String productDesc;//商品描述

    private String productAttr;//商品属性

    private List<ProductImageParams> productImages;//商品图片

    @NotNull
    private BigDecimal originalPrice;//原始价格

    @NotNull
    private BigDecimal currentPrice;//当前价格

    @NotNull
    private Integer stock;//库存量

    private Long merchantId;//机构id

    @NotNull
    private Long productCategoryId;//商品分类id

    private BigDecimal freight;//运费
}
```

**商品搜索参数**

```java
@Data
public class ProductSearchParams {
    private Long merchantId;

    /**
     * 商家名称
     */
    private String merchantName;

    /**
     * 商品描述
     */
    private Integer verifyStatus;

    /**
     * 商品分类id
     */
    private Long productCategoryId;


    /**
     * 商品状态 0->下架 1->上架
     */
    private Integer status;

    /**
     * 商品名称
     */
    private String productName;
}
```

##### 1. 添加商品接口

```java
@ApiOperation("添加商品")
@PostMapping(value="/addOneProduct")
public CommonResult addOneProduct(@Valid @RequestBody ProductParams productParams){
    int result = productService.insertOneProduct(productParams);
    if (result >= 0) {
        return CommonResult.success("添加商品成功");
    }
    return CommonResult.failed("商品添加失败");
}
```

**服务层**

```java
@Transactional(rollbackFor = Exception.class)
@Override
public Integer insertOneProduct(ProductParams productParams) {
    Product product = new Product();
    BeanUtils.copyProperties(productParams,product);
    product.setVerifyStatus(ProductVerifyStatusEnum.PRODUCT_IN_REVIEW.getCode());
    product.setStatus(ProductStatusEnum.PRODUCT_ON_SALE.getCode());
    product.setMerchantId(ShiroUtil.getMerchantId());
    productMapper.insertSelective(product);
    return batchInsertProductImageList(productParams.getProductImages(), product.getId());
}
```

通过当前登录的用户的机构id来确定商品的机构id

##### 2. 更新商品接口

```java
@ApiOperation("更新商品")
@PostMapping(value="/updateOneProduct")
public CommonResult updateOneProduct(@NotNull @RequestParam Long productId,
                                     @Valid @RequestBody ProductParams productParams){
    int result = productService.updateOneProduct(productId, productParams);
    if (result >= 0 ) {
        return CommonResult.success("更新商品成功");
    }
    return CommonResult.failed("更新商品失败");
}
```

**服务层**

```java
@Transactional(rollbackFor = Exception.class)
@Override
public Integer updateOneProduct(Long productId, ProductParams productParams) {
    ProductImageExample productImageExample = new ProductImageExample();
    productImageExample.createCriteria().andProductIdEqualTo(productId);
    productImageMapper.deleteByExample(productImageExample);
    Product product = new Product();
    BeanUtils.copyProperties(productParams, product);
    product.setId(productId);
    product.setUpdateTime(new Date());
    productMapper.updateByPrimaryKeySelective(product);
    return batchInsertProductImageList(productParams.getProductImages(), product.getId());
}
```

更新商品时由于需要更新多个图片，并且不是一一对应的，所以需要先进行批量删除再批量插入

**批量插入商品图片**

```java
/**
 * 批量插入商品图片
 * @param productImageList 商品图片类的参数
 * @param productId 商品id
 * @return 插入了多少条
 */
private Integer batchInsertProductImageList(List<ProductImageParams> productImageList, Long productId) {
    if (CollectionUtils.isNotEmpty(productImageList)) {
        for (int i = 0; i < productImageList.size(); i++) {
            if (i == 0) {
                productImageList.get(i).setIsMain(1);
            } else {
                productImageList.get(i).setIsMain(0);
            }
            productImageList.get(i).setProductId(productId);
        }
        return productImageCustomMapper.batchInsert(productImageList);
    }
    return 0;
}
```

设第一个图片为主图

##### 3. 查询商品id查询商品接口

```java
@ApiOperation("查询商品详情")
@GetMapping(value="/getProductDetailVoByProductId")
public CommonResult getProductDetailVoByProductId(@NotNull @RequestParam Long productId){
    ProductVo productVo = productService.getProductDetailVoByProductId(productId);
    if (productVo != null) {
        return CommonResult.success(productVo,"获取商品详情成功");
    }
    return CommonResult.failed("获取商品详情失败");
}
```

**服务层**

```java
@Override
public ProductVo getProductDetailVoByProductId(Long productId) {
    return productCustomMapper.getProductDetailVoByProductId(productId);
}
```

##### 4. 根据分类id查询商品

```java
@ApiOperation("根据商品分类id获取商品页面")
@GetMapping(value="/listProductVosByCategoryId")
public CommonResult listProductVosByCategoryId(@NotNull @RequestParam Long categoryId,
                                               @RequestParam(value="pageNum",defaultValue = "1") Integer pageNum,
                                               @RequestParam(value="size",defaultValue ="10") Integer size){
    CommonPage<ProductVo> productVoPage = productService.listProductVosByCategoryId(categoryId, pageNum, size);
    if (productVoPage != null) {
        return CommonResult.success(productVoPage,"获取商品页面成功");
    }
    return CommonResult.failed("获取商品页面失败");
}
```

**服务层**

```java
@Override
public CommonPage<ProductVo> listProductVosByCategoryId(Long categoryId, Integer pageNum, Integer size) {
    PageHelper.startPage(pageNum, size);
    List<ProductVo> productVoList = productCustomMapper.listProductVosByCategoryId(categoryId);
    return CommonPage.restPage(productVoList);
}
```

##### 5. 商家获取自家商品

```java
@ApiOperation("商家获取自家全部商品")
@GetMapping(value="/listMerchantOwnProductVos")
public CommonResult listMerchantOwnProductVos(@RequestParam(value="pageNum",defaultValue = "1") Integer pageNum,
                                              @RequestParam(value="size",defaultValue ="10") Integer size){
    CommonPage<ProductVo> productVoPage = productService.listMerchantOwnProductVos(pageNum, size);
    if (productVoPage != null) {
        return CommonResult.success(productVoPage,"获取商品页面成功");
    }
    return CommonResult.failed("获取商品列表失败");
}
```

**服务层**

```java
@Override
public CommonPage<ProductVo> listMerchantOwnProductVos(Integer pageNum, Integer size) {
    PageHelper.startPage(pageNum, size);
    List<ProductVo> productVoList = productCustomMapper.listProductVos(ShiroUtil.getMerchantId());
    return CommonPage.restPage(productVoList);
}
```

##### 6. 根据条件筛选商品

```java
@ApiOperation("根据条件获取商品列表")
@PostMapping(value = "listProductVosByCondition")
public CommonResult listProductVosByCondition(@RequestParam(value="pageNum",defaultValue = "1") Integer pageNum,
                                              @RequestParam(value="size",defaultValue ="10") Integer size,
                                              @RequestBody ProductSearchParams productSearchParams) {
    CommonPage<ProductVo> productVoPage = productService.listProductVosByCondition(productSearchParams, pageNum, size);
    if (productVoPage != null) {
        return CommonResult.success(productVoPage, "获取商品页面页面成功");
    }
    return CommonResult.failed("获取商品列表失败");
}
```

**服务层**

```java
@Override
public CommonPage<ProductVo> listProductVosByCondition(ProductSearchParams productSearchParams, Integer pageNum, Integer size) {
    PageHelper.startPage(pageNum, size);
    if (ShiroUtil.getAdminType().equals(UserRoleEnum.MERCHANT_ADMIN.getCode())) {
        productSearchParams.setMerchantId(ShiroUtil.getMerchantId());
    }
    List<ProductVo> productVoList = productCustomMapper.listProductVosByCondition(productSearchParams);
    return CommonPage.restPage(productVoList);
}
```

除了前端传进的参数，还要根据当前用户获取机构id

##### 7. 更新商品状态

```java
@ApiOperation("更新商品状态")
@PostMapping(value="/updateOneProductStatus")
public CommonResult updateOneProductStatus(@NotNull @RequestParam Long productId, @NotNull @RequestParam Integer status){
    int result = productService.setProductStatus(productId, status);
    if (result >=0 ) {
        return CommonResult.success("更新商品状态成功");
    }
    return CommonResult.failed("更新商品状态失败");
}
```

**服务层**

```java
@Override
public Integer setProductStatus(Long productId, Integer status) {
    Product product = new Product();
    product.setId(productId);
    product.setStatus(status);
    return productMapper.updateByPrimaryKeySelective(product);
}
```

##### 8. 更新商品审核状态

```java
@ApiOperation("更新商品审核状态")
@PostMapping(value = "/updateOneProductVerifyStatus")
public CommonResult updateOneProductVerifyStatus(@NotNull @RequestParam Long productId,
                                                 @NotNull @RequestParam Integer status) {
    int result = productService.setProductVerifyStatus(productId, status);
    if (result >= 0) {
        return CommonResult.success("更新商品审核状态成功");
    }
    return CommonResult.failed("更新商品审核状态失败");
}
```

**服务层**

```java
@Override
public Integer setProductVerifyStatus(Long productId, Integer status) {
    Product product = new Product();
    product.setId(productId);
    product.setVerifyStatus(status);
    return productMapper.updateByPrimaryKeySelective(product);
}
```

##### 9. 删除商品

```java
@ApiOperation("删除商品")
@PostMapping(value="/deleteOneProduct")
public CommonResult deleteOneProduct(@NotNull @RequestParam Long productId){
    int result = productService.deleteOneProduct(productId);
    if (result >=0 ) {
        return CommonResult.success("删除商品成功");
    }
    return CommonResult.failed("删除商品失败");
}
```

**服务层**

```java
@Override
public Integer deleteOneProduct(Long productId) {
    Product product = new Product();
    product.setId(productId);
    product.setIsDeleted(1);
    return productMapper.updateByPrimaryKeySelective(product);
}
```

并不真正删除，而是将删除状态设为1

##### 10. 为商品绑定团购规则

```java
@ApiOperation("为商品绑定团购规则")
@PostMapping(value = "assignGroupBuyRuleToProduct")
public CommonResult assignGroupBuyRuleToProduct(@NotNull @RequestBody GroupBuyRuleParams groupBuyRuleParams) {
    int result = productService.assignGroupBuyRuleToProduct(groupBuyRuleParams);
    if (result >=0 ) {
        return CommonResult.success("为商品绑定规则成功");
    }
    return CommonResult.failed("为商品绑定规则失败");
}
```

**服务层**

```java
@Override
public Integer assignGroupBuyRuleToProduct(GroupBuyRuleParams groupBuyRuleParams) {
    Product product = productMapper.selectByPrimaryKey(groupBuyRuleParams.getProductId());
    BigDecimal discountRate = groupBuyRuleParams.getGroupBuyPrice().divide(product.getCurrentPrice(), 2, RoundingMode.HALF_UP);
    GroupBuyRule groupBuyRule = new GroupBuyRule();
    BeanUtil.copyProperties(groupBuyRuleParams, groupBuyRule);
    groupBuyRule.setDiscountRate(discountRate);
    groupBuyRule.setSuccessGroupNumber(0);
    groupBuyRule.setStatus(SysStatusEnum.AVAILABLE.getCode());
    return groupBuyRuleMapper.insertSelective(groupBuyRule);
}
```

折扣率通过计算团购价/商品当前价格得到，价格需要使用BigDecimal做精确的计算

使用方法：BigDecimal.divide(除数, 保留位数, 舍入方法)

这里是保留两位小数，使用”四舍五入“

#### 2.2.2 商品分类管理接口

##### 0. 商品分类domain

**商品分类参数**

```java
@Data
public class ProductCategoryParams {
    private Long id;

    /**
     * 分类名称
     */
    @NotBlank
    private String name;

    /**
     * 分类等级 1->2->3
     */
    @NotNull
    private Integer level;

    /**
     * 分类描述
     */
    @NotBlank
    private String description;

    /**
     * 分类上级id
     */
    @NotNull
    private Long parentId;

    /**
     * 排序
     */
    private Integer sort;

    /**
     * 是否显示在导航栏
     */
    private Integer navStatus;

    /**
     * 图标
     */
    private String icon;
}
```

##### 1. 添加商品分类接口

```java
@ApiOperation("添加商品分类")
@PostMapping(value="/addOneProductCategory")
public CommonResult addOneProductCategory(@Valid @RequestBody ProductCategoryParams productCategoryParams){
    int result = productCategoryService.insertOneProductCategory(productCategoryParams);
    if (result >= 0) {
        return CommonResult.success("添加商品分类成功");
    }
    return CommonResult.failed("商品分类添加失败");
}
```

**服务层**

```java
@Override
public Integer insertOneProductCategory(ProductCategoryParams productCategoryParams) {
    ProductCategory productCategory = new ProductCategory();
    BeanUtils.copyProperties(productCategoryParams, productCategory);
    productCategory.setStatus(SysStatusEnum.AVAILABLE.getCode());
    return productCategoryMapper.insertSelective(productCategory);
}
```

##### 2. 更新商品分类

```java
@ApiOperation("更新商品分类")
@PostMapping(value="/updateOneProductCategory")
public CommonResult updateOneProductCategory(@Valid @RequestBody ProductCategoryParams productCategoryParams){
    int result = productCategoryService.updateOneProductCategory(productCategoryParams);
    if (result >= 0) {
        return CommonResult.success("更新商品分类成功");
    }
    return CommonResult.failed("商品分类更新失败");
}
```

**服务层**

```java
@Override
public Integer updateOneProductCategory(ProductCategoryParams productCategoryParams) {
    ProductCategory productCategory = new ProductCategory();
    BeanUtils.copyProperties(productCategory, productCategoryParams);
    productCategory.setUpdateTime(new Date());
    return productCategoryMapper.updateByPrimaryKeySelective(productCategory);
}
```

##### 3. 获取商品分类

```java
@ApiOperation("获取商品分类")
@GetMapping(value="/listProductCategoryVos")
public CommonResult listProductCategoryVos(){

    List<ProductCategoryVo> productCategoryVoList = productCategoryService.listProductCategoryVos();
    if (productCategoryVoList != null) {
        return CommonResult.success(productCategoryVoList,"获取商品分类成功");
    }
    return CommonResult.failed("获取商品分类失败");
}
```

**服务层**

```java
@Override
public List<ProductCategoryVo> listProductCategoryVos() {
    List<ProductCategory> productCategoryList = productCategoryMapper.selectByExample(new ProductCategoryExample());
    return transform2TreeProductCategoryVo(productCategoryList);
}
```

获取所有分类并且转换为树形结构展示

**树形结构转换方法**

```java
/**
 * 将分类树形化展示
 * @param productCategoryList
 * @return
 */
private List<ProductCategoryVo> transform2TreeProductCategoryVo(List<ProductCategory> productCategoryList){
       List<ProductCategoryVo> productCategoryVoList=productCategoryList.stream().filter(productCategory ->productCategory.getParentId().equals(0L))
               .map(productCategory -> covert(productCategory,productCategoryList))
               .collect(Collectors.toList());
       return productCategoryVoList;
}


/**
 * 从数据库转换成展示层
 * @param productCategory
 * @return
 */
private ProductCategoryVo trans2Vo(ProductCategory productCategory){
    ProductCategoryVo productCategoryVo = new ProductCategoryVo();
    BeanUtils.copyProperties(productCategory,productCategoryVo);
    return productCategoryVo;
}

private ProductCategoryVo covert(ProductCategory parentNode, List<ProductCategory> productCategoryList){
    ProductCategoryVo parentNodeVo = trans2Vo(parentNode);
    List<ProductCategoryVo> subProductCategoryVos=productCategoryList.stream().filter(subNode->subNode.getParentId().equals(parentNodeVo.getId()))
            .map(subNode->covert(subNode,productCategoryList))
            .sorted(Comparator.comparing(ProductCategory::getSort))
            .collect(Collectors.toList());
    parentNodeVo.setSubProductCategoryVos(subProductCategoryVos);
    return parentNodeVo;
}
```

### 2.3 团购规则模块

#### 2.3.1 团购规则管理接口

##### 0. 团购规则domain

**团购规则参数**

```java
@Data
public class GroupBuyRuleParams {

    /**
     * 团购分类id
     */
    @NotNull
    private Long categoryId;

    /**
     * 团购规则名称
     */
    @NotBlank
    private String ruleName;

    /**
     * 商品id
     */
    @NotNull
    private Long productId;

    /**
     * 折扣比例
     */
    @NotNull
    private BigDecimal discountRate;

    /**
     * 团购优惠价
     */
    @NotNull
    private BigDecimal groupBuyPrice;

    /**
     * 限购数量
     */
    @NotNull
    private Integer limitNumber;

    /**
     * 成功开团的人数要求
     */
    @NotNull
    private Integer successPeopleNumber;


    /**
     * 未满足人数是否开团
     */
    @NotNull
    private Integer overtimeClustering;

    /**
     * 备注
     */
    private String remark;

    /**
     * 开团时间
     */
    @NotNull
    @DateTimeFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
    private Date startTime;

    /**
     * 结束时间
     */
    @NotNull
    @DateTimeFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
    private Date endTime;

    /**
     * 成团有效时间
     */
    @NotNull
    private Integer validTime;
}
```

**团购分类参数**

```java
@Data
public class GroupBuyCategoryParams {
    private Long id;

    /**
     * 分类名称
     */
    @NotBlank
    private String name;

    /**
     * 团购分类描述
     */
    @NotBlank
    private String description;

    /**
     * 排序
     */
    @NotNull
    private Integer sort;

    /**
     * 分类Logo
     */
    private String logo;


}
```

##### 1. 添加团购分类

```java
@ApiOperation("添加团购分类")
@PostMapping(value = "/addOneGroupBuyCategory")
public CommonResult addOneGroupBuyCategory(@Valid @RequestBody GroupBuyCategoryParams groupBuyCategoryParams){
    int result = groupBuyService.insertOneGroupBuyCategory(groupBuyCategoryParams);
    if (result <= 0) {
        return CommonResult.failed("添加团购分类失败");
    }
    return CommonResult.success("添加团购分类成功");
}
```

**服务层**

```java
@Override
public Integer insertOneGroupBuyCategory(GroupBuyCategoryParams groupBuyCategoryParams) {
    GroupBuyCategory groupBuyCategory = new GroupBuyCategory();
    BeanUtils.copyProperties(groupBuyCategoryParams,groupBuyCategory);
    groupBuyCategory.setStatus(SysStatusEnum.NOT_AVAILABLE.getCode());
    return groupBuyCategoryMapper.insertSelective(groupBuyCategory);
}
```

添加并且状态设为禁用

##### 2. 更新团购分类

```java
@ApiOperation("更新团购分类")
@PostMapping(value = "/updateOneGroupBuyCategory")
public CommonResult updateOneGroupBuyCategory(@Valid @RequestBody GroupBuyCategoryParams groupBuyCategoryParams){
    int result = groupBuyService.updateOneGroupBuyCategory(groupBuyCategoryParams);
    if (result <= 0) {
        return CommonResult.failed("更新团购分类失败");
    }
    return CommonResult.success("更新团购分类成功");
}
```

**服务层**

```java
@Override
public Integer updateOneGroupBuyCategory(GroupBuyCategoryParams groupBuyCategoryParams) {
    GroupBuyCategory groupBuyCategory = new GroupBuyCategory();
    BeanUtils.copyProperties(groupBuyCategoryParams,groupBuyCategory);
    groupBuyCategory.setUpdateTime(new Date());
    return groupBuyCategoryMapper.updateByPrimaryKeySelective(groupBuyCategory);
}
```

##### 3. 更新分类状态

```java
@ApiOperation("更新团购分类状态")
@PostMapping(value = "/updateOneGroupBuyCategoryStatus")
public CommonResult updateOneGroupBuyCategoryStatus(@NotNull @RequestParam Long categoryId, @NotNull @RequestParam Integer status) {
    int result = groupBuyService.updateOneGroupBuyCategoryStatus(categoryId, status);
    if (result <= 0) {
        return CommonResult.failed("更新团购分类状态失败");
    }
    return CommonResult.success("更新团购分类状态成功");
}
```

**服务层**

```java
@Override
public Integer updateOneGroupBuyCategoryStatus(Long categoryId, Integer status) {
    GroupBuyCategory groupBuyCategory = new GroupBuyCategory();
    groupBuyCategory.setId(categoryId);
    groupBuyCategory.setStatus(status);
    return groupBuyCategoryMapper.updateByPrimaryKeySelective(groupBuyCategory);
}
```

##### 4. 删除团购分类

```java
@ApiOperation("删除团购分类")
@PostMapping(value = "/deleteOneGroupBuyCategory")
public CommonResult deleteOneGroupBuyCategory(@NotNull @RequestParam Long categoryId){
    int result = groupBuyService.deleteOneGroupBuyCategory(categoryId);
    if (result <= 0) {
        return CommonResult.failed("删除团购分类失败");
    }
    return CommonResult.success("删除团购分类成功");
}
```

**服务层**

```java
@Override
public Integer deleteOneGroupBuyCategory(Long categoryId) {
    GroupBuyCategory groupBuyCategory = new GroupBuyCategory();
    groupBuyCategory.setId(categoryId);
    groupBuyCategory.setIsDeleted(1);
    return groupBuyCategoryMapper.updateByPrimaryKeySelective(groupBuyCategory);
}
```

不真正删除而是设置删除标志

##### 5. 获取所有团购分类

```java
@ApiOperation("获取所有团购分类")
@PostMapping(value = "/listGroupBuyCategoryVos")
public CommonResult listGroupBuyCategoryVos( @RequestParam(value="pageNum",defaultValue = "1") Integer pageNum,
                                             @RequestParam(value="size",defaultValue ="10") Integer size){
    CommonPage<GroupBuyCategoryVo> groupBuyCategoryVos = groupBuyService.listGroupBuyCategoryVos(pageNum, size);
    if (groupBuyCategoryVos == null) {
        return CommonResult.failed("获取团购分类失败或者分类不存在");
    }
    return CommonResult.success(groupBuyCategoryVos,"获取团购分类成功");
}
```

**服务层**

```java
@Override
public CommonPage<GroupBuyCategoryVo> listGroupBuyCategoryVos(Integer pageNum, Integer size) {
    PageHelper.startPage(pageNum, size);
    GroupBuyCategoryExample groupBuyCategoryExample = new GroupBuyCategoryExample();
    groupBuyCategoryExample.createCriteria().andIsDeletedEqualTo(0);
    List<GroupBuyCategory> groupBuyCategoryList = groupBuyCategoryMapper.selectByExample(groupBuyCategoryExample);
    List<GroupBuyCategoryVo> groupBuyCategoryVoList = groupBuyCategoryList.stream().map(this::transCategory2Vo).collect(Collectors.toList());
    return CommonPage.restPage(groupBuyCategoryVoList);
}
```

##### 6. 添加团购规则

```java
@ApiOperation("添加团购规则")
@PostMapping(value = "/addOneGroupBuyRule")
public CommonResult addOneGroupBuyRule(@Valid @RequestBody GroupBuyRuleParams groupBuyRuleParams){
    int result = groupBuyService.insertOneGroupBuyRule(groupBuyRuleParams);
    if (result <= 0) {
        return CommonResult.failed("添加团购规则失败");
    }
    return CommonResult.success("添加团购规则成功");
}
```

**服务层**

```java
@Override
public Integer insertOneGroupBuyRule(GroupBuyRuleParams groupBuyRuleParams) {
    GroupBuyRule groupBuyRule = new GroupBuyRule();
    BeanUtils.copyProperties(groupBuyRuleParams,groupBuyRule);
    groupBuyRule.setSuccessGroupNumber(0);
    groupBuyRule.setStatus(SysStatusEnum.NOT_AVAILABLE.getCode());
    return groupBuyRuleMapper.insertSelective(groupBuyRule);
}
```

##### 7. 更新团购规则

```java
@ApiOperation("更新团购规则")
@PostMapping(value = "/updateOneGroupBuyRule")
public CommonResult updateOneGroupBuyRule(@RequestParam Long ruleId, @Valid @RequestBody GroupBuyRuleParams groupBuyRuleParams){
    int result = groupBuyService.updateOneGroupBuyRule(ruleId, groupBuyRuleParams);
    if (result <= 0) {
        return CommonResult.failed("更新团购规则失败");
    }
    return CommonResult.success("更新团购规则成功");
}
```

**服务层**

```java
@Override
public Integer updateOneGroupBuyRule(Long ruleId, GroupBuyRuleParams groupBuyRuleParams) {
    GroupBuyRule groupBuyRule = new GroupBuyRule();
    BeanUtils.copyProperties(groupBuyRuleParams,groupBuyRule);
    groupBuyRule.setId(ruleId);
    return groupBuyRuleMapper.updateByPrimaryKeySelective(groupBuyRule);
}
```

##### 8. 更新团购规则状态

```java
@ApiOperation("更新团购规则状态")
@PostMapping(value = "/updateOneGroupBuyRuleStatus")
public CommonResult updateOneGroupBuyRuleStatus(@NotNull @RequestParam Long ruleId, @NotNull @RequestParam Integer status){
    int result = groupBuyService.updateOneGroupBuyRuleStatus(ruleId, status);
    if (result <= 0) {
        return CommonResult.failed("更新团购规则状态失败");
    }
    return CommonResult.success("更新团购规则状态成功");
}
```

**服务层**

```java
@Override
public Integer updateOneGroupBuyRuleStatus(Long ruleId, Integer status) {
    GroupBuyRule groupBuyRule = new GroupBuyRule();
    groupBuyRule.setId(ruleId);
    groupBuyRule.setStatus(status);
    return groupBuyRuleMapper.updateByPrimaryKeySelective(groupBuyRule);
}
```

根据规则id更新

##### 9. 根据分类获取团购规则

```java
@ApiOperation("根据团购分类id获取团购规则")
@GetMapping("/listGroupBuyRuleByGroupBuyCategoryId")
public CommonResult listGroupBuyRuleByGroupBuyCategoryId(@RequestParam(value = "pageNum", defaultValue = "1") Integer pageNum,
                                                         @RequestParam(value = "size", defaultValue = "10") Integer size,
                                                         @RequestParam Long categoryId,
                                                         @RequestParam(required = false) Long merchantId) {
    CommonPage<GroupBuyRuleVo> groupBuyRuleVos = groupBuyService.listGroupBuyRuleByGroupBuyCategoryId(categoryId, merchantId, pageNum, size);
    if (groupBuyRuleVos != null) {
        return CommonResult.success(groupBuyRuleVos, "获取团购规则成功");
    }
    return CommonResult.failed("获取团购规则失败");
}
```

**服务层**

```java
@Override
public CommonPage<GroupBuyRuleVo> listGroupBuyRuleByGroupBuyCategoryId(Long categoryId, Long merchantId, Integer pageNum, Integer size) {
    PageHelper.startPage(pageNum, size);
    Long currentMerchantId = merchantId == null ? ShiroUtil.getMerchantId() : merchantId;
    List<GroupBuyRuleVo> groupBuyRuleVoList = groupBuyRuleCustomMapper.listGroupBuyRuleVoByGroupBuyCategoryId(categoryId, currentMerchantId);
    return CommonPage.restPage(groupBuyRuleVoList);
}
```

##### 10. 删除团购规则

```java
@ApiOperation("删除一个团购规则")
@PostMapping("/deleteOneGroupBuyRule")
public CommonResult deleteOneGroupBuyRule(@RequestParam Long ruleId) {
    int result = groupBuyService.deleteOneGroupBuyRule(ruleId);
    if (result >= 0) {
        return CommonResult.success("删除团购规则成功");
    }
    return CommonResult.failed("删除团购规则失败");
}
```

**服务层**

```java
@Override
public Integer deleteOneGroupBuyRule(Long ruleId) {
    GroupBuyRule groupBuyRule = new GroupBuyRule();
    groupBuyRule.setId(ruleId);
    groupBuyRule.setIsDeleted(1);
    return groupBuyRuleMapper.updateByPrimaryKeySelective(groupBuyRule);
}
```

### 2.4 团购订单模块

#### 2.4.1 团购订单管理模块

##### 1. 条件筛选订单接口

```java
@ApiOperation(value = "根据条件获取订单列表")
@PostMapping("/listGroupBuyOrderByCondition")
public CommonResult listGroupBuyOrderByCondition(@RequestParam(value = "pageNum", defaultValue = "1") Integer pageNum,
                                                 @RequestParam(value = "size",defaultValue = "10") Integer size,
                                                 @RequestBody GroupBuyOrderSearchParams groupBuyOrderSearchParams) {
    CommonPage<GroupBuyOrderVo> groupBuyOrderVoCommonPage = groupBuyOrderService.listGroupBuyOrderByCondition(groupBuyOrderSearchParams, pageNum, size);
    if (groupBuyOrderVoCommonPage != null) {
        return CommonResult.success(groupBuyOrderVoCommonPage, "获取订单列表成功");
    }
    return CommonResult.failed("获取订单列表失败");
}
```

**服务层**

```java
@Override
public CommonPage<GroupBuyOrderVo> listGroupBuyOrderByCondition(GroupBuyOrderSearchParams groupBuyOrderSearchParams, Integer pageNum, Integer size) {
    PageHelper.startPage(pageNum, size);
    if (ShiroUtil.getAdminType().equals(UserRoleEnum.MERCHANT_ADMIN.getCode())) {
        groupBuyOrderSearchParams.setMerchantId(ShiroUtil.getMerchantId());
    }
    List<GroupBuyOrderVo> groupBuyOrderVoList = groupBuyOrderCustomMapper.listGroupBuyOrderByCondition(groupBuyOrderSearchParams);
    return CommonPage.restPage(groupBuyOrderVoList);
}
```

如果用户类型是商家管理员，应该限定范围为该商家的订单

##### 2. 查看订单详情

```java
@ApiOperation(value = "根据团购订单id获取订单详情")
@GetMapping("/getGroupBuyOrderDetailByGroupBuyOrderId")
public CommonResult getGroupBuyOrderDetailByGroupBuyOrderId(@RequestParam Long groupBuyOrderId) {
    GroupBuyOrderDetailVo groupBuyOrderDetailVo = groupBuyOrderService.getGroupBuyOrderDetailByGroupBuyOrderId(groupBuyOrderId);
    if (groupBuyOrderDetailVo != null) {
        return CommonResult.success(groupBuyOrderDetailVo, "根据订单id获取订单详情成功");
    }
    return CommonResult.failed("根据订单id获取订单详情失败");
}
```

**服务层**

```java
@Override
public GroupBuyOrderDetailVo getGroupBuyOrderDetailByGroupBuyOrderId(Long groupBuyOrderId) {
    return groupBuyOrderCustomMapper.getGroupBuyOrderDetailByGroupBuyOrderId(groupBuyOrderId);
}
```

##### 3. 团购订单发货

```java
@ApiOperation(value = "团购订单发货")
@PostMapping("/groupBuyOrderConsign")
public CommonResult groupBuyOrderConsign(@RequestParam Long orderId,
                                         @RequestParam Integer logisticsPlatform,
                                         @RequestParam String logisticsNumber) {
    int result = groupBuyOrderService.groupBuyOrderConsign(orderId, logisticsPlatform, logisticsNumber);
    if (result >= 0) {
        return CommonResult.success("团购订单发货成功");
    }
    return CommonResult.failed("团购订单发货失败");
}
```

**服务层**

```java
@Override
public Integer groupBuyOrderConsign(Long orderId, Integer logisticsPlatform, String logisticsNumber) {
    GroupBuyOrder groupBuyOrder = new GroupBuyOrder();
    groupBuyOrder.setId(orderId);
    groupBuyOrder.setLogisticsPlatform(logisticsPlatform);
    groupBuyOrder.setLogisticsNumber(logisticsNumber);
    groupBuyOrder.setOrderStatus(OrderStatusEnum.SHIPPED.getCode());
    return groupBuyOrderMapper.updateByPrimaryKeySelective(groupBuyOrder);
}
```

根据订单id更新数据库中订单的订单状态、物流平台、物流单号信息

##### 4. 删除订单

```java
@ApiOperation(value = "删除一个订单")
@PostMapping("/deleteOneGroupBuyOrder")
public CommonResult deleteOneGroupBuyOrder(@RequestParam Long orderId) {
    int result = groupBuyOrderService.deleteOneGroupBuyOrder(orderId);
    if (result >= 0) {
        return CommonResult.success("团购订单删除成功");
    }
    return CommonResult.failed("团购订单删除失败");
}
```

**服务层**

```java
@Override
public Integer deleteOneGroupBuyOrder(Long orderId) {
    GroupBuyOrder groupBuyOrder = new GroupBuyOrder();
    groupBuyOrder.setIsDeleted(1);
    groupBuyOrder.setId(orderId);
    return groupBuyOrderMapper.updateByPrimaryKeySelective(groupBuyOrder);
}
```

### 2.5 机构管理模块

#### 2.5.1 机构控制器

##### 0. 机构domain

```java
@Data
public class InstitutionParams {
    private Long id;

    /**
     * 邮政编码
     */
    private String areaCode;

    /**
     * 地址
     */
    @NotBlank
    private String address;

    /**
     * logo图片地址
     */
    private String logo;

    /**
     * 联系方式
     */
    @NotBlank
    private String contact;

    /**
     * 商家描述
     */
    private String description;

    /**
     * 备注
     */
    private String remark;

    /**
     * 入驻商家名称
     */
    @NotBlank
    private String institutionName;

}
```

##### 1. 添加机构

```java
@ApiOperation("添加机构")
@PostMapping(value = "/addOneInstitution")
public CommonResult addOneInstitution(@Valid @RequestBody InstitutionParams institutionParams){
    int result = iInstitutionService.insertOneInstitution(institutionParams);
    if (result <= 0) {
        return CommonResult.failed("添加机构失败");
    }
    return CommonResult.success("添加机构成功");
}
```

**服务层**

```java
@Override
public int insertOneInstitution(InstitutionParams institutionParams) {
    Institution institution=new Institution();
    BeanUtil.copyProperties(institutionParams, institution);
    institution.setStatus(SysStatusEnum.AVAILABLE.getCode());
    return institutionMapper.insertSelective(institution);
}
```

机构状态设为“正常”后插入数据库

##### 2. 为机构指定管理员

```Java
@ApiOperation("为机构指定管理员")
@PostMapping(value = "/assignAdminToInstitution")
public CommonResult assignAdminToInstitution(HttpServletRequest httpServletRequest,
                                             @RequestParam Long institutionId,
                                             @Valid @RequestBody UserParams userParams){
    int result = iInstitutionService.assignAdmin2Institution(institutionId, IpUtil.getIpAddr(httpServletRequest), userParams);
    if (result <= 0) {
        return CommonResult.failed("指定管理员失败");
    }
    return CommonResult.success("指定管理员成功");
}
```

**服务层**

```java
@Override
public int assignAdmin2Institution(Long institutionId, String regIp, UserParams userParams) {
    //前提是调用这个方法传递的userType是商户管理员（1 要和前面区分开来
    SysUser sysUser=sysUserService.insertOneUser(regIp, userParams);
    InstitutionSysUser institutionSysUser = new InstitutionSysUser();
    institutionSysUser.setInstitutionId(institutionId);
    institutionSysUser.setSysUserId(sysUser.getId());
    return institutionSysUserMapper.insertSelective(institutionSysUser);
}
```

将管理员信息插入用户表中，分配信息插入关联表中

##### 3. 更新机构信息

```java
@ApiOperation("更新机构信息")
@PostMapping(value = "/updateOneInstitution")
public CommonResult updateOneInstitution(@Valid @RequestBody InstitutionParams institutionParams){
    int result = iInstitutionService.updateOneInstitution(institutionParams);
    if (result <= 0) {
        return CommonResult.failed("更新机构信息失败");
    }
    return CommonResult.success("更新机构信息成功");
}
```

**服务层**

```java
@Override
public int updateOneInstitution(InstitutionParams institutionParams) {
    Institution institution = new Institution();
    BeanUtil.copyProperties(institutionParams, institution);
    return institutionMapper.updateByPrimaryKeySelective(institution);
}
```

##### 4. 获取机构管理员信息

```java
@ApiOperation("获取机构管理员信息")
@GetMapping(value = "/getAdminInfoByInstitutionId")
public CommonResult getAdminInfoByInstitutionId(@NotNull @RequestParam Long institutionId){
    List<UserVo> userVoList = iInstitutionService.listUserVosByInstitutionId(institutionId);
    if (userVoList != null) {
        return CommonResult.success(userVoList,"查询管理员成功");
    }
    return CommonResult.failed("暂无管理员信息,需要进行分配");
}
```

**服务层**

```java
@Override
public List<UserVo> listUserVosByInstitutionId(Long institutionId) {
    return userCustomMapper.listUserVosByInstitutionId(institutionId);
}
```

##### 5. 获取机构列表

```java
@ApiOperation("获取机构列表")
@GetMapping(value = "/listInstitutionVo")
public CommonResult listInstitutionVo(@RequestParam(value="pageNum",defaultValue = "1") Integer pageNum,
                                      @RequestParam(value="size",defaultValue ="10") Integer size){
    CommonPage<Institution> institutionVoPage = iInstitutionService.listInstitutionVos(pageNum, size);
    if (institutionVoPage != null) {
        return CommonResult.success(institutionVoPage,"获取机构列表成功");
    }
    return CommonResult.failed("获取机构列表失败");
}
```

**服务层**

```java
@Override
public CommonPage<Institution> listInstitutionVos(Integer pageNum, Integer size) {
    PageHelper.startPage(pageNum,size);
    //todo 这里以后会转换成institutionVo,但目前还不知道需要哪些数据，所以直接从数据库查
    List<Institution> institutionList = institutionMapper.selectByExample(new InstitutionExample());
    return CommonPage.restPage(institutionList);
}
```

### 2.6 商家管理模块

#### 2.6.1 商家管理器

##### 0. 商家domain

**商家参数**

```java
@Data
public class MerchantParams {

    /**
     * 商家名
     */
    @NotNull(message = "商家名不能为空")
    private String merchantName;

    /**
     * 商家Logo
     */
    private String merchantLogo;

    /**
     * 商家简介
     */
    private String merchantIntroduction;

    /**
     * 商家地址
     */
    private String merchantAddress;

    /**
     * 商家联系方式
     */
    @NotNull(message = "商家联系方式不能为空")
    private String merchantContact;

    /**
     * 法人代表
     */
    @NotNull(message = "法人代表不能为空")
    private String legalPerson;

    /**
     * 商家证书
     */
    private String merchantCertificate;

    /**
     * 商家微信账号
     */
    private String merchantWxpayAccount;

    /**
     * 商家支付宝账号
     */
    private String merchantAlipayAccount;

    /**
     * 收款流向
     */
    private Integer proceedsFlowDirection;

    /**
     * 商家支付key
     */
    private String companyKey;

    /**
     * 备注
     */
    private String remark;
}
```

**商家搜索参数**

```java
@Data
public class MerchantSearchParams {
    /**
     * 商家id 商家id
     */
    private Long id;

    /**
     * 商家名 商家名
     */
    private String merchantName;

    /**
     * 商家地址 商家地址
     */
    private String merchantAddress;

    /**
     * 商家联系方式 商家联系方式
     */
    private String merchantContact;

    /**
     * 法人代表 法人代表
     */
    private String legalPerson;

    /**
     * 商家微信账号 商家微信账号
     */
    private String merchantWxpayAccount;

    /**
     * 商家支付宝账号 商家支付宝账号
     */
    private String merchantAlipayAccount;

    /**
     * 收款流向
     */
    private Integer proceedsFlowDirection;

    /**
     * 商家入驻状态 商家入驻状态
     */
    private Integer merchantStatus;

    /**
     * 备注 备注
     */
    private String remark;
}
```

##### 1. 商家入驻申请

```java
@ApiOperation("商家入驻申请")
@PostMapping("/merchantEnterApplication")
public CommonResult merchantEnterApplication(@Valid @RequestBody MerchantParams merchantParams) {
    int result = merchantService.insertOneMerchant(merchantParams);
    if (result <= 0) {
        return CommonResult.failed("提交商家入驻申请失败");
    }
    return CommonResult.success("提交商家申请入驻成功");
}
```

**服务层**

```java
@Override
public int insertOneMerchant(MerchantParams merchantParams) {
    Merchant merchant = new Merchant();
    merchant.setCreateTime(new Date());
    merchant.setUpdateTime(new Date());
    BeanUtil.copyProperties(merchantParams, merchant);
    merchant.setMerchantStatus(MerchantSettledStatusEnum.IN_REVIEW.getCode());
    return merchantMapper.insertSelective(merchant);
}
```

除了基本信息还包含创建日期等信息

##### 2. 删除商家

```java
@ApiOperation("删除一个商家")
@GetMapping("/deleteMerchant")
public CommonResult deleteMerchant(@RequestParam Long merchantId) {
    int result = merchantService.deleteOneMerchant(merchantId);
    if (result <= 0) {
        return CommonResult.failed("删除商家失败");
    }
    return CommonResult.success("删除商家成功");
}
```

**服务层**

```java
@Transactional(rollbackFor = Exception.class)
@Override
public int deleteOneMerchant(Long merchantId) {
    productService.deleteProductByMerchantId(merchantId);
    userCustomMapper.deleteUserByMerchantId(merchantId);
    Merchant merchant = new Merchant();
    merchant.setUpdateTime(new Date());
    merchant.setIsDeleted(1);
    MerchantExample merchantExample = new MerchantExample();
    merchantExample.createCriteria().andIdEqualTo(merchantId);
    return merchantMapper.updateByExampleSelective(merchant, merchantExample);
}
```

删除和商家的商品和用户，再删除商家（都是以改变删除状态完成）

##### 3. 更新商家信息

```java
@ApiOperation("更新商家信息")
@PostMapping("/updateMerchantInfo")
public CommonResult updateMerchantInfo(@RequestParam Long merchantId,
                                       @RequestBody MerchantParams merchantParams) {
    int result = merchantService.updateOneMerchant(merchantId, merchantParams);
    if (result <= 0) {
        return CommonResult.failed("更新商家信息失败");
    }
    return CommonResult.success("更新商家信息成功");
}
```

**服务层**

```java
@Override
public int updateOneMerchant(Long merchantId, MerchantParams merchantParams) {
    Merchant merchant = new Merchant();
    merchant.setUpdateTime(new Date());
    BeanUtil.copyProperties(merchantParams, merchant);
    MerchantExample merchantExample = new MerchantExample();
    merchantExample.createCriteria().andIdEqualTo(merchantId);
    return merchantMapper.updateByExampleSelective(merchant, merchantExample);
}
```

##### 4. 更新商家入驻信息

```java
@ApiOperation("更新商家的入驻状态")
@PostMapping("/updateMerchantSettledStatus")
public CommonResult updateMerchantSettledStatus(@RequestParam Long merchantId,
                                                @RequestParam Integer status) {
    int result = merchantService.updateOneMerchantSettledStatus(merchantId, status);
    if (result <= 0) {
        return CommonResult.failed("更新商家入驻状态失败");
    }
    return CommonResult.success("更新商家入驻状态成功");
}
```

**服务层**

```java
@Override
public int updateOneMerchantSettledStatus(Long merchantId, Integer status) {
    Merchant merchant = new Merchant();
    merchant.setMerchantStatus(status);
    merchant.setUpdateTime(new Date());
    MerchantExample merchantExample = new MerchantExample();
    merchantExample.createCriteria().andIdEqualTo(merchantId);
    return merchantMapper.updateByExampleSelective(merchant, merchantExample);
}
```

status: 0 -> 已入驻， 1 -> 审核中， 2 -> 已拒绝， 3 -> 已撤销

##### 5. 为商家分配管理员

```java
@ApiOperation("为商家分配管理员")
@PostMapping("/assignAdminToMerchant")
public CommonResult assignAdminToMerchant(HttpServletRequest httpServletRequest,
                                          @RequestParam Long merchantId,
                                          @RequestBody UserParams userParams) {

    int result = merchantService.assignAdminToMerchant(merchantId, IpUtil.getIpAddr(httpServletRequest), userParams);
    if (result <= 0) {
        return CommonResult.failed("为商家分配管理员失败");
    }
    return CommonResult.success("为商家分配管理员成功");
}
```

**服务层**

```java
@Override
public int assignAdminToMerchant(Long merchantId, String regIp, UserParams userParams) {
    SysUser sysUser = sysUserService.insertOneUser(regIp, userParams);
    MerchantSysUser merchantSysUser = new MerchantSysUser();
    merchantSysUser.setMerchantId(merchantId);
    merchantSysUser.setSysUserId(sysUser.getId());
    return merchantSysUserMapper.insertSelective(merchantSysUser);
}
```

首先插入新用户信息

##### 6. 设置商家销售款去向

```java
@ApiOperation("设置商家销售款去向")
@PostMapping("/setProceedsFlowDirection")
public CommonResult setProceedsFlowDirection(@RequestParam Long merchantId,
                                             @RequestParam Integer directon) {
    int result = merchantService.setProceedsFlowDirection(merchantId,directon);
    if (result <= 0) {
        return CommonResult.failed("设置商家销售款去向失败");
    }
    return CommonResult.success("设置商家销售款去向成功");
}
```

**服务层**

```java
@Override
public int setProceedsFlowDirection(Long merchantId, Integer direction) {
    Merchant merchant = new Merchant();
    merchant.setProceedsFlowDirection(direction);
    merchant.setUpdateTime(new Date());
    MerchantExample merchantExample = new MerchantExample();
    merchantExample.createCriteria().andIdEqualTo(merchantId);
    return merchantMapper.updateByExampleSelective(merchant, merchantExample);
}
```

direction：0 -> 商家账户， 1 -> 平台账户

##### 7. 获取所有商家列表

```java
@ApiOperation("获取所有商家列表")
@GetMapping("/getAllMerchants")
public CommonResult getAllMerchants(@RequestParam(value = "pageNum", defaultValue = "1")  Integer pageNum,
                                     @RequestParam(value = "size", defaultValue = "10") Integer size) {
    CommonPage<MerchantVo> merchantPage = merchantService.listAllMerchant(pageNum, size);
    if (merchantPage == null) {
        return CommonResult.failed("获取所有商家列表失败");
    }
    return CommonResult.success(merchantPage, "获取所有商家列表成功");
}
```

**服务层**

```java
@Override
public CommonPage<MerchantVo> listAllMerchant(Integer pageNum, Integer size) {
    PageHelper.startPage(pageNum, size);
    List<MerchantVo> merchantList = merchantCustomMapper.listAllMerchantVos();
    return CommonPage.restPage(merchantList);
}
```

##### 8. 条件筛选商家

```java
@ApiOperation("根据条件获取商家列表")
@PostMapping("/getMerchantsByCondition")
public CommonResult getMerchantsByCondition(@RequestParam(value = "pageNum", defaultValue = "1") Integer pageNum,
                                            @RequestParam(value = "size", defaultValue = "10") Integer size,
                                            @RequestBody MerchantSearchParams merchantSearchParams) {
    CommonPage<MerchantVo> merchantPage = merchantService.listMerchantByCondition(merchantSearchParams, pageNum, size);
    if (merchantPage == null) {
        return CommonResult.failed("获取商家列表失败");
    }
    return CommonResult.success(merchantPage, "获取商家列表成功");
}
```

##### 9. 获取商家管理员

```java
@ApiOperation("根据商家id获取商家的管理员")
@GetMapping("/getAdminByMerchantId")
public CommonResult getAdminByMerchantId(@RequestParam Long merchantId) {
    List<UserVo> userVoList = merchantService.listAllAdminByMerchantId(merchantId);
    if (userVoList == null) {
        return CommonResult.failed("获取商家管理员失败");
    }
    return CommonResult.success(userVoList, "获取商家管理员成功");
}
```

**服务层**

```java
@Override
public List<UserVo> listAllAdminByMerchantId(Long merchantId) {
    return userCustomMapper.listUserVosByMerchantId(merchantId);
}
```

除了用户基本信息还包括角色信息

### 2.7 支付信息模块

#### 2.7.1 支付信息控制器

##### 0. 支付domain

**商家支付密钥**

```java
@Data
public class MerchantPayInfo {
    /**
     * 商家的appId
     */
    private String platformId;
    /**
     * 和支付平台对接的密钥
     */
    private String platformKey;

    /**
     * 金钱流向
     */
    private Integer proceedsFlowDirection;
}
```

##### 1. 根据状态查询退款请求

```java
@ApiOperation("根据状态查询退款请求")
@PostMapping(value="/listRefundRequestVoByStatus")
public CommonResult listRefundRequestVoByStatus(@RequestParam(value="pageNum",defaultValue = "1") Integer pageNum,
                                                @RequestParam(value="size",defaultValue ="10") Integer size,
                                                @RequestParam(required = false) Integer status){
    return CommonResult.success(payInfoService.listRefundRequestVoByStatus(pageNum, size, status), "获取成功");
}
```

**服务层**

```java
@Override
public CommonPage<RefundRequestVo> listRefundRequestVoByStatus(Integer pageNum, Integer size, Integer status) {
    PageHelper.startPage(pageNum, size);
    List<RefundRequestVo> refundRequestVoList = payInfoCustomMapper.listRefundRequestVoByStatus(status);
    return CommonPage.restPage(refundRequestVoList);
}
```

##### 2. 同意退款

```java
@ApiOperation("同意退款")
@PostMapping(value="/confirmRefund")
public CommonResult confirmRefund(@RequestParam String orderNo) throws NoSuchAlgorithmException {
    return payInfoService.refundProcessing(orderNo);
}
```

**服务层**

```java
@Override
@Transactional
public CommonResult refundProcessing(String orderNo) throws NoSuchAlgorithmException {
    CommonResult wxResult = refund(orderNo);
    if (ResultCode.SUCCESS.getCode() == wxResult.getCode()) {
        //更新退款请求
        payInfoCustomMapper.updateRefundRequestStatusByOrderNo(orderNo, RefundStatusEnum.ACCEPT_REFUND.getCode());
        //更新订单状态
        payInfoCustomMapper.updateOrderStatusByOrderNo(orderNo, OrderStatusEnum.REFUNDED.getCode());
        //更新支付状态
        payInfoCustomMapper.updatePayInfoStatusByOrderNo(orderNo, PaymentStatusEnum.REFUNDED.getCode());
        return CommonResult.success("退款成功");
    }
    return CommonResult.success("退款失败");
}
```

退款成功后更新：退款请求状态、订单状态、支付信息

**处理退款**

```java
@Override
public CommonResult refund(String orderNo) throws NoSuchAlgorithmException {
    log.info("####################开始退款#####################");
    PayInfo payInfo = queryPayInfoByOrderNo(orderNo);
    MerchantPayInfo merchantPayInfo = getMerchantPayInfoByMerchantIdAndProcessDirection(payInfo.getMerchantId(), payInfo.getProceedsFlowDirection());
    //封装参数
    Map<String,Object> map = new RefundRequestModel()
            .platform_id(merchantPayInfo.getPlatformId())
            .out_trade_no(orderNo)
            .platform_out_trade_no(payInfo.getPlatformNumber())
            .refund_amount(payInfo.getAmount().toString())
            .creatSign(merchantPayInfo.getPlatformKey());
    //生成随机字符串并加签
    //请求
    String response = Api.refund(map);
    //接参
    BaseResponseModule responseModule = new BaseResponseModule(response);
    //获取结果键值对
    Map<String,Object> valueMap = responseModule.getValueMap();
    if ((boolean)(valueMap.get("success"))) {
        log.info("退款结果{}", valueMap);
        log.info("####################退款结束---成功#####################");
        return CommonResult.success(valueMap);
    } else {
        log.info("####################退款结束---失败#####################{}", (String)valueMap.get("message"));
        log.info("失败原因：{}", valueMap.get("message"));
        log.info("####################退款结束#####################");
        return CommonResult.failed((String)(valueMap.get("message")));
    }

}
```

退款通过接入D9LabApi实现，接入的代码为

```java
Map<String,Object> map = new RefundRequestModel()
            .platform_id(merchantPayInfo.getPlatformId())
            .out_trade_no(orderNo)
            .platform_out_trade_no(payInfo.getPlatformNumber())
            .refund_amount(payInfo.getAmount().toString())
            .creatSign(merchantPayInfo.getPlatformKey());
    //生成随机字符串并加签
    //请求
    String response = Api.refund(map);
    //接参
    BaseResponseModule responseModule = new BaseResponseModule(response);
    //获取结果键值对
    Map<String,Object> valueMap = responseModule.getValueMap();
```

| 参数                  | 描述       |
| --------------------- | ---------- |
| platform_id           | 平台id     |
| out_trade_no          | 商户订单号 |
| platform_out_trade_no | 平台订单号 |
| refund_amount         | 退款金额   |
| creatSign             | 签名       |

执行流程：

1. 根据订单号获取支付信息
2. 根据支付信息获取商户支付信息
3. 通过d9lab退款接入api执行退款
4. 判断退款结果

**根据订单号获取支付信息**

```java
public PayInfo queryPayInfoByOrderNo(String orderNo) {
    PayInfoExample payInfoExample = new PayInfoExample();
    payInfoExample.createCriteria().andOrderNoEqualTo(orderNo);
    List<PayInfo> payInfos = payInfoMapper.selectByExample(payInfoExample);
    return org.apache.shiro.util.CollectionUtils.isEmpty(payInfos)? null : payInfos.get(0);
}
```

**根据商户id和金钱流向来决定platformId和platformKey**

```java
private MerchantPayInfo getMerchantPayInfoByMerchantIdAndProcessDirection(Long merchantId, Integer direction) {
    MerchantPayInfo merchantPayInfo = new MerchantPayInfo();
    String platformId, platformKey;
    Merchant merchant = merchantMapper.selectByPrimaryKey(merchantId);
    Integer currentDirection;
    if (direction == null) {
        currentDirection = merchant.getProceedsFlowDirection();
    } else {
        currentDirection = direction;
    }
    if (ProceedsFlowDirectionEnum.COMMON.getCode().equals(currentDirection)) {
        platformId = MallConstant.DEFAULT_PLATFORM_ID;
        platformKey = MallConstant.DEFAULT_PLATFORM_KEY;
    } else {
        platformId = merchant.getMerchantWxpayAccount();
        platformKey = merchant.getCompanyKey();
        if (StringUtils.isBlank(platformId) || StringUtils.isBlank(platformKey)) {
            log.error("商家id:{} 选择了独家支付但是没有appId", merchant.getId());
            throw new MallException("商家选择了独家支付但是没有appId");
        }
    }
    merchantPayInfo.setPlatformId(platformId);
    merchantPayInfo.setPlatformKey(platformKey);
    merchantPayInfo.setProceedsFlowDirection(currentDirection);
    return merchantPayInfo;
}
```

根据订单号获取商户id和资金去向；

根据商户id获取商户；

如果资金去向是平台：获取平台id和平台key

如果资金去向是独家：通过商户获取平台id和平台key

##### 3. 拒绝退款

```java
@ApiOperation("拒绝退款")
@PostMapping(value="/refuseRefund")
public CommonResult refuseRefund(@RequestParam String orderNo) {
    payInfoService.refuseRefund(orderNo);
    return CommonResult.success("拒绝退款成功");
}
```

**服务层**

```java
@Override
public Integer refuseRefund(String orderNo) {
    //更新订单状态
    payInfoCustomMapper.updateOrderStatusByOrderNo(orderNo, OrderStatusEnum.REJECT_REFUND.getCode());
    //更新支付状态
    payInfoCustomMapper.updatePayInfoStatusByOrderNo(orderNo, PaymentStatusEnum.REJECT_REFUND.getCode());
    //更新退款请求
    return payInfoCustomMapper.updateRefundRequestStatusByOrderNo(orderNo, RefundStatusEnum.REJECT_REFUND.getCode());
}
```

### 2.8 实体类

#### 1. sysUserRole: 用户-角色

```java
public class SysUserRole implements Serializable {
    private Long id;

    private Long userId;

    private Long roleId;
    
        /**
     * 添加时间
     */
    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    /**
     * 更新时间
     */
    @ApiModelProperty(value = "更新时间")
    private Date updateTime;
}
```

#### 2. SysRoleResources: 角色-资源

```java
public class SysRoleResources implements Serializable {
    private Long id;

    private Long roleId;

    private Long resourcesId;
    }
```

#### 3. SysResources: 资源

```java
public class SysResources implements Serializable {
    private Long id;

    private String name;

    private Integer type;

    private String url;

    private String permission;

    private Long parentId;

    private Integer sort;

    /**
     * 是否外部链接
     */

    private Integer external;

    private Integer available;

    /**
     * 菜单图标
     */

    private String icon;

    /**
     * 添加时间
     */
    private Date createTime;

    /**
     * 更新时间
     */
    private Date updateTime;

    private static final long serialVersionUID = 1L;
}
```

#### 4. 商品类

```java
public class Product implements Serializable {
    private Long id;

    /**
     * 机构id
     */
    private Long merchantId;

    /**
     * 商品描述
     */
    private String productDesc;

    /**
     * 商品分类id
     */
    private Long productCategoryId;

    /**
     * 商品属性
     */
    private String productAttr;

    /**
     * 原始价格
     */
    private BigDecimal originalPrice;

    /**
     * 现在价格
     */
    private BigDecimal currentPrice;

    /**
     * 库存
     */
    private Integer stock;

    /**
     * 创建时间
     */
    private Date createTime;

    /**
     * 更新时间
     */
    private Date updateTime;

    /**
     * 运费
     */
    private BigDecimal freight;

    /**
     * 商品上传 0->下架 1->商家
     */
    private Integer status;

    /**
     * 是否删除
     */
    private Integer isDeleted;

    /**
     * 商品名称
     */
    private String productName;

    /**
     * 已卖出的件数
     */
    private Integer sell;

    /**
     * 商品上架状态 0 -> 已上架 1 -> 审核中 2 -> 已拒绝 
     */
    private Integer verifyStatus;

    private static final long serialVersionUID = 1L;
}
```

#### 5. 商品类别类

```java
public class ProductCategory implements Serializable {
    private Long id;

    /**
     * 分类名称
     */
    private String name;

    /**
     * 分类等级 1->2->3
     */
    private Integer level;

    /**
     * 分类描述
     */
    private String description;

    /**
     * 分类上级id
     */
    private Long parentId;

    /**
     * 创建时间
     */
    private Date createTime;

    /**
     * 更新时间
     */
    private Date updateTime;

    /**
     * 状态 0：禁用 1：可用
     */
    private Integer status;

    /**
     * 排序
     */
    private Integer sort;

    /**
     * 是否显示在导航栏
     */
    private Integer navStatus;

    /**
     * 图标
     */
    private String icon;

    private static final long serialVersionUID = 1L;
}
```

#### 6. 团购类别类

```java
public class GroupBuyCategory implements Serializable {
    private Long id;

    /**
     * 分类名称
     */
    private String name;

    /**
     * 团购分类描述
     */
    private String description;

    /**
     * 排序
     */
    private Integer sort;

    /**
     * 状态
     */
    private Integer status;

    /**
     * 分类Logo
     */
    private String logo;

    /**
     * 创建时间
     */
    private Date createTime;

    /**
     * 更新时间
     */
    private Date updateTime;

    /**
     * 是否删除
     */
    private Integer isDeleted;

    private static final long serialVersionUID = 1L;
}
```

#### 7. 团购订单类

```java
public class GroupBuyOrder implements Serializable {
    private Long id;

    /**
     * 商品id
     */
    private Long productId;

    /**
     * 商品购买数量
     */
    private Integer quantity;

    private Long userId;

    /**
     * 手机号码
     */
    private String phone;

    /**
     * 用户姓名
     */
    private String userName;

    /**
     * 订单号
     */
    private String orderNo;

    /**
     * 支付方式
     */
    private Integer paymentType;

    /**
     * 订单状态
     */
    private Integer orderStatus;

    /**
     * 付款时间
     */
    private Date paymentTime;

    /**
     * 邮费
     */
    private BigDecimal postage;

    /**
     * 发货时间
     */
    private Date sendTime;

    /**
     * 订单关闭时间
     */
    private Date closeTime;

    /**
     * 更新时间
     */
    private Date updateTime;

    private Date createTime;

    /**
     * 总金额
     */
    private BigDecimal totalMoney;

    /**
     * 收货地址
     */
    private String receiveAddress;

    /**
     * 是否删除
     */
    private Integer isDeleted;

    private Integer logisticsPlatform;

    private String logisticsNumber;
}
```

#### 8. 机构实体类

```java
public class Institution implements Serializable {
    private Long id;

    /**
     * 邮政编码
     */
    private String areaCode;

    /**
     * 地址
     */
    private String address;

    /**
     * logo图片地址
     */
    private String logo;

    /**
     * 联系方式
     */
    private String contact;

    /**
     * 商家描述
     */
    private String description;

    /**
     * 备注
     */
    private String remark;

    /**
     * 状态
     */
    private Integer status;

    /**
     * 入驻商家名称
     */
    private String institutionName;

    private Date createTime;

    private Date updateTime;

    private static final long serialVersionUID = 1L;
}
```

#### 9. 商家实体类

```java
public class Merchant implements Serializable {
    /**
     * 商家id 商家id
     */
    private Long id;

    /**
     * 商家名 商家名
     */
    private String merchantName;

    /**
     * 商家logo 商家logo
     */
    private String merchantLogo;

    /**
     * 商家介绍 商家介绍
     */
    private String merchantIntroduction;

    /**
     * 商家地址 商家地址
     */
    private String merchantAddress;

    /**
     * 商家联系方式 商家联系方式
     */
    private String merchantContact;

    /**
     * 创建时间 创建时间
     */
    private Date createTime;

    /**
     * 更新时间 更新时间
     */
    private Date updateTime;

    /**
     * 法人代表 法人代表
     */
    private String legalPerson;

    /**
     * 商家证书 商家证书
     */
    private String merchantCertificate;

    /**
     * 商家微信账号 商家微信账号
     */
    private String merchantWxpayAccount;

    /**
     * 商家支付宝账号 商家支付宝账号
     */
    private String merchantAlipayAccount;

    /**
     * 收款流向
     */
    private Integer proceedsFlowDirection;

    /**
     * 商家入驻状态 商家入驻状态
     */
    private Integer merchantStatus;

    /**
     * 备注 备注
     */
    private String remark;

    /**
     * 商家支付key

     */
    private String companyKey;

    /**
     * 是否删除
     */
    private Integer isDeleted;

    private static final long serialVersionUID = 1L;
}
```

#### 10. 机构管理员

```java
public class InstitutionSysUser implements Serializable {
    private Integer id;

    /**
     * 机构id
     */
    private Long institutionId;

    /**
     * 管理员id
     */
    private Long sysUserId;

    private Date createTime;

    private static final long serialVersionUID = 1L;
}
```

#### 11. 商家管理员

```java
public class MerchantSysUser implements Serializable {
    /**
     * id
     */
    private Long id;

    /**
     * 商家id
     */
    private Long merchantId;

    /**
     * 管理员id
     */
    private Long sysUserId;

    private static final long serialVersionUID = 1L;
}
```

#### 12. 管理员实体类

```java
public class SysUser implements Serializable {
    private Long id;

    private String username;

    /**
     * 登录密码
     */
    @ApiModelProperty(value = "登录密码")
    private String password;

    /**
     * 昵称
     */
    @ApiModelProperty(value = "昵称")
    private String nickname;

    /**
     * 手机号
     */
    @ApiModelProperty(value = "手机号")
    private String mobile;

    /**
     * 邮箱地址
     */
    @ApiModelProperty(value = "邮箱地址")
    private String email;

    /**
     * 性别
     */
    @ApiModelProperty(value = "性别")
    private Byte gender;

    /**
     * 头像地址
     */
    @ApiModelProperty(value = "头像地址")
    private String avatar;

    /**
     * 用户类型
     */
    @ApiModelProperty(value = "用户类型")
    private Integer userType;

    /**
     * 注册IP
     */
    @ApiModelProperty(value = "注册IP")
    private String regIp;

    /**
     * 最近登录IP
     */
    @ApiModelProperty(value = "最近登录IP")
    private String lastLoginIp;

    /**
     * 最近登录时间
     */
    @ApiModelProperty(value = "最近登录时间")
    private Date lastLoginTime;

    /**
     * 登录次数
     */
    @ApiModelProperty(value = "登录次数")
    private Integer loginCount;

    /**
     * 用户备注
     */
    @ApiModelProperty(value = "用户备注")
    private String remark;

    /**
     * 用户状态
     */
    @ApiModelProperty(value = "用户状态")
    private Integer status;

    /**
     * 注册时间
     */
    @ApiModelProperty(value = "注册时间")
    private Date createTime;

    /**
     * 更新时间
     */
    @ApiModelProperty(value = "更新时间")
    private Date updateTime;

    private static final long serialVersionUID = 1L;
}
```

#### 13. 退款请求类

```java
public class RefundRequest implements Serializable {
    /**
     * 主键
     */
    private Long id;

    /**
     * 用户id
     */
    private Long userId;

    /**
     * 订单号
     */
    private String orderNo;

    /**
     * 产品id
     */
    private Long productId;

    /**
     * 退款金钱来源
     */
    private Integer refundSource;

    /**
     * 退款理由
     */
    private String reason;

    /**
     * 金额
     */
    private BigDecimal amount;

    /**
     * 退款状态
     */
    private Integer status;

    /**
     * 创建时间
     */
    private Date createTime;

    /**
     * 更新时间
     */
    private Date updateTime;

    /**
     * 是否删除
     */
    private Integer isDeleted;
}
```

#### 14. 支付信息类

```java
public class PayInfo implements Serializable {
    private Long id;

    /**
     * 用户id
     */
    private Long userId;

    /**
     * 商家id
     */
    private Long merchantId;

    /**
     * 商品id
     */
    private Long productId;

    /**
     * 数量
     */
    private Integer quantity;

    /**
     * 金额
     */
    private BigDecimal amount;

    /**
     * 订单号
     */
    private String orderNo;

    /**
     * 支付平台状态
     */
    private Integer platformStatus;

    /**
     * 微信prepayId
     */
    private String prepayId;

    /**
     * 平台流水号
     */
    private String platformNumber;

    /**
     * 附加信息
     */
    private String attach;

    /**
     * 金钱流向
     */
    private Integer proceedsFlowDirection;

    /**
     * 创建时间
     */
    private Date createTime;

    /**
     * 更新时间
     */
    private Date updateTime;

    /**
     * 支付平台
     */
    private Integer payPlatform;

    private Integer isDeleted;

    private static final long serialVersionUID = 1L;
}
```

#### 15. 产品图片

```java
public class ProductImage implements Serializable {
    private Long id;

    /**
     * 商品id
     */
    private Long productId;

    /**
     * 图片地址
     */
    private String imageUrl;

    /**
     * 是否主图
     */
    private Integer isMain;

    /**
     * 图片排序
     */
    private Integer sort;

    /**
     * 创建时间
     */
    private Date createTime;

    /**
     * 是否删除
     */
    private Integer isDeleted;

    private static final long serialVersionUID = 1L;
}
```

### 2.9 VO

#### 1 树形资源展示: ResourceVo

```java
public class ResourceVo extends SysResources {
    private List<ResourceVo> resourceNodeList;

    public List<ResourceVo> getResourceNodeList() {
        return resourceNodeList;
    }

    public void setResourceNodeList(List<ResourceVo> resourceNodeList) {
        this.resourceNodeList = resourceNodeList;
    }
}
```

实际上是一个树形结构, 与SysResources不同的是多了一个子节点列表

#### 2 管理员展示层

```java
public class UserVo extends SysUser {

    private List<RoleVo> roleVos;

    public List<RoleVo> getRoleVos() {
        return roleVos;
    }

    public void setRoleVos(List<RoleVo> roleVos) {
        this.roleVos = roleVos;
    }
}
```

包括角色列表

#### 3 商品展示层

```java
public class ProductVo extends Product {
    private List<ProductImageVo> productImageVoList;

    public void setProductImageVoList(List<ProductImageVo> productImageVoList) {
        this.productImageVoList = productImageVoList;
    }

    public List<ProductImageVo> getProductImageVoList() {
        return productImageVoList;
    }
}
```

#### 4 商品分类展示层

```java
public class ProductCategoryVo extends ProductCategory {
    List<ProductCategoryVo> subProductCategoryVos;

    public List<ProductCategoryVo> getSubProductCategoryVos() {
        return subProductCategoryVos;
    }

    public void setSubProductCategoryVos(List<ProductCategoryVo> subProductCategoryVos) {
        this.subProductCategoryVos = subProductCategoryVos;
    }
}
```

#### 5. 退款订单展示层

```java
public class RefundRequestVo extends RefundRequest {
    private User user;
    private Product product;
}
```

### 2.10 工具类

#### 1 shiroUtil

```java
public class ShiroUtil {

    public static Session getSession() {
        return SecurityUtils.getSubject().getSession();
    }

    public static Subject getSubject() {
        return SecurityUtils.getSubject();
    }

    public static ShiroSysUser getUserEntity() {
        return (ShiroSysUser)SecurityUtils.getSubject().getPrincipal();
    }

    public static Long getUserId() {
        return getUserEntity().getAdminId();
    }

    public static Long getMerchantId() {
        return getUserEntity().getMerchantId();
    }

    public static Long getAdminType() {
        return getUserEntity().getAdminType();
    }

    public static void setSessionAttribute(Object key, Object value) {
        getSession().setAttribute(key, value);
    }

    public static Object getSessionAttribute(Object key) {
        return getSession().getAttribute(key);
    }

    public static boolean isLogin() {
        return SecurityUtils.getSubject().getPrincipal() != null;
    }

    public static void logout() {
        SecurityUtils.getSubject().logout();
    }
}
```

### 2.11 日志

#### 2.11.1 切面注解类

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface LogAnnotation {
}
```

申明了一个切面注解类，将该类作为切面，则可以操作标注该注解的方法

#### 2.11.2 切面

```java
@Pointcut("@annotation(edu.whut.mall.admin.annotations.LogAnnotation)")
public void sysLog() {
}
```

#### 2.11.3 切面方法

```java
@Around("sysLog()")
public Object doAround(ProceedingJoinPoint joinPoint) throws Throwable {
    long startTime = System.currentTimeMillis();
    //获取当前请求对象
    ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
    HttpServletRequest request = attributes.getRequest();
    SysLog sysLog=new SysLog();
    Object result = joinPoint.proceed();//执行切入的方法
    Signature signature = joinPoint.getSignature();
    sysLog.setUsername(ShiroUtil.getUserEntity().getAdminName());//获取操作的用户名
    MethodSignature methodSignature = (MethodSignature) signature;
    Method method = methodSignature.getMethod();
    if (method.isAnnotationPresent(ApiOperation.class)) {//该方法是否用了ApiOperation.class注解
        ApiOperation desc = method.getAnnotation(ApiOperation.class);//通过获取ApiOperation的value获取该方法的描述
        sysLog.setDescription(desc.value());
    }
    long endTime = System.currentTimeMillis();
    sysLog.setParams(JSON.toJSONString(getParameter(method, joinPoint.getArgs())));//通过切点获取参数和参数名
    if(result!=null) {
        sysLog.setResult("操作成功");
    }
    else{
        sysLog.setResult("操作失败");
    }
    sysLog.setSpendTime((int) (endTime - startTime));//耗时
    sysLog.setStartTime(new Date());//切入时间
    sysLog.setUrl(request.getRequestURL().toString());//请求路径
    sysLogMapper.insert(sysLog);//日志持久化

    return result;
}
```

joinPoint是指向aop切入的切点，只能用在Around型的切面方法，ProceedingJoinPoint继承了它并且暴露了proceed()方法，可以控制切入方法的运行；

| 方法                     | 描述                                                         | 具体                               |
| ------------------------ | ------------------------------------------------------------ | ---------------------------------- |
| Signature getSignature() | **获取封装了署名信息的对象,在该对象中可以获取到目标方法名,所属类的Class等信息** |                                    |
| Object[] getArgs()       | **获取传入目标方法的参数对象**                               | 获取的是参数的具体的值             |
| Object getTarget()       | **获取被代理的对象**                                         | 如果切入点是方法，那就是方法的对象 |
| Object getThis()         | **获取代理对象**                                             | 获取的该切点本身                   |

**获取参数列表的方法：**

```java
private Object getParameter(Method method, Object[] args) {
    List<Object> argList = new ArrayList<>();
    Parameter[] parameters = method.getParameters();
    for (int i = 0; i < parameters.length; i++) {
        //将RequestBody注解修饰的参数作为请求参数
        RequestBody requestBody = parameters[i].getAnnotation(RequestBody.class);
        if (requestBody != null) {
            argList.add(args[i]);
        }
        //将RequestParam注解修饰的参数作为请求参数
        RequestParam requestParam = parameters[i].getAnnotation(RequestParam.class);
        if (requestParam != null) {
            Map<String, Object> map = new HashMap<>();
            String key = parameters[i].getName();
            if (!StringUtils.isEmpty(requestParam.value())) {
                key = requestParam.value();
            }
            map.put(key, args[i]);
            argList.add(map);
        }
    }
    if (argList.size() == 0) {
        return null;
    } else if (argList.size() == 1) {
        return argList.get(0);
    } else {
        return argList;
    }
}
```

通过 joinPoint.getArgs可以获得切点的所有参数值，通过method.getParameters()获得的是方法的参数名列表；这个方法做的就是将参数和参数名对应生成一个参数表Map；这里分两种情况处理：

1. RequestBody：请求体本来就是由一个json数据转换为一个map；
2. RequestParam：请求参数是一个参数，需要参数名与值对应；

### 2.12 枚举类

#### 1. 基本状态

```java
public enum SysStatusEnum {
    AVAILABLE("正常",1),NOT_AVAILABLE("禁用",0);

    private final String desc;
    private final Integer code;
}
```

#### 2. 管理员类型

```java
public enum UserTypeEnum {
    NORMAL_ADMIN("普通管理员",0),INSTITUTION_ADMIN("商户管理员",1);

    private final String desc;
    private final Integer code;
}
```

#### 3. 商品状态

```java
public enum ProductStatusEnum {
    PRODUCT_ON_SALE(1,"商品已上架"),
    PRODUCT_OFF_SALE(0,"商品已下架");

    private final Integer code;
    private final String desc;
}
```

#### 4. 订单状态

```java
@Getter
public enum OrderStatusEnum {
    CANCELED(0, "已取消"),

    NO_PAY(10, "未付款"),

    PAID(20, "已付款"),

    NOT_SHIPPED(30, "待发货"),

    SHIPPED(40, "已发货"),

    TRADE_SUCCESS(50, "交易成功"),

    TRADE_CLOSE(60, "交易关闭"),

    WAIT_REFUND(70, "待退款"),

    REFUNDED(80, "已退款"),

    REJECT_REFUND(90, "拒绝退款");

    Integer code;
    String desc;
}
```

#### 5. 资金流向

```java
@Getter
public enum ProceedsFlowDirectionEnum {
    COMMON(1, "变购链"), EXCLUSIVE(2, "独家");
    private Integer code;
    private String desc;

    ProceedsFlowDirectionEnum(Integer code, String desc) {
        this.code = code;
        this.desc = desc;
    }
}
```

#### 6. 退款状态

```java
@Getter
public enum RefundStatusEnum {
    UNDER_REVIEW(0, "审核中"),
    ACCEPT_REFUND(1, "退款通过"),
    REJECT_REFUND(2, "拒绝退款");

    private Integer code;
    private String desc;
}
```

#### 7. 支付状态

```java
@Getter
public enum PaymentStatusEnum {
    NO_PAY(1, "未支付"), PAID(2, "已支付"), CANCLE(3, "已取消"), WAIT_REFUND(4, "待退款"),
    REFUNDED(5, "已退款"), REJECT_REFUND(6, "拒绝退款");
    private Integer code;
    private String desc;
}
```

#### 8. 商家入驻状态

```java
public enum MerchantSettledStatusEnum {
    ALREADY_SETTLED("已入驻", 1),
    IN_REVIEW("审核中", 2),
    ALREADY_REJECT("已拒绝", 3),
    ALREADY_WITHDRAW("已撤销", 4);

    private String desc;
    private Integer code;
}
```

#### 9. 商品审核状态

```java
public enum ProductVerifyStatusEnum {
    PRODUCT_ALREADY_SETTLED(0, "已上架"),
    PRODUCT_IN_REVIEW(1, "审核中"),
    PRODUCT_ALREADY_REJECT(2, "已拒绝");

    private Integer code;
    private String desc;
}
```

#### 10. 用户角色

```java
public enum UserRoleEnum {
    PLATFORM_ADMIN(1L, "平台管理员"),
    MERCHANT_ADMIN(2L, "商家管理员");
    private Long code;
    private String desc;
}
```

#### 11. 性别

```java
public enum GenderEnum {
    MAN("男",0),WOMAN("女",1),UNKNOW("保密",3);

    private final String desc;
    private final Integer code;
}
```

#### 12. 资源类型

```java
public enum ResourceTypeEnum {
    RESOURCE_MENU("菜单",0), RESOURCE_VIEW("页面",1), RESOURCE_BUTTON("按钮",2);

    private final String desc;
    private final Integer code;
}
```

#### 13. 是和否

```java
public enum YesOrNoEnum {
    YES("是",1),NO("否",0);

    private final String desc;
    private final Integer code;
}
```

## 3. 用户模块-portal

### 3.0 用户相关功能

#### 0. 微信业务

| 功能             | 描述                             |
| ---------------- | -------------------------------- |
| 微信授权登录     | 用户通过微信进行登录             |
| 获取用户基本信息 | 从用户的微信获取用户的相关信息   |
| 获取用户电话号码 | 通过用户的微信获取用户的电话号码 |

#### 1. 收获地址管理

| 功能                         | 描述 |
| ---------------------------- | ---- |
| 添加收货地址                 |      |
| 更新收货地址                 |      |
| 根据用户id显示所有的收货地址 |      |
| 根据shippingId删除收货地址   |      |
| 设为默认收货地址             |      |
| 未发货时修改地址             |      |

#### 2. 支付信息管理

| 功能         | 描述               |
| ------------ | ------------------ |
| 团购用户支付 |                    |
| 异步通知     | 处理参团和开团事务 |
| 申请退款     |                    |

#### 3. 团购订单管理

| 功能                               | 描述               |
| ---------------------------------- | ------------------ |
| 根据订单状态获取订单               |                    |
| 根据recordId和userId来获取订单详情 | 根据               |
| 根据orderNo来获取订单详情          |                    |
| 确认收货                           | 根据订单号确认收获 |
| 删除订单                           | 根据订单号删除订单 |

#### 4. 团购业务管理器

| 功能                               | 描述 |
| ---------------------------------- | ---- |
| 团购用户下单                       |      |
| 发起团购                           |      |
| 加入团购                           |      |
| 查看是否能发起团购                 |      |
| 查看是否能加入团购                 |      |
| 查看此次团购详情                   |      |
| 获取所有团购分类                   |      |
| 根据团购规则id获取团购规则详情     |      |
| 根据团购分类id获取团购规则         |      |
| 根据用户id和记录状态来获取团购记录 |      |
| 根据ruleId来获取正在进行的团购     |      |
| 根据recordId和userId来获取订单详情 |      |
| 获取商品分类                       |      |
| 根据商品分类获取团购规则           |      |
| 根据商品名称来搜索团购规则         |      |



### 3.1 微信业务模块

#### 1. 微信授权登录

**官方文档**

https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html

**接口**

```java
@ApiOperation("微信授权登录")
@PostMapping("/authorizeLogin")
public CommonResult authorizeLogin(@NotBlank @RequestParam("code") String code) {
    String session = weChatService.authorizationLogin(code);
    if (session == null) {
        return CommonResult.failed("授权失败");
    }
    return CommonResult.success(session,"授权成功");
}
```

接口的参数是微信服务器返回的code，可以在前端通过js调用wx.login()接口获得

**服务层**

```java
@Override
public String authorizationLogin(String code) {
    //        配置请求参数
    Map<String,String> params = new HashMap<>();
    params.put("appid", WxMinConstant.WX_LOGIN_APPID);
    params.put("secret", WxMinConstant.WX_LOGIN_SECRET);
    params.put("js_code", code);
    params.put("grant_type", WxMinConstant.WX_LOGIN_GRANT_TYPE);
    //        像微信服务器发送请求
    String wxRequestResult = null;
    try {
        wxRequestResult = HttpClientUtil.doGet(WxMinConstant.WX_LOGIN_URL, params);
    } catch (KeyStoreException | NoSuchAlgorithmException | KeyManagementException e) {
        e.printStackTrace();
    }
    log.info(wxRequestResult);
    JSONObject resultJson = JSONObject.fromObject(wxRequestResult);
    if (resultJson == null) {
        return null;
    }
    String session = null;
    if (resultJson.has("openid")) {
        //        获取sessionKey和openId
        String sessionKey = resultJson.get("session_key").toString();
        String openId = resultJson.get("openid").toString();
        //        生成自定义登录态
        Map<String, String> sessionMap = new HashMap<>();
        sessionMap.put("sessionKey", sessionKey);
        sessionMap.put("openId", openId);
        session = JSONObject.fromObject(sessionMap).toString();
        try {
            EncryptUtil encryptUtil = new EncryptUtil();
            session = encryptUtil.encrypt(session);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    return session;
}
```

通过向微信服务器发送请求实现授权登录，这里做的是小程序登录：

1. 请求的网址是https://api.weixin.qq.com/sns/jscode2session
2. 需要在请求中添加app_id和app_secret（在微信开发者平台申请）还有grant_type
3. 通过工具类方法发送请求，请求成功后会返回openid和sessionkey
4. 得到工具类后将openid和sessionkey封装加密成session并返回

**相关常量类**

```java
public class WxMinConstant {

    // 请求的网址
    public static final String WX_LOGIN_URL = "https://api.weixin.qq.com/sns/jscode2session";
    // 你的appid
    public static final String WX_LOGIN_APPID = "wx324f4b6595a53e86";
    // 你的密匙
    public static final String WX_LOGIN_SECRET = "8bc31d14e7fd03fe34d1259358c2fa4a";
    // 固定参数
    public static final String WX_LOGIN_GRANT_TYPE = "authorization_code";

}
```

#### 2. 获取用户基本信息

**接口**

```java
@ApiOperation("获取用户基本信息")
@PostMapping("/getUserInfoFromWx")
public CommonResult getUserInfoFromWx(@NotBlank @RequestParam("encrydata") String encrydata,
                                      @NotBlank @RequestParam("ivdata") String ivdata,
                                      @NotBlank @RequestParam("session") String session) {
    UserVo userVo = weChatService.getUserInfoFromWx(encrydata, ivdata, session);
    if (userVo != null) {
        return CommonResult.success(userVo, "获取用户信息成功");
    }
    return CommonResult.failed("获取用户信息失败");
}
```

前端调用**<u>wx.getUserInfo(Object object)</u>**返回用户数据，返回参数如下

| 参数          | 描述                                                         |
| ------------- | ------------------------------------------------------------ |
| userInfo      | 用户信息对象，不包含 openid 等敏感信息                       |
| rawData       | 不包括敏感信息的原始数据字符串，用于计算签名                 |
| signature     | 使用 sha1( rawData + sessionkey ) 得到字符串，用于校验用户信息，详见 [用户数据的签名验证和加解密](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html) |
| encryptedData | 包括敏感数据在内的完整用户信息的加密数据，详见 [用户数据的签名验证和加解密](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html#加密数据解密算法) |
| iv            | 加密算法的初始向量，详见 [用户数据的签名验证和加解密](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html#加密数据解密算法) |
| cloudID       | 敏感数据对应的云 ID，开通[云开发](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)的小程序才会返回，可通过云调用直接获取开放数据，详细见[云调用直接获取开放数据](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html#method-cloud) |

**服务层**

```java
@Override
public UserVo getUserInfoFromWx(String encrydata, String ivdata, String session) {
    String sessionKey = null;
    String openId = null;
    try {
        EncryptUtil encryptUtil = new EncryptUtil();
        String jsonString = encryptUtil.decrypt(session);
        log.info("****decrypt String***" + jsonString);
        JSONObject jsonObject = JSONObject.fromObject(jsonString);
        sessionKey = jsonObject.getString("sessionKey");
        openId = jsonObject.getString("openId");
    } catch (Exception e) {
        e.printStackTrace();
    }
    //      判断用户是否第一次登录
    User user = userService.selectUserByOpenId(openId);
    JSONObject userInfo = WxUserOpenInfoDecodeUtil.getUserInfo(encrydata, sessionKey, ivdata);
    if (userInfo == null) {
        return null;
    }
    User newUser = new User();
    newUser.setNickname(userInfo.getString("nickName"));
    newUser.setOpenId(openId);
    newUser.setUpdateTime(new Date());
    newUser.setPicture(userInfo.getString("avatarUrl"));
    if (user == null) {
        userService.insertUserSelective(newUser);
    } else {
        newUser.setId(user.getId());
        userService.updateUserSelective(openId, newUser);
    }
    UserVo userVo = new UserVo();
    BeanUtil.copyProperties(newUser, userVo);
    userVo.setUserId(newUser.getId());
    return userVo;
}
```

执行的步骤：

1. 解码session得到sessionKey
2. 通过sessionKey（加密密钥）和ivdata（偏移量）解码encrydata，得到完整的用户数据
3. 使用openID唯一标识用户，查询用户是否是第一次登录，是则插入数据，不是则更新数据
4. 最后返回数据

**用户接口服务层**

```java
//插入一个新用户
@Override
public int insertUserSelective(User user) {
    return userMapper.insertSelective(user);
}

//根据openID更新用户
@Override
public int updateUserSelective(String openId, User user) {
    UserExample userExample = new UserExample();
    userExample.createCriteria().andOpenIdEqualTo(openId);
    return userMapper.updateByExampleSelective(user, userExample);
}

//根据openID查询用户
@Override
public User selectUserByOpenId(String openId) {
    return userMapper.selectByOpenId(openId);
}
```

#### 3. 获取用户电话号码

**接口**

```java
@ApiOperation("获取用户电话号码")
@PostMapping("/getUserPhoneNumberFromWx")
public CommonResult getUserPhoneNumberFromWx(@NotBlank @RequestParam("encrydata") String encrydata,
                                             @NotBlank @RequestParam("ivdata") String ivdata,
                                             @NotBlank @RequestParam("session") String session) {
    String userPhoneNumber = weChatService.getUserPhoneNumberFromWx(encrydata, ivdata, session);
    if (userPhoneNumber == null) {
        return CommonResult.failed("获取用户电话号码失败");
    }
    return CommonResult.success("获取用户电话号码成功");
}
```

**服务层**

```java
@Override
public String getUserPhoneNumberFromWx(String encrydata, String ivdata , String session) {
    JSONObject userPhoneNumber = WxUserOpenInfoDecodeUtil.getUserInfo(encrydata, ivdata, session);
    log.info(userPhoneNumber.toString());
    return userPhoneNumber.getString("phoneNumber");
}
```

![image-20210630174318288](%E5%8F%98%E6%9E%84%E5%9B%A2%E9%A1%B9%E7%9B%AE%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0.assets/image-20210630174318288.png)

### 3.2 收获地址管理模块

#### 0. 收获地址domain

```java
@Data
public class ShippingParams {

    /**
    * 
    */
    private Long id;

    /**
    * 用户id
    */
    @NotNull
    private Long userId;

    /**
    * 收货人姓名
    */
    @NotBlank
    private String receiveName;

    /**
    * 收货人手机
    */
    @NotBlank
    private String receivePhone;

    /**
    * 城市
    */
    private String receiveCity;

    /**
    * 省份
    */
    private String receiveProvince;
    /**
     * 区
     */
    private String receiveZone;

    /**
    * 详细地址
    */
    @NotBlank
    private String receiveAddress;

    /**
     * 是否为默认地址
     */
    private Integer isMain;

}
```

#### 1. 添加收获地址

**接口**

```java
@ApiOperation("添加收货地址")
@PostMapping(value = "/addOneShipping")
public CommonResult addOneShipping(@Valid @RequestBody ShippingParams shippingParams) {
    int result = shippingService.insertOneShipping(shippingParams);
    if (result <= 0) {
        return CommonResult.failed("添加收货地址失败");
    }
    return CommonResult.success("添加收货地址成功");
}
```

**服务层**

```java
@Override
public Integer insertOneShipping(ShippingParams shippingParams) {
    Shipping shipping = new Shipping();
    BeanUtils.copyProperties(shippingParams, shipping);
    //如果是默认地址
    if (shippingParams.getIsMain().equals(1)) {
        //把原来的默认地址设置为不是默认的
        shippingCustomMapper.revokeDefaultAddressByShippingId(shippingParams.getUserId());
    }
    return shippingMapper.insertSelective(shipping);
}
```

添加新的收获地址，如果是默认的收获地址，将原来的默认地址设为非默认

#### 2. 更新收获地址

```java
@ApiOperation("更新收货地址")
@PostMapping(value = "/updateOneShipping")
public CommonResult updateOneShipping(@RequestBody ShippingParams shippingParams) {
    int result = shippingService.updateOneShipping(shippingParams);
    if (result <= 0) {
        return CommonResult.failed("更新收货地址失败");
    }
    return CommonResult.success("更新收货地址成功");
}
```

**服务层**

```java
@Override
public Integer updateOneShipping(ShippingParams shippingParams) {
    Shipping shipping = new Shipping();
    BeanUtils.copyProperties(shippingParams, shipping);
    shipping.setUpdateTime(new Date());
    return shippingMapper.updateByPrimaryKeySelective(shipping);
}
```

#### 3. 根据用户id显示所有收获地址

**接口**

```java
@ApiOperation("根据用户id显示所有的收货地址")
@GetMapping(value = "/listShippingVosByUserId")
public CommonResult listShippingVosByUserId(@NotNull @RequestParam Long userId) {
    List<ShippingVo> shippingVoList = shippingService.listShippingVosByUserId(userId);
    if (shippingVoList ==null) {
        return CommonResult.failed("暂时没有收货地址");
    }
    return CommonResult.success(shippingVoList,"获取收货地址列表成功");
}
```

**服务层**

```java
@Override
public List<ShippingVo> listShippingVosByUserId(Long userId) {
    ShippingExample shippingExample = new ShippingExample();
    shippingExample.createCriteria().andUserIdEqualTo(userId);
    List<Shipping> shippingList = shippingMapper.selectByExample(shippingExample);
    List<ShippingVo> shippingVoList = shippingList.stream().map(this::trans2Vo).collect(Collectors.toList());
    return shippingVoList;
}
```

查询并转换为vo

**转换vo方法**

```java
private ShippingVo trans2Vo(Shipping shipping){
    ShippingVo shippingVo = new ShippingVo();
    BeanUtils.copyProperties(shipping, shippingVo);
    return shippingVo;
}
```

#### 4. 根据shipppingID删除收获地址

**接口**

```java
@ApiOperation("根据shippingId删除收货地址")
@PostMapping(value = "/deleteShippingByShippingId")
public CommonResult deleteShippingByShippingId(@NotNull @RequestParam Long shippingId) {
    int result = shippingService.deleteOneShipping(shippingId);
    if (result == 0) {
        return CommonResult.failed("删除收货地址失败");
    }
    return CommonResult.success("删除收货地址成功");
}
```

**服务层**

```java
@Override
public Integer deleteOneShipping(Long shippingId) {
    return shippingMapper.deleteByPrimaryKey(shippingId);
}
```

#### 5. 设置默认收获地址

**接口**

```java
@ApiOperation("设为默认收货地址")
@PostMapping(value = "/setDefaultShipping")
public CommonResult setDefaultShipping(@NotNull @RequestParam Long userId,
                                       @NotNull @RequestParam Long shippingId) {
    int result = shippingService.setDefaultShipping(userId, shippingId);
    if (result <= 0) {
        return CommonResult.failed("设为默认收货地址失败");
    }
    return CommonResult.success("设为默认收货地址成功");
}
```

**服务层**

```java
@Override
@Transactional
public Integer setDefaultShipping(Long userId, Long shippingId) {
    //把原来的默认地址设置为不是默认的
    shippingCustomMapper.revokeDefaultAddressByShippingId(userId);
    Shipping shipping = new Shipping();
    shipping.setId(shippingId);
    shipping.setIsMain(1);
    return shippingMapper.updateByPrimaryKeySelective(shipping);
}
```

要更改两条记录，一条是旧的默认地址，一条是新的默认地址

#### 6. 未发货时修改地址

**接口**

```java
@ApiOperation("未发货时修改地址")
@PostMapping(value = "/modifyShippingAddress")
public CommonResult modifyShippingAddress(@NotNull @RequestParam String orderNo,
                                          @NotNull @RequestParam String username,
                                          @NotNull @RequestParam String phone,
                                          @NotNull @RequestParam String receiveAddress) {
    return CommonResult.success(shippingService.modifyShippingAddress(orderNo, username, phone, receiveAddress), "修改收货地址成功");
}
```

**服务层**

```java
@Override
public Integer modifyShippingAddress(String orderNo, String username, String phone, String receiveAddress) {
    return shippingCustomMapper.modifyShippingAddress(orderNo, username, phone, receiveAddress);
}
```

根据订单号更改地址

### 3.3 支付信息管理模块

#### 0. 支付信息domain

**支付信息参数**

```java
@Data
public class PayInfoParams {

    /**
    * 主键
    */
    private Long id;

    /**
    * 用户id
    */
    private Long userId;

    /**
     * 收货地址id
     */
    private Long shippingId;

    /**
     * 商家id
     */
    private Long merchantId;

    /**
    * 支付平台
    */
    private Integer payPlatform;

    /**
    * 金额
    */
    private BigDecimal amount;


    /**
     * 支付必须传递openId
     */
    private String openId;

    /**
     * 产品id
     */
    private Long productId;

    /**
     * 产品名称
     */
    private String productName;

    /**
     * 产品数量
     */
    private Integer quantity;

    /**
     * 附加信息
     */
    private String attach;

    /* ------------------------团购规则和团购记录id只能出现一个-----------------------------------
   /**
    * 团购规则id
    */
    private Long groupBuyRuleId;

    /**
     * 团购记录id
     */
    private Long groupBuyRecordId;
    /* ------------------------只能出现一个-----------------------------------

    /**
     * 团购人员的类型 参与者、发起者
     */
    @NotNull
    private Integer userType;

}
```

**团购订单参数**

```java
@Data
public class GroupBuyOrderParams {
    /* ------------------------团购规则和团购记录id只能出现一个-----------------------------------
    /**
     * 团购规则id
     */
    private Long groupBuyRuleId;

    /**
     * 团购记录id
     */
    private Long groupBuyRecordId;
    /* ------------------------只能出现一个-----------------------------------

    /**
     * 团购人员的类型 参与者、发起者
     */
    @NotNull
    private Integer userType;

    public static GroupBuyOrderParams extractGroupOrderAttach(PayInfoParams payInfoParams) {
        GroupBuyOrderParams groupBuyOrderParams = new GroupBuyOrderParams();
        groupBuyOrderParams.setGroupBuyRecordId(payInfoParams.getGroupBuyRecordId());
        groupBuyOrderParams.setGroupBuyRuleId(payInfoParams.getGroupBuyRuleId());
        groupBuyOrderParams.setUserType(payInfoParams.getUserType());
        return groupBuyOrderParams;
    }

}
```

#### 1. 团购用户支付

**接口**

```java
@ApiOperation("团购用户支付")
@PostMapping(value = "/pay")
public CommonResult create(@Valid @RequestBody PayInfoParams payInfoParams) throws NoSuchAlgorithmException {
       return payInfoService.Create(payInfoParams);
}
```

**服务层**

```java
@Override
public CommonResult Create(PayInfoParams payInfoParams) throws NoSuchAlgorithmException {
    log.info("{} ####################预支付开始#####################", MallConstant.PAY_LOG_PREFIX);
    log.info("{} 本次订单请求信息：{}", MallConstant.PAY_LOG_PREFIX, payInfoParams);
    //决定支付的方式
    MerchantPayInfo merchantPayInfo = getMerchantPayInfoByMerchantIdAndProcessDirection(payInfoParams.getMerchantId(), null);
    log.info("{} 本次订单merchant信息：{}", MallConstant.PAY_LOG_PREFIX, merchantPayInfo);
    //订单入库
    GroupBuyOrderVo orderVo = groupBuyOrderService.createGroupBuyOrder(payInfoParams);
    //开始进行支付请求
    //封装参数
    Map<String, Object> map = new PrepayRequestModel()
            .platform_id(merchantPayInfo.getPlatformId())
            .pay_platform("WxPay")
            .trade_type("JSAPI")
            .out_trade_no(orderVo.getOrderNo())
            .title(payInfoParams.getProductName())
            .total_amount(payInfoParams.getAmount().toString())
            .notify_url(MallConstant.NOTIFY_URL)
            .open_id(payInfoParams.getOpenId())
            .creatSign(merchantPayInfo.getPlatformKey());//生成随机字符串并加签
    log.info("{} 本次订单封装map信息：{}", MallConstant.PAY_LOG_PREFIX, map);
     //请求
    String response = Api.prepay(map);
    //接参
    BaseResponseModule responseModule = new BaseResponseModule(response);
    if (!responseModule.isSuccess()) {
        log.info("{} 本次订单预付失败信息：{}", MallConstant.PAY_LOG_PREFIX, responseModule.getMessage());
        return null;
    }
    //获取结果键值对
    Map<String, Object> valueMap = responseModule.getValueMap();
    log.info("{} 本次订单预付信息：{}", MallConstant.PAY_LOG_PREFIX, valueMap);
    //获取prepay_id
    String prepayId = ((String)valueMap.get("package")).split("=")[1];
    //支付信息入库
    PayInfo payInfo = buildPayInfo(payInfoParams, orderVo.getOrderNo(), merchantPayInfo.getProceedsFlowDirection(), prepayId);
    payInfoMapper.insertSelective(payInfo);
    log.info("{} ####################预支付结束#####################", MallConstant.PAY_LOG_PREFIX);
    return CommonResult.success(valueMap);
}
```

通过接入D9LAB pay API完成支付，统一下单api必需的参数如下：

| 参数         | 描述                                        |
| ------------ | ------------------------------------------- |
| appId        | 平台id                                      |
| pay_platform | 交易平台，支持微信和支付宝平台              |
| trade_type   | 支付场景，支持app、h5、pc端、刷脸等支付场景 |
| out_trade_no | 商家订单号                                  |
| title        | 商品名                                      |
| total_amount | 商品总价                                    |
| notify_url   | 通知地址，返回后的回调url                   |
| open_id      | 微信支付时的用户标识，需要通过请求得到      |
| sign         | 签名，使用加签算法保证交易安全              |

支付的步骤如下：

1. 首先通过商家信息获取平台id和平台支付密钥
2. 然后根据支付信息可以获取到其他的参数
3. 接入成功后通过BaseResponseModule接参，返回的是预支付订单
4. 生成预支付订单信息，将api返回参数返回给前端

**获取platformId和platformKey的方法**

```java
private MerchantPayInfo getMerchantPayInfoByMerchantIdAndProcessDirection(Long merchantId, Integer direction) {
    MerchantPayInfo merchantPayInfo = new MerchantPayInfo();
    String platformId, platformKey;
    Merchant merchant = merchantMapper.selectByPrimaryKey(merchantId);
    Integer currentDirection;
    if (direction == null) {
        currentDirection = merchant.getProceedsFlowDirection();
    } else {
        currentDirection = direction;
    }
    if (ProceedsFlowDirectionEnum.COMMON.getCode().equals(currentDirection)) {
        platformId = MallConstant.DEFAULT_PLATFORM_ID;
        platformKey = MallConstant.DEFAULT_PLATFORM_KEY;
    } else {
        platformId = merchant.getMerchantWxpayAccount();
        platformKey = merchant.getCompanyKey();
        if (StringUtils.isBlank(platformId) || StringUtils.isBlank(platformKey)) {
            log.error("商家id:{} 选择了独家支付但是没有appId", merchant.getId());
            throw new MallException("商家选择了独家支付但是没有appId");
        }
    }
    merchantPayInfo.setPlatformId(platformId);
    merchantPayInfo.setPlatformKey(platformKey);
    merchantPayInfo.setProceedsFlowDirection(currentDirection);
    return merchantPayInfo;
}
```

**生成预支付订单信息**

```java
private PayInfo buildPayInfo(PayInfoParams payInfoParams, String orderNo, Integer proceedsFlowDirection, String prepayId) {
    PayInfo payInfo = new PayInfo();
    BeanUtils.copyProperties(payInfoParams, payInfo);
    payInfo.setPrepayId(prepayId);
    payInfo.setOrderNo(orderNo);
    payInfo.setPlatformStatus(PaymentStatusEnum.NO_PAY.getCode());
    payInfo.setProceedsFlowDirection(proceedsFlowDirection);
    payInfo.setAttach(JsonUtil.obj2Str(GroupBuyOrderParams.extractGroupOrderAttach(payInfoParams)));
    return payInfo;
}
```

因为是预支付订单，所有状态设为未支付

#### 2. 异步通知

**接口**

```java
@ApiOperation("异步通知")
@PostMapping(value = "/notify")
public String asyncNotify(HttpServletRequest request) throws NoSuchAlgorithmException {
    return payInfoService.asyncNotify(request);
}
```

该接口执行于支付团购订单之后，用于判断用户是否有开团/参团资格

**服务层**

```java
@Override
public String asyncNotify(HttpServletRequest request) throws NoSuchAlgorithmException {
    log.info("{} ####################开始异步回调#####################", MallConstant.PAY_LOG_PREFIX);
    NotifyModel notifyModel = new NotifyModel(request);
    //查找对应的companyKey
    String orderNo = notifyModel.getOutTradeNo();
    PayInfo payInfo = queryPayInfoByOrderNo(orderNo);
    //决定支付的方式
    MerchantPayInfo merchantPayInfo = getMerchantPayInfoByMerchantIdAndProcessDirection(payInfo.getMerchantId(), payInfo.getProceedsFlowDirection());
    //验签
    notifyModel.verifyRequest(request, merchantPayInfo.getPlatformKey());
    if (notifyModel.isTrustedRequest()) {
        log.info("{}:异步返回信息成功！！！{}", MallConstant.PAY_LOG_PREFIX, JsonUtil.obj2Str(notifyModel));
    } else {
        log.info("{}:异步返回信息失败！！！{}", MallConstant.PAY_LOG_PREFIX, JsonUtil.obj2Str(notifyModel));
        return MallConstant.PAY_FAIL_RETURN_INFO;
    }
    GroupBuyOrderParams groupBuyOrderParams = JsonUtil.str2Obj(payInfo.getAttach(), GroupBuyOrderParams.class);
    log.info("{}:异步返回团购信息{}", MallConstant.PAY_LOG_PREFIX, groupBuyOrderParams);
    GroupBuyQualificationResult result;
    if (GroupBuyUserTypeEnum.GROUP_BUY_CREATE.getCode().equals(groupBuyOrderParams.getUserType())) {
        result = portalGroupBuyService.createGroupBuyRecord(payInfo.getUserId(), groupBuyOrderParams.getGroupBuyRuleId(), orderNo);
    } else {
        result = portalGroupBuyService.joinGroupBuyRecord(payInfo.getUserId(), groupBuyOrderParams.getGroupBuyRecordId(), orderNo);
    }
    log.info("{} 开团的结果：{}", MallConstant.PAY_LOG_PREFIX, result);
    log.info("{} ####################异步回调结束#####################", MallConstant.PAY_LOG_PREFIX);
    if (result.isQualified()) {
        updateGroupBuyOrderStatus(orderNo, OrderStatusEnum.PAID.getCode());
        updatePayInfo(orderNo, payInfo.getPlatformNumber(), PaymentStatusEnum.PAID.getCode());
    }
    return MallConstant.PAY_SUCCESS_RETURN_INFO;
}
```

代码流程

1. 用notifyModel读取请求

2. 从请求中获取订单号，并通过订单号获取支付信息

3. 通过商户id和资金流向获取商家支付密钥，包括：商家appID、支付密钥、金钱流向

4. 使用支付密钥对请求进行验签

5. 判断请求是否可靠

6. 从支付信息中获取团购订单参数

7. 根据团购订单参数执行发起团购或者参加团购

8. 如果发起/参加成功，则更新团购订单和支付信息

   注：GroupBuyOrder和GroupBuyRecord不同，GroupBuyOrder是用户参与团购的订单，主要和支付相关；GroupBuyRecord是指一个团购活动记录，包含参团人数、团购规则等信息；

**根据订单查询支付信息**

```java
@Override
public PayInfo queryPayInfoByOrderNo(String orderNo) {
    PayInfoExample payInfoExample = new PayInfoExample();
    payInfoExample.createCriteria().andOrderNoEqualTo(orderNo);
    List<PayInfo> payInfos = payInfoMapper.selectByExample(payInfoExample);
    return CollectionUtils.isEmpty(payInfos)? null : payInfos.get(0);
}
```

**更新支付信息**

```java
public void updatePayInfo(String orderNo, String platformNumber, Integer PaymentStatusCode) {
    PayInfo payInfo = new PayInfo();
    payInfo.setPlatformStatus(PaymentStatusCode);
    payInfo.setUpdateTime(new Date());
    payInfo.setOrderNo(orderNo);
    payInfo.setPlatformNumber(platformNumber);
    groupBuyOrderCustomMapper.updatePayInfoStatusByOrderNo(payInfo);
}
```



#### 3. 申请退款

**接口**

```java
@ApiOperation("申请退款")
@PostMapping(value = "/requestFund")
public CommonResult requestFund(String orderNo, String reason) {
    int result = payInfoService.requestFund(orderNo, reason);
    if (result < 1) {
        return CommonResult.failed("申请退款失败");
    }
    return CommonResult.success("申请退款成功");
}
```

**服务层**

```java
@Override
@Transactional
public Integer requestFund(String orderNo, String reason) {
    GroupBuyOrder order = groupBuyOrderCustomMapper.queryGroupBuyOrderByOrderNo(orderNo);
    PayInfo payInfo = queryPayInfoByOrderNo(orderNo);
    RefundRequest refundRequest = new RefundRequest();
    refundRequest.setAmount(payInfo.getAmount());
    refundRequest.setOrderNo(orderNo);
    refundRequest.setProductId(order.getProductId());
    refundRequest.setUserId(order.getUserId());
    refundRequest.setReason(reason);
    refundRequest.setStatus(RefundStatusEnum.UNDER_REVIEW.getCode());
    refundRequest.setRefundSource(payInfo.getProceedsFlowDirection());
    //更新支付状态
    updatePayInfoStatus(orderNo, PaymentStatusEnum.WAIT_REFUND.getCode());
    //更新订单状态
    updateGroupBuyOrderStatus(orderNo, OrderStatusEnum.WAIT_REFUND.getCode());
    return refundRequestMapper.insertSelective(refundRequest);
}
```

执行流程：

1. 生成退款请求：主要信息包括用户id、订单号、产品id、退款理由、退款金额
2. 更新支付状态为等待退款
3. 更新订单状态为等待退款

### 3.4 团购订单管理模块

#### 1. 根据订单状态来获取订单详情

**接口**

```java
@ApiOperation("根据订单状态来获取订单详情")
@PostMapping(value = "/getGroupBuyOrderVoByOrderStatus")
public CommonResult getGroupBuyOrderVoByOrderStatus(@RequestParam(value="pageNum",defaultValue = "1") Integer pageNum,
                                                    @RequestParam(value="size",defaultValue ="10") Integer size,
                                                    @NotNull @RequestParam Long userId,
                                                    @RequestParam(required = false)Integer orderStatus){
    return CommonResult.success(groupBuyOrderService.getGroupBuyOrderVoByOrderStatus(pageNum, size, userId, orderStatus));
}
```

**服务层**

```java
@Override
public CommonPage<GroupBuyOrderVo> getGroupBuyOrderVoByOrderStatus(Integer pageNum, Integer size, Long userId, Integer orderStatus) {
    PageHelper.startPage(pageNum, size);
    List<GroupBuyOrderVo> groupBuyOrderVos =groupBuyOrderCustomMapper.getGroupBuyOrderVoByOrderStatus(userId, orderStatus);
    return  CommonPage.restPage(groupBuyOrderVos);
}
```

使用pageHelper进行分页，返回的团购订单vo

#### 2. 根据recordId和userId来获取订单详情

**接口**

```java
@Override
public GroupBuyOrderVo getGroupBuyOrderVoByRecordIdAndUserId(Long recordId, Long userId) {
    return groupBuyOrderCustomMapper.getGroupBuyOrderVoByRecordIdAndUserId(recordId, userId);
}
```

#### 3. 根据orderNo来获取订单详情

**接口**

```java
@ApiOperation("根据orderNo来获取订单详情")
@PostMapping(value = "/getGroupBuyOrderVoByOrderNo")
public CommonResult getGroupBuyOrderVoByOrderNo(@NotNull @RequestParam String orderNo){
    return CommonResult.success(groupBuyOrderService.getGroupBuyOrderVoByOrderNo(orderNo));
}
```

**服务层**

```java
@Override
public GroupBuyOrderVo getGroupBuyOrderVoByOrderNo(String orderNo) {
   return groupBuyOrderCustomMapper.getGroupBuyOrderVoByOrderNo(orderNo);
}
```

#### 4. 确认收货

**接口**

```java
@ApiOperation("确认收货")
@PostMapping(value = "/confirmReceipt")
public CommonResult confirmReceipt(@NotNull @RequestParam String orderNo){
    return CommonResult.success(groupBuyOrderService.confirmReceipt(orderNo));
}
```

**服务层**

```java
@Override
public Integer confirmReceipt(String orderNo) {
    return groupBuyOrderCustomMapper.confirmReceipt(orderNo);
}
```

根据订单号更新相应的数据

#### 5. 删除订单

**接口**

```java
@ApiOperation("删除订单")
@PostMapping(value = "/deleteOrder")
public CommonResult deleteOrder(@NotNull @RequestParam String orderNo){
    return CommonResult.success(groupBuyOrderService.deleteOrder(orderNo));
}
```

**服务层**

```java
@Override
public Integer deleteOrder(String orderNo) {
    return groupBuyOrderCustomMapper.deleteOrder(orderNo);
}
```

### 3.5 团购业务管理模块

#### 1. 团购下单

**接口**

```java
@ApiOperation("团购用户下单")
@PostMapping(value = "/createOneGroupBuyOrder")
public CommonResult addOneGroupBuyOrder(@Valid @RequestBody PayInfoParams payInfoParams){
    GroupBuyOrderVo orderVo = groupBuyOrderService.createGroupBuyOrder(payInfoParams);
    if (orderVo == null) {
        return CommonResult.failed("添加团购订单失败");
    }
    return CommonResult.success(orderVo,"添加团购订单成功");
}
```

**服务层**

```java
@Override
@Transactional
public GroupBuyOrderVo createGroupBuyOrder(PayInfoParams payInfoParams) throws MallException {
    Shipping shipping = shippingMapper.selectByPrimaryKey(payInfoParams.getShippingId());
    if (shipping == null){
        log.info("地址不存在");
        throw new MallException("收货地址不存在");
    }
    GroupBuyRule rule = groupBuyRuleMapper.selectByPrimaryKey(payInfoParams.getGroupBuyRuleId());
    if (rule == null){
        log.info("团购规则不存在");
        throw new MallException("团购规则不存在");
    }
    //减少库存
    reduceStock(rule.getProductId(), payInfoParams.getQuantity());
    GroupBuyOrder order = buildOrder(payInfoParams, rule, shipping);
    groupBuyOrderMapper.insertSelective(order);
    GroupBuyOrderVo orderVo = transOrder2Vo(order);
    return orderVo;
}
```

执行流程：

1. 检查收获地址是否存在
2. 检查团购规则是否存在
3. 如果都可行则减少库存
4. 生成订单并入库
5. 转换为订单vo，补充产品详细信息并返回

#### 2. 发起团购

```java
@ApiOperation("发起团购")
@PostMapping(value = "/createGroupBuy")
public CommonResult createGroupBuy(@NotNull @RequestParam Long userId,
                                   @NotNull @RequestParam Long groupBuyRuleId,
                                   @NotBlank @RequestParam String orderId) throws NoSuchAlgorithmException {
    GroupBuyQualificationResult result = portalGroupBuyService.createGroupBuyRecord(userId, groupBuyRuleId, orderId);
    if (!result.isQualified()) {
        log.info("失败的原因:{}", result.getFailMessage());
        return CommonResult.failed("发起团购失败:" + result.getFailMessage());
    }
    return CommonResult.success(result, "发起团购成功");
}
```

**服务层**

```java
@Override
@Transactional
public GroupBuyQualificationResult createGroupBuyRecord(Long userId, Long groupBuyRuleId, String orderId) throws MallException, NoSuchAlgorithmException {
    GroupBuyRecord groupBuyRecord = new GroupBuyRecord();
    GroupBuyRule groupBuyRule = groupBuyRuleMapper.selectByPrimaryKey(groupBuyRuleId);
    //检查有没有资格开启此次团购
    GroupBuyQualificationResult qualificationResult = isQualifiedToCreateGroupBuyRecord(userId, groupBuyRuleId);
    if (!qualificationResult.isQualified()) {
        refundGroupBuyRecord(orderId);
        return qualificationResult;
    }
    Date now = new Date();
    groupBuyRecord.setStartTime(now);
    groupBuyRecord.setCurrentNumber(1);
    groupBuyRecord.setSuccessNumber(groupBuyRule.getSuccessPeopleNumber());
    groupBuyRecord.setGroupBuyRuleId(groupBuyRuleId);
    groupBuyRecord.setGroupBuyPrice(groupBuyRule.getGroupBuyPrice());
    groupBuyRecord.setExpireTime(DateUtils.addMinutes(now, groupBuyRule.getValidTime()));
    groupBuyRecord.setStatus(GroupBuyRecordStatusEnum.GROUP_BUY_PROCESSING.getCode());
    groupBuyRecordMapper.insertSelective(groupBuyRecord);
    updateUserGroupBuyCount(userId, groupBuyRuleId, qualificationResult.getBuyCount());
    insertUserInfo2GroupBuyRecord(userId, groupBuyRecord.getId(), GroupBuyUserTypeEnum.GROUP_BUY_CREATE.getCode(), orderId);
    return qualificationResult;
}
```

流程：

1. 判断用户是否有资格

2. 没有资格则执行退款

3. 有资格则将团购订单入库

   为订单设置：开始时间、已有人数（1）、开团成功需要人数、规则id、团购价格、过期时间、订单状态（团购进行中）

4. 更新用户购买次数

5. 记录用户团购记录

**更新用户购买次数**

```java
private void updateUserGroupBuyCount(Long userId, Long groupBuyRuleId, Integer formerBuyCount){
    UserGroupBuyRuleCount userGroupBuyRuleCount = new UserGroupBuyRuleCount();
    userGroupBuyRuleCount.setUserId(userId);
    userGroupBuyRuleCount.setGroupBuyRuleId(groupBuyRuleId);
    if (formerBuyCount > 0) {
        userGroupBuyRuleCount.setCount(formerBuyCount + 1);
        userGroupBuyRuleCountMapper.updateByPrimaryKeySelective(userGroupBuyRuleCount);
    }
    else{
        userGroupBuyRuleCount.setCount(1);
        userGroupBuyRuleCountMapper.insertSelective(userGroupBuyRuleCount);
    }
}
```

**插入用户团购记录**

```java
private int insertUserInfo2GroupBuyRecord(Long userId, Long groupBuyRecordId, Integer userType, String orderId){
    GroupBuyRecordUser groupBuyRecordUser = new GroupBuyRecordUser();
    User user = userMapper.selectByPrimaryKey(userId);
    groupBuyRecordUser.setUserId(userId);
    groupBuyRecordUser.setUsername(user.getNickname());
    groupBuyRecordUser.setUserPic(user.getPicture());
    groupBuyRecordUser.setRecordId(groupBuyRecordId);
    groupBuyRecordUser.setOrderId(orderId);
    groupBuyRecordUser.setUserType(userType);
    return groupBuyRecordUserMapper.insertSelective(groupBuyRecordUser);
}
```

#### 3. 加入团购

```java
@ApiOperation("加入团购")
@PostMapping(value = "/joinGroupBuy")
public CommonResult joinGroupBuy(@NotNull @RequestParam Long userId,
                                 @NotNull @RequestParam Long groupBuyRecordId,
                                 @NotBlank @RequestParam String orderId) throws NoSuchAlgorithmException {
    GroupBuyQualificationResult result = portalGroupBuyService.joinGroupBuyRecord(userId, groupBuyRecordId, orderId);
    if (!result.isQualified()) {
        log.info("失败的原因:{}", result.getFailMessage());
        return CommonResult.failed("加入团购失败:" + result.getFailMessage());
    }
    return CommonResult.success(result, "加入团购成功");
}
```

**服务层**

```java
@Transactional
@Override
public GroupBuyQualificationResult joinGroupBuyRecord(Long userId, Long groupBuyRecordId, String orderId) throws NoSuchAlgorithmException {
    GroupBuyRecord record = groupBuyRecordMapper.selectByPrimaryKey(groupBuyRecordId);
    GroupBuyRule rule = groupBuyRuleMapper.selectByPrimaryKey(record.getGroupBuyRuleId());
    GroupBuyQualificationResult result = isQualifiedToJoinGroupBuyRecord(userId, groupBuyRecordId, rule.getLimitNumber());
    if (!result.isQualified()){
        refundGroupBuyRecord(orderId);
        return result;
    }
    updateUserGroupBuyCount(userId, record.getGroupBuyRuleId(), result.getBuyCount());
    insertUserInfo2GroupBuyRecord(userId, groupBuyRecordId, GroupBuyUserTypeEnum.GROUP_BUY_JOIN.getCode(), orderId);
    GroupBuyRecord updateRecord = new GroupBuyRecord();
    updateRecord.setId(record.getId());
    updateRecord.setCurrentNumber(record.getCurrentNumber() + 1);
    updateRecord.setUpdateTime(new Date());
    groupBuyRecordMapper.updateByPrimaryKeySelective(updateRecord);
    //查询团购规则 是否可以开团发货
    if (record.getSuccessNumber().equals(updateRecord.getCurrentNumber())) {
        log.info("团购record:{}开团成功,进入异步方法", record.getId());
        groupBuyAsyncService.SuccessGroupBuyOrder(record.getId());
    }
    return result;
}
```

执行流程：

1. 判断用户是否有资格参团
2. 无资格则退款
3. 有资格首先更新用户团购购买数
4. 插入用户团购记录
5. 更新团购订单
6. 检查该团购订单是否可以开团发货

**更新团购订单状态**

```java
@Override
public void updateGroupBuyOrderStatus(String orderNo, Integer orderStatusCode){
    GroupBuyOrder order = groupBuyOrderCustomMapper.queryGroupBuyOrderByOrderNo(orderNo);
    if (order == null){
        throw new MallException("订单不存在");
    }
    Date now = new Date();
    //如果是付款则必须更新paymentTime,其他操作不需要更新
    if (OrderStatusEnum.PAID.getCode().equals(orderStatusCode)) {
        order.setPaymentTime(now);
    }
    order.setUpdateTime(now);
    order.setPaymentType(PaymentTypeEnum.WX.getCode());
    order.setOrderStatus(orderStatusCode);
    groupBuyOrderCustomMapper.updateGroupBuyOrderByOrderNo(order);
}
```

更新支付类型、订单状态、更新时间、支付时间

#### 4. 查看是否能发起团购

**接口**

```java
@ApiOperation("查看是否能发起团购")
@PostMapping(value = "/isQualifiedToCreateGroupBuyRecord")
public CommonResult isQualifiedToCreateGroupBuyRecord(@NotNull @RequestParam Long userId,
                                                      @NotNull @RequestParam Long ruleId){
    GroupBuyQualificationResult result = portalGroupBuyService.isQualifiedToCreateGroupBuyRecord(userId, ruleId);
    if (!result.isQualified()) {
        return CommonResult.failed(result, "没有资格发起团购:" + result.getFailMessage());
    }
    return CommonResult.success(result, "可以发起团购");
}
```

**服务层**

**判断是否有开团资格**

```java
@Override
public GroupBuyQualificationResult isQualifiedToCreateGroupBuyRecord(Long userId, Long ruleId)throws MallException {
    //检查团购规则状态
    GroupBuyQualificationResult firstResult = checkIfCanCreateGroupBuyRecord(ruleId);
    return firstResult;
}
```

```java
private GroupBuyQualificationResult checkIfCanCreateGroupBuyRecord(Long ruleId) throws MallException {
    GroupBuyRule groupBuyRule = groupBuyRuleMapper.selectByPrimaryKey(ruleId);
    Date now =new Date();
    if (groupBuyRule == null){
        return GroupBuyQualificationResult.fail("团购规则不存在");
    }
    if (GroupBuyRuleStatusEnum.DISABLE.getCode().equals(groupBuyRule.getStatus())){
        return GroupBuyQualificationResult.fail("团购规则已下架，不能发起团购");
    }
    //检查团购规则是否过期
    if (groupBuyRule.getStartTime().getTime() > now.getTime() || groupBuyRule.getEndTime().getTime() < now.getTime()){
        return GroupBuyQualificationResult.fail("团购规则已经过期，不能发起团购");
    }
    return GroupBuyQualificationResult.successWithRuleId(ruleId, groupBuyRule.getLimitNumber());
}
```

根据三点判断：

1. 规则是否存在
2. 团购规则是否上架
3. 团购规则是否过期

返回的结果包含：1. 规则id 2. 团购购买上限

#### 5. 查看是否能加入团购

```java
@ApiOperation("查看是否能加入团购")
@PostMapping(value = "/isQualifiedToJoinGroupBuyRecord")
public CommonResult isQualifiedToJoinGroupBuyRecord(@NotNull @RequestParam Long userId,
                                                    @NotNull @RequestParam Long recordId,
                                                    @NotNull @RequestParam Integer ruleLimitNumber){
    GroupBuyQualificationResult result = portalGroupBuyService.isQualifiedToJoinGroupBuyRecord(userId, recordId, ruleLimitNumber);
    if (!result.isQualified()) {
        return CommonResult.failed(result, "没有资格发起团购:" + result.getFailMessage());
    }
    return CommonResult.success(result, "可以加入团购");
}
```

**服务层**

```java
@Override
public GroupBuyQualificationResult isQualifiedToJoinGroupBuyRecord(Long userId, Long recordId, Integer ruleLimitNumber) {
    GroupBuyQualificationResult firstResult = checkIfCanJoinGroupBuyRecord(userId, recordId, ruleLimitNumber);
    return firstResult;
}
```

```java
private GroupBuyQualificationResult checkIfCanJoinGroupBuyRecord(Long userId, Long recordId, Integer limitNumber){
    GroupBuyRecord record = groupBuyRecordMapper.selectByPrimaryKey(recordId);
    if (record == null){
        return GroupBuyQualificationResult.fail( "团购记录不存在，不能参团");
    }
    Date now = new Date();
    if (record.getCurrentNumber() >= record.getSuccessNumber()){
        return GroupBuyQualificationResult.fail( "成团人数已满，不能参团");
    }
    if (now.getTime() > record.getExpireTime().getTime()){
        return GroupBuyQualificationResult.fail( "团购已经过期，不能参团");
    }
    if (!GroupBuyRecordStatusEnum.GROUP_BUY_PROCESSING.getCode().equals(record.getStatus())){
        return GroupBuyQualificationResult.fail( "团购状态不对，不能参团");
    }
    boolean isJoined = groupBuyOrderCustomMapper.checkIfJoinedGroupBuyRecord(recordId, userId) > 0 ;
    if (isJoined) {
        return GroupBuyQualificationResult.fail( "已经加入此次团购");
    }
    return GroupBuyQualificationResult.successWithRuleId(record.getGroupBuyRuleId(), limitNumber);
}
```

不能参团的原因有：

1. 团购记录不存在
2. 成团人数已满
3. 团购已经过期
4. 团购状态不对
5. 已经加入此次团购

#### 6. 查看团购详情

**接口**

```java
@ApiOperation("查看此次团购详情")
@PostMapping(value = "/getGroupBuyRecordDetailByRecordId")
public CommonResult getGroupBuyRecordDetailByRecordId(@NotNull @RequestParam Long recordId){
    GroupBuyRecordDetailVo groupBuyRecordDetailVo = portalGroupBuyService.getGroupBuyRecordDetailVoByRecordId(recordId);
    if (groupBuyRecordDetailVo == null) {
        return CommonResult.failed("获取团购订单信息失败");
    }
    return CommonResult.success(groupBuyRecordDetailVo, "获取团购订单信息成功");
}
```

**服务层**

```java
@Override
public GroupBuyRecordDetailVo getGroupBuyRecordDetailVoByRecordId(Long recordId){
    return groupBuyOrderCustomMapper.getGroupBuyRecordDetailVoByRecordId(recordId);
}
```

#### 7. 获取所有团购分类

**接口**

```java
@ApiOperation("获取所有团购分类")
@PostMapping(value = "/listGroupBuyCategoryVos")
public CommonResult listGroupBuyCategoryVos(@RequestParam(value="pageNum",defaultValue = "1") Integer pageNum,
                                            @RequestParam(value="size",defaultValue ="10") Integer size){
    CommonPage<GroupBuyCategoryVo> groupBuyCategoryVos = portalGroupBuyService.listGroupBuyCategoryVos(pageNum, size);
    if (groupBuyCategoryVos == null) {
        return CommonResult.failed("获取团购分类失败或者分类不存在");
    }
    return CommonResult.success(groupBuyCategoryVos,"获取团购分类成功");
}
```

**服务层**

```java
@Override
public CommonPage<GroupBuyCategoryVo> listGroupBuyCategoryVos(Integer pageNum, Integer size) {
    PageHelper.startPage(pageNum, size);
    GroupBuyCategoryExample groupBuyCategoryExample = new GroupBuyCategoryExample();
    groupBuyCategoryExample.setOrderByClause("sort");
    groupBuyCategoryExample.createCriteria().andStatusEqualTo(1).andIsDeletedEqualTo(0);
    List<GroupBuyCategory> groupBuyCategoryList = groupBuyCategoryMapper.selectByExample(groupBuyCategoryExample);
    List<GroupBuyCategoryVo> groupBuyCategoryVoList = groupBuyCategoryList.stream().map(this::transCategory2Vo).collect(Collectors.toList());
    return CommonPage.restPage(groupBuyCategoryVoList);
}
```

利用example查询并转换为vo

#### 8. 根据团购规则id获取团购规则详情

**接口**

```java
@ApiOperation("根据团购规则id获取团购规则详情")
@PostMapping(value = "/getGroupBuyRuleVosByRuleId")
public CommonResult getGroupBuyRuleDetailVosByRuleId(@NotNull @RequestParam Long ruleId){
    GroupBuyRuleDetailVo groupBuyRuleDetailVo = portalGroupBuyService.getGroupBuyRuleDetailVosByRuleId(ruleId);
    if (groupBuyRuleDetailVo == null) {
        return CommonResult.failed("获取团购规则失败或者规则不存在");
    }
    return CommonResult.success(groupBuyRuleDetailVo,"获取团购规则成功");
}
```

**服务层**

```java
@Override
public GroupBuyRuleDetailVo getGroupBuyRuleDetailVosByRuleId(Long ruleId) {
    return groupBuyRuleCustomMapper.getRuleDetailVoByPrimaryKey(ruleId);
}
```

#### 9. 根据团购分类id获取团购规则

**接口**

```java
@ApiOperation("根据团购分类id获取团购规则")
@PostMapping(value = "/listGroupBuyRuleVosByCategoryId")
public CommonResult listGroupBuyRuleVosByCategoryId(@NotNull @RequestParam Long categoryId,
                                                    @RequestParam(value="pageNum",defaultValue = "1") Integer pageNum,
                                                    @RequestParam(value="size",defaultValue ="10") Integer size){
    CommonPage<GroupBuyRuleVo> groupBuyRuleVos = portalGroupBuyService.listGroupBuyRuleVosByCategoryId(categoryId, pageNum, size);
    if (groupBuyRuleVos == null) {
        return CommonResult.failed("获取团购规则详情失败或者规则不存在");
    }
    return CommonResult.success(groupBuyRuleVos,"获取团购规则成功");
}
```

**服务层**

```java
@Override
public CommonPage<GroupBuyRuleVo> listGroupBuyRuleVosByCategoryId(Long categoryId, Integer pageNum, Integer size) {
    PageHelper.startPage(pageNum, size);
    List<GroupBuyRuleVo> groupBuyRuleVoList = groupBuyRuleCustomMapper.listGroupBuyRuleVoByCategoryId(categoryId);
    return CommonPage.restPage(groupBuyRuleVoList);
}
```

#### 10. 根据用户id和记录状态来获取团购记录

**接口**

```java
@ApiOperation("根据用户id和记录状态来获取团购记录")
@PostMapping(value = "/getGroupBuyRecordVosByUserIdAndRecordStatus")
public CommonResult getGroupBuyRecordVosByUserIdAndRecordStatus(@RequestParam(value="pageNum",defaultValue = "1") Integer pageNum,
                                                                @RequestParam(value="size",defaultValue ="10") Integer size,
                                                                @NotNull @RequestParam Long userId,
                                                                @RequestParam(required = false) Integer status,
                                                                @RequestParam(required = false) Integer userType){
    CommonPage<GroupBuyRecordVo> groupBuyRecordVoCommonPage = groupBuyOrderService.getGroupBuyRecordVosByUserIdAndRecordStatusAndUserType(pageNum, size, userId, status, userType);
    return CommonResult.success(groupBuyRecordVoCommonPage);
}
```

**服务层**

```java
@Override
public CommonPage<GroupBuyRecordVo> getGroupBuyRecordVosByUserIdAndRecordStatusAndUserType(Integer pageNum, Integer size, Long userId, Integer status, Integer userType) {
    PageHelper.startPage(pageNum, size);
    List<GroupBuyRecordVo> groupBuyRecordVos = groupBuyOrderCustomMapper.getGroupBuyRecordVosByUserIdAndRecordStatusAndUserType(userId, status, userType);//usertype没有用上
    return CommonPage.restPage(groupBuyRecordVos);
}
```

根据用户id，记录状态（拼团中、拼团成功、拼团失败）来查询

#### 11. 根据ruleId来获取正在进行的团购

**接口**

```java
@ApiOperation("根据ruleId来获取正在进行的团购")
@PostMapping(value = "/getGroupBuyRecordVoProcessingByRuleId")
public CommonResult getGroupBuyRecordVoProcessingByRuleId(@RequestParam(value="pageNum",defaultValue = "1") Integer pageNum,
                                                          @RequestParam(value="size",defaultValue ="10") Integer size,
                                                          @NotNull @RequestParam Long ruleId,
                                                          @NotNull @RequestParam Integer status){
    CommonPage<GroupBuyRecordVo> groupBuyRecordVoCommonPage = groupBuyOrderService.getGroupBuyRecordProcessingVos(pageNum, size, ruleId, status);
    return CommonResult.success(groupBuyRecordVoCommonPage);
}
```

**服务层**

```java
@Override
public CommonPage<GroupBuyRecordVo> getGroupBuyRecordProcessingVos(Integer pageNum, Integer size, Long ruleId, Integer status) {
    PageHelper.startPage(pageNum, size);
    List<GroupBuyRecordVo> groupBuyRecordVos = groupBuyOrderCustomMapper.getGroupBuyRecordVosByRuleIdAndStatus(ruleId, status);
    return CommonPage.restPage(groupBuyRecordVos);
}
```

#### 12. 根据recordId和userId来获取订单详情

**接口**

```java
@ApiOperation("根据recordId和userId来获取订单详情")
@PostMapping(value = "/getGroupBuyOrderVoByRecordIdAndUserId")
public CommonResult getGroupBuyOrderVoByRecordIdAndUserId(@NotNull @RequestParam Long recordId,
                                                          @NotNull @RequestParam Long userId){
    return CommonResult.success(groupBuyOrderService.getGroupBuyOrderVoByRecordIdAndUserId(recordId, userId));
}
```

**服务层**

```java
@Override
public GroupBuyOrderVo getGroupBuyOrderVoByRecordIdAndUserId(Long recordId, Long userId) {
    return groupBuyOrderCustomMapper.getGroupBuyOrderVoByRecordIdAndUserId(recordId, userId);
}
```

#### 13. 获取商品分类

**接口**

```java
@ApiOperation("获取商品分类")
@PostMapping(value = "/listProductCategoryVos")
public CommonResult listProductCategoryVos(){
    return CommonResult.success(portalGroupBuyService.listProductCategoryVos(), "获取商品分类成功");
}
```

**服务层**

```java
@Override
public List<ProductCategoryVo> listProductCategoryVos() {
    List<ProductCategory> categoryList = productCategoryMapper.selectByExample(new ProductCategoryExample());
    List<ProductCategoryVo> categoryVoList = categoryList.stream().map(productCategory -> {
        ProductCategoryVo productCategoryVo = new ProductCategoryVo();
        BeanUtils.copyProperties(productCategory, productCategoryVo);
        return productCategoryVo;
    }).collect(Collectors.toList());
    return categoryVoList;
}
```

通过流转换为vo

#### 14. 根据商品分类获取团购规则

**接口**

```java
@ApiOperation("根据商品分类获取团购规则")
@PostMapping(value = "/listGroupBuyRuleVosByProductCategory")
public CommonResult listGroupBuyRuleVosByProductCategory(@NotNull @RequestParam Long productCategoryId){
    return CommonResult.success(portalGroupBuyService.listGroupBuyRuleVosByProductCategory(productCategoryId), "获取团购规则成功");
}
```

**服务层**

```java
@Override
public List<GroupBuyRuleVo> listGroupBuyRuleVosByProductCategory(Long categoryId) {
    return groupBuyRuleCustomMapper.listGroupBuyRuleVosByProductCategory(categoryId);
}
```

#### 15. 根据商品名称来搜索团购规则

**接口**

```java
@ApiOperation("根据商品名称来搜索团购规则")
@PostMapping(value = "/getGroupBuyRuleVoBySearchingName")
public CommonResult getGroupBuyRuleVoBySearchingName(@RequestParam String productName){
    return CommonResult.success(portalGroupBuyService.getGroupBuyRuleVoBySearchingName(productName), "获取团购规则成功");
}
```

**服务层**

```java
@Override
public List<GroupBuyRuleVo> getGroupBuyRuleVoBySearchingName(String productName) {
    return groupBuyRuleCustomMapper.getGroupBuyRuleVoBySearchingName(productName);
}
```

### 3.6 异步服务

#### 1. 成功完成团购

```java
@Async
@Transactional
public void SuccessGroupBuyOrder(Long groupBuyRecordId){
    log.info("团购号{}完成团购",groupBuyRecordId);
    //结束此次团购记录
    Date now = new Date();
    GroupBuyRecord record = groupBuyRecordMapper.selectByPrimaryKey(groupBuyRecordId);
    record.setEndTime(now);
    record.setUpdateTime(now);
    record.setStatus(GroupBuyRecordStatusEnum.GROUP_BUY_SUCCESS.getCode());
    groupBuyRecordMapper.updateByPrimaryKeySelective(record);
    groupBuyRuleCustomMapper.updateSuccessGroupBuyCount(record.getGroupBuyRuleId());
    //修改每个用户的订单状态
    GroupBuyRecordUserExample RecordUserExample = new GroupBuyRecordUserExample();
    RecordUserExample.createCriteria().andRecordIdEqualTo(groupBuyRecordId);
    List<GroupBuyRecordUser> userList = groupBuyRecordUserMapper.selectByExample(RecordUserExample);
    List<String> orderNoList = userList.stream().map(GroupBuyRecordUser::getOrderId).collect(Collectors.toList());
    GroupBuyOrderExample orderExample = new GroupBuyOrderExample();
    orderExample.createCriteria().andOrderNoIn(orderNoList);
    List<GroupBuyOrder> orderList = groupBuyOrderMapper.selectByExample(orderExample);
    //更新团购订单为待发货
    orderList.forEach(order ->{
        log.info("订单号{}修改为待发货", order.getOrderNo());
        GroupBuyOrder e = new GroupBuyOrder();
        e.setOrderNo(order.getOrderNo());
        e.setOrderStatus(OrderStatusEnum.NOT_SHIPPED.getCode());
        e.setUpdateTime(now);
        groupBuyOrderMapper.updateByPrimaryKeySelective(e);
        groupBuyRuleCustomMapper.updateUserRuleCount(order.getUserId(), record.getGroupBuyRuleId());
    });
}
```

流程：

1. 更新团购记录：结束时间、更新时间、记录状态
2. 更新团购规则表：成功团数（有助于评价团购规则的好坏）
3. 修改每个用户的订单：订单状态、更新时间
4. 更新用户-规则表：更新成功次数（有助于评价不同用户对不同规则的偏好）

#### 2. 处理过期团购

```java
@Async
@Scheduled(cron = "0 0/1 * * * ? ")
@Transactional
public void processExpireGroupBuyOrder() {
    List<GroupBuyRecord> expireGroupBuyRecords = groupBuyOrderCustomMapper.getExpireGroupBuyOrders();
    if (CollectionUtils.isNotEmpty(expireGroupBuyRecords)) {
        log.info("***********开始处理过期但没有成功的团购**********");
        expireGroupBuyRecords.forEach(record -> {
            log.info("团购记录号{}", record.getId());
            GroupBuyRecordUserExample RecordUserExample = new GroupBuyRecordUserExample();
            RecordUserExample.createCriteria().andRecordIdEqualTo(record.getId());
            List<GroupBuyRecordUser> userList = groupBuyRecordUserMapper.selectByExample(RecordUserExample);//团购记录-用户表包含记录id、用户id、订单id
            List<String> orderNoList = userList.stream().map(GroupBuyRecordUser::getOrderId).collect(Collectors.toList());
            GroupBuyOrderExample orderExample = new GroupBuyOrderExample();
            orderExample.createCriteria().andOrderNoIn(orderNoList);
            List<GroupBuyOrder> orderList = groupBuyOrderMapper.selectByExample(orderExample);
            //更新团购订单为待发货
            orderList.forEach(order -> {
                log.info("订单号{}修改为待发货", order.getOrderNo());
                GroupBuyOrder e = new GroupBuyOrder();
                e.setOrderNo(order.getOrderNo());
                e.setOrderStatus(OrderStatusEnum.NOT_SHIPPED.getCode());
                e.setUpdateTime(record.getExpireTime());
                groupBuyOrderMapper.updateByPrimaryKeySelective(e);
                //                    groupBuyRuleCustomMapper.updateUserRuleCount(order.getUserId(), record.getGroupBuyRuleId());
            });
            //机器人拼单
            int lackPeopleCount = record.getSuccessNumber() - userList.size();
            robotJoinRecord(lackPeopleCount, record.getId());
            //结束此次团购记录
            record.setEndTime(record.getExpireTime());
            record.setUpdateTime(record.getExpireTime());
            record.setCurrentNumber(record.getSuccessNumber());
            record.setStatus(GroupBuyRecordStatusEnum.GROUP_BUY_SUCCESS.getCode());
            groupBuyRecordMapper.updateByPrimaryKeySelective(record);
            groupBuyRuleCustomMapper.updateSuccessGroupBuyCount(record.getGroupBuyRuleId());
        });
    }
}
```

**@Schedule的使用**：详细可查看https://blog.csdn.net/m0_37179470/article/details/81271607

```java
@Schedule(cron = {秒数} {分钟} {小时} {日期} {月份} {星期} {年份(可为空)})
```

*：表示“每”的意思

A/B：表示从A开始每隔B触发一次

这里的@Scheduled(cron = "0 0/1 * * * ? ")表示每个小时从0分开始，每隔1分钟触发一次，也就是每分钟触发一次

通过定时功能执行无人值守的自动处理

流程：

1. 通过sql的NOW()函数，查询过期的团购记录
2. 找到和团购记录相关的团购订单号
3. 更新订单：订单状态改为待发货、更新时间改为过期时间
4. 使用机器人补上团购记录缺的人数
5. 更新团购记录：

查询过期记录的sql：

```sql
<select id="getExpireGroupBuyOrders" resultMap="edu.whut.mall.mapper.GroupBuyRecordMapper.BaseResultMap">
    select
    <include refid="edu.whut.mall.mapper.GroupBuyRecordMapper.Base_Column_List"></include>
    from group_buy_record
    where NOW() > expire_time and status = 0 and is_deleted = 0;
</select>
```

#### 3. 机器人拼团

```java
/**
 * 机器人拼团
 * @param lackPeopleCount 差的人数
 * @return
 */
private void robotJoinRecord(Integer lackPeopleCount, Long recordId) {
    int totalCount = robotCustomMapper.countAllRobots();
    int offset = new Random().nextInt(totalCount - lackPeopleCount - 1);
    List<Robot> robotList = robotCustomMapper.selectSpecificQuantityRobots(offset, lackPeopleCount);
    List<GroupBuyRecordUser> robotRecordUser = new ArrayList<>(robotList.size());
    int index = 0;
    for (Robot robot : robotList) {
        GroupBuyRecordUser groupBuyRecordUser = new GroupBuyRecordUser();
        groupBuyRecordUser.setRecordId(recordId);
        groupBuyRecordUser.setUsername(robot.getRobotName());
        groupBuyRecordUser.setUserPic(robot.getRobotPic());
        groupBuyRecordUser.setUserType(GroupBuyUserTypeEnum.GROUP_BUY_JOIN.getCode());
        groupBuyRecordUser.setOrderId("robotOrderId--" + index ++);
        robotRecordUser.add(groupBuyRecordUser);
    }
    robotCustomMapper.batchInsertRobot(robotRecordUser);
}
```

流程：

1. 根据团购记录缺的人数随机从数据库中抽取一个机器人列表
2. 根据机器人信息创建虚假的团购记录-用户记录
3. 批量插入团购记录-用户表中

### 3.6 实体类

#### 1. 用户

```java
public class User implements Serializable {
    private Long id;

    /**
     * 姓名
     */
    private String username;

    /**
     * 密码
     */
    private String password;

    /**
     * 姓名
     */
    private String nickname;

    /**
     * 创建时间
     */
    private Date createTime;

    /**
     * 手机号
     */
    private String phone;

    /**
     * 头像
     */
    private String picture;

    /**
     * 用户类型
     */
    private Integer userType;

    /**
     * 用户状态
     */
    private Integer status;

    /**
     * openId
     */
    private String openId;

    /**
     * 更新时间
     */
    private Date updateTime;

    /**
     * 备注
     */
    private String remark;

    /**
     * 是否删除
     */
    private Integer isDeleted;

    private static final long serialVersionUID = 1L;
}
```

#### 2. 收货地址

```java
public class Shipping implements Serializable {
    private Long id;

    /**
     * 用户id
     */
    private Long userId;

    /**
     * 收货人姓名
     */
    private String receiveName;

    /**
     * 收货人手机
     */
    private String receivePhone;

    /**
     * 城市
     */
    private String receiveCity;

    /**
     * 省份
     */
    private String receiveProvince;

    /**
     * 详细地址
     */
    private String receiveAddress;

    /**
     * 创建时间
     */
    private Date createTime;

    /**
     * 修改时间
     */
    private Date updateTime;

    /**
     * 是否默认地址
     */
    private Integer isMain;

    /**
     * 区/县
     */
    private String receiveZone;

    private static final long serialVersionUID = 1L;
}
```

#### 3. 商家支付密钥

```java
@Data
public class MerchantPayInfo {
    /**
     * 商家的appId
     */
    private String platformId;
    /**
     * 和支付平台对接的密钥
     */
    private String platformKey;

    /**
     * 金钱流向
     */
    private Integer proceedsFlowDirection;
}
```

### 3.7 展示层

#### 1. 团购订单展示层

```java
public class GroupBuyOrderVo extends GroupBuyOrder {

    private ProductDetailVo productDetailVo;

}
```

除了订单信息还需要展示产品

#### 2. 产品展示层

```java
public class ProductDetailVo extends Product {
    private Merchant merchant;

    private List<ProductImage> productImageList;

}
```

除了产品信息还包括商家和图片

### 3.8 枚举类

#### 1. 支付状态枚举

```java
@Getter
public enum PaymentStatusEnum {
    NO_PAY(1, "未支付"), PAID(2, "已支付"), CANCLE(3, "已取消"), WAIT_REFUND(4, "待退款"),
    REFUNDED(5, "已退款"), REJECT_REFUND(6, "拒绝退款");
    private Integer code;
    private String desc;
}
```

### 3.9 配置类

#### 1. 异步处理配置类

```java
@Configuration
@EnableAsync
@EnableScheduling
public class AsyncTaskConfig implements AsyncConfigurer {
    @Override
    public Executor getAsyncExecutor() {
        /*execute(Runable)方法执行过程
        如果此时线程池中的数量小于corePoolSize，即使线程池中的线程都处于空闲状态，也要创建新的线程来处理被添加的任务。
        如果此时线程池中的数量等于 corePoolSize，但是缓冲队列 workQueue未满，那么任务被放入缓冲队列。
        如果此时线程池中的数量大于corePoolSize，缓冲队列workQueue满，并且线程池中的数量小于maxPoolSize，建新的线程来处理被添加的任务。
        如果此时线程池中的数量大于corePoolSize，缓冲队列workQueue满，并且线程池中的数量等于maxPoolSize，那么通过handler所指定的策略来处理此任务。也就是：处理任务的优先级为：核心线程corePoolSize、任务队列workQueue、最大线程 maximumPoolSize，如果三者都满了，使用handler处理被拒绝的任务。
        当线程池中的线程数量大于corePoolSize时，如果某线程空闲时间超过keepAliveTime，线程将被终止。这样，线程池可以动态的调整池中的线程数。
        */
        // 配置类实现AsyncConfigurer接口并重写 getAsyncExecutor 方法,并返回一个 ThreadPoolTaskExecutor,这样我们就获得了一个线程池 taskExecutor
        ThreadPoolTaskExecutor taskExecutor = new ThreadPoolTaskExecutor();
        taskExecutor.setCorePoolSize(5);//线程池维护线程的最小数量
        taskExecutor.setMaxPoolSize(10);//线程池维护线程的最大数量
        taskExecutor.setQueueCapacity(25);//缓存队列
        taskExecutor.initialize();
        
        return taskExecutor;
    }

    @Override
    public AsyncUncaughtExceptionHandler getAsyncUncaughtExceptionHandler() {
        return new SimpleAsyncUncaughtExceptionHandler();
    }

}
```

## 4. 通用模块-common

### 4.1 common-api

#### 4.1.1 通用返回类

**基本结构：**

```java
public class CommonResult<T> {
    private long code;
    private String message;
    private T data;

    protected CommonResult() {
    }

    protected CommonResult(long code, String message, T data) {
        this.code = code;
        this.message = message;
        this.data = data;
    }
}
```

| 属性           | 描述       |
| -------------- | ---------- |
| long code      | 返回状态码 |
| String message | 返回信息   |
| T data         | 返回数据   |

通过一个泛型类实现通用的返回值

**特别状态方法：**

**成功**

```java
public static <T> CommonResult<T> success(参数列表) {
        return new CommonResult<T>(成功状态码, message, data);
    }
```

**失败**

```java
public static <T> CommonResult<T> failed(参数列表) {
        return new CommonResult<T>(失败状态码, message, data);
    }
```

**验证失败**

```java
public static <T> CommonResult<T> validateFailed(参数列表) {
        return new CommonResult<T>(验证失败状态码, message, data);
    }
```

**未登录**

```java
public static <T> CommonResult<T> unauthorized(T data) {
        return new CommonResult<T>(未登录状态码, 未登录消息, data);
    }
```

**未授权**

```java
public static <T> CommonResult<T> forbidden(T data) {
        return new CommonResult<T>(未授权状态码, 未授权消息, data);
    }
```



#### 4.1.2 通用枚举类

```java
public enum ResultCode {
    SUCCESS(200, "操作成功"),
    FAILED(500, "操作失败"),
    VALIDATE_FAILED(404, "参数检验失败"),
    UNAUTHORIZED(401, "暂未登录或token已经过期"),
    FORBIDDEN(403, "没有相关权限");
    private long code;
    private String message;

    private ResultCode(long code, String message) {
        this.code = code;
        this.message = message;
    }

    public long getCode() {
        return code;
    }

    public String getMessage() {
        return message;
    }
}
```

| 状态            | 状态码 | 消息                    |
| --------------- | ------ | ----------------------- |
| SUCCESS         | 200    | 操作成功                |
| FAILED          | 500    | 操作失败                |
| VALIDATE_FAILED | 404    | 参数校验失败            |
| UNAUTHORIZED    | 401    | 暂未登录或token已经过期 |
| FORBIDDEN       | 403    | 没有相关权限            |



#### 4.1.3 通用分页类

```java
public class CommonPage<T> {
    private Integer pageNum;
    private Integer pageSize;
    private Integer totalPage;
    private Long total;
    private List<T> list;

    /**
     * 将PageHelper分页后的list转为分页信息
     */
    public static <T> CommonPage<T> restPage(List<T> list) {
        CommonPage<T> result = new CommonPage<T>();
        PageInfo<T> pageInfo = new PageInfo<T>(list);
        result.setTotalPage(pageInfo.getPages());
        result.setPageNum(pageInfo.getPageNum());
        result.setPageSize(pageInfo.getPageSize());
        result.setTotal(pageInfo.getTotal());
        result.setList(pageInfo.getList());
        return result;
    }
}
```

| 属性              | 描述     |
| ----------------- | -------- |
| Integer  pageNum  | 页数     |
| Integer pageSize  | 页大小   |
| Integer totalPage | 总页数   |
| Long total        | 总记录数 |
| List\<T> list     | 内容     |

使用示例：

```java
//1. 设置分页信息
PageHelper.startPage(pageNum, size);
//2. 进行查询，pageHelper会对返回结果进行拦截处理
List<User> userList = userMapper.getAllUsers();
//3. 装配到分页类中
CommonPage<User> usersPage = CommonPage.restPage(userList);
```

### 4.2 工具类

#### 1 请求工具类

```java
public static String doGet(String url, Map<String, String> param) throws KeyStoreException, NoSuchAlgorithmException, KeyManagementException {

        // 创建Httpclient对象
//        CloseableHttpClient httpclient = HttpClients.createDefault();

        SSLContext sslContext = SSLContexts.custom().loadTrustMaterial(new TrustAllStrategy()).build();
        SSLConnectionSocketFactory sslConnectionSocketFactory = new SSLConnectionSocketFactory(sslContext, new String[]{"TLSv1"}, null, SSLConnectionSocketFactory.getDefaultHostnameVerifier() );
        CloseableHttpClient httpclient = HttpClients.custom().setSSLSocketFactory(sslConnectionSocketFactory).build();

        String resultString = "";
        CloseableHttpResponse response = null;
        try {
            // 创建uri
            URIBuilder builder = new URIBuilder(url);
            if (param != null) {
                for (String key : param.keySet()) {
                    builder.addParameter(key, param.get(key));
                }
            }
            URI uri = builder.build();

            // 创建http GET请求
            HttpGet httpGet = new HttpGet(uri);

            // 执行请求
            response = httpclient.execute(httpGet);
            // 判断返回状态是否为200
            if (response.getStatusLine().getStatusCode() == 200) {
                resultString = EntityUtils.toString(response.getEntity(), "UTF-8");
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try {
                if (response != null) {
                    response.close();
                }
                httpclient.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
        return resultString;
    }

    public static String doGet(String url) throws NoSuchAlgorithmException, KeyStoreException, KeyManagementException {
        return doGet(url, null);
    }

    public static String doPost(String url, Map<String, String> param) {
        // 创建Httpclient对象
        CloseableHttpClient httpClient = HttpClients.createDefault();
        CloseableHttpResponse response = null;
        String resultString = "";
        try {
            // 创建Http Post请求
            HttpPost httpPost = new HttpPost(url);
            // 创建参数列表
            if (param != null) {
                List<NameValuePair> paramList = new ArrayList<>();
                for (String key : param.keySet()) {
                    paramList.add(new BasicNameValuePair(key, param.get(key)));
                }
                // 模拟表单
                UrlEncodedFormEntity entity = new UrlEncodedFormEntity(paramList);
                httpPost.setEntity(entity);
            }
            // 执行http请求
            response = httpClient.execute(httpPost);
            resultString = EntityUtils.toString(response.getEntity(), "utf-8");
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try {
                response.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }

        return resultString;
    }

    public static String doPost(String url) {
        return doPost(url, null);
    }

    public static String doPostJson(String url, String json) {
        // 创建Httpclient对象
        CloseableHttpClient httpClient = HttpClients.createDefault();
        CloseableHttpResponse response = null;
        String resultString = "";
        try {
            // 创建Http Post请求
            HttpPost httpPost = new HttpPost(url);
            // 创建请求内容
            StringEntity entity = new StringEntity(json, ContentType.APPLICATION_JSON);
            httpPost.setEntity(entity);
            // 执行http请求
            response = httpClient.execute(httpPost);
            resultString = EntityUtils.toString(response.getEntity(), "utf-8");
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try {
                response.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }

        return resultString;
    }
}
```

#### 2 session加密工具

```java
public class EncryptUtil {


    // 字符串默认键值
    private static String strDefaultKey = "inventec2020@#$%^&";

    //加密工具
    private Cipher encryptCipher = null;

    // 解密工具
    private Cipher decryptCipher = null;

    /**
     * 默认构造方法，使用默认密钥
     */
    public EncryptUtil() throws Exception {
        this(strDefaultKey);
    }

    /**
     * 指定密钥构造方法
     * @param strKey 指定的密钥
     * @throws Exception
     */

    public EncryptUtil(String strKey) throws Exception {

        // Security.addProvider(new com.sun.crypto.provider.SunJCE());
        Key key = getKey(strKey.getBytes());
        encryptCipher = Cipher.getInstance("DES");
        encryptCipher.init(Cipher.ENCRYPT_MODE, key);
        decryptCipher = Cipher.getInstance("DES");
        decryptCipher.init(Cipher.DECRYPT_MODE, key);
    }

    /**
     * 将byte数组转换为表示16进制值的字符串， 如：byte[]{8,18}转换为：0813，和public static byte[]
     *
     * hexStr2ByteArr(String strIn) 互为可逆的转换过程
     *
     * @param arrB 需要转换的byte数组
     * @return 转换后的字符串
     * @throws Exception  本方法不处理任何异常，所有异常全部抛出
     */
    public static String byteArr2HexStr(byte[] arrB) throws Exception {
        int iLen = arrB.length;
        // 每个byte用2个字符才能表示，所以字符串的长度是数组长度的2倍
        StringBuffer sb = new StringBuffer(iLen * 2);
        for (int i = 0; i < iLen; i++) {
            int intTmp = arrB[i];
            // 把负数转换为正数
            while (intTmp < 0) {
                intTmp = intTmp + 256;
            }
            // 小于0F的数需要在前面补0
            if (intTmp < 16) {
                sb.append("0");
            }
            sb.append(Integer.toString(intTmp, 16));
        }
        return sb.toString();
    }

    /**
     * 将表示16进制值的字符串转换为byte数组，和public static String byteArr2HexStr(byte[] arrB)
     * 互为可逆的转换过程
     * @param strIn 需要转换的字符串
     * @return 转换后的byte数组
     */
    public static byte[] hexStr2ByteArr(String strIn) throws Exception {
        byte[] arrB = strIn.getBytes();
        int iLen = arrB.length;
        // 两个字符表示一个字节，所以字节数组长度是字符串长度除以2
        byte[] arrOut = new byte[iLen / 2];
        for (int i = 0; i < iLen; i = i + 2) {
            String strTmp = new String(arrB, i, 2);
            arrOut[i / 2] = (byte) Integer.parseInt(strTmp, 16);
        }
        return arrOut;
    }

    /**
     *
     * 加密字节数组
     * @param arrB 需加密的字节数组
     * @return 加密后的字节数组
     */
    public byte[] encrypt(byte[] arrB) throws Exception {
        return encryptCipher.doFinal(arrB);
    }

    /**
     * 加密字符串
     * @param strIn 需加密的字符串
     * @return 加密后的字符串
     */
    public String encrypt(String strIn) throws Exception {
        return byteArr2HexStr(encrypt(strIn.getBytes()));
    }

    /**
     * 解密字节数组
     * @param arrB 需解密的字节数组
     * @return 解密后的字节数组
     */
    public byte[] decrypt(byte[] arrB) throws Exception {
        return decryptCipher.doFinal(arrB);
    }

    /**
     * 解密字符串
     * @param strIn 需解密的字符串
     * @return 解密后的字符串
     */
    public String decrypt(String strIn) throws Exception {
        return new String(decrypt(hexStr2ByteArr(strIn)));
    }

    /**
     * 从指定字符串生成密钥，密钥所需的字节数组长度为8位 不足8位时后面补0，超出8位只取前8位
     * @param arrBTmp 构成该字符串的字节数组
     * @return 生成的密钥
     */
    private Key getKey(byte[] arrBTmp) throws Exception {
        // 创建一个空的8位字节数组（默认值为0）
        byte[] arrB = new byte[8];
        // 将原始字节数组转换为8位
        for (int i = 0; i < arrBTmp.length && i < arrB.length; i++) {
            arrB[i] = arrBTmp[i];
        }
        // 生成密钥
        Key key = new javax.crypto.spec.SecretKeySpec(arrB, "DES");
        return key;
    }

}
```

#### 3 微信加密信息解密工具

```java
public class WxUserOpenInfoDecodeUtil {

    public static JSONObject getUserInfo(String encryptedData,String sessionKey,String iv){
        // 被加密的数据
        byte[] dataByte = Base64.decode(encryptedData);
        // 加密秘钥
        byte[] keyByte = Base64.decode(sessionKey);
        // 偏移量
        byte[] ivByte = Base64.decode(iv);
        try {
            // 如果密钥不足16位，那么就补足.  这个if 中的内容很重要
            int base = 16;
            if (keyByte.length % base != 0) {
                int groups = keyByte.length / base + (keyByte.length % base != 0 ? 1 : 0);
                byte[] temp = new byte[groups * base];
                Arrays.fill(temp, (byte) 0);
                System.arraycopy(keyByte, 0, temp, 0, keyByte.length);
                keyByte = temp;
            }
            // 初始化
            Security.addProvider(new BouncyCastleProvider());
            Cipher cipher = Cipher.getInstance("AES/CBC/PKCS7Padding","BC");
            SecretKeySpec spec = new SecretKeySpec(keyByte, "AES");
            AlgorithmParameters parameters = AlgorithmParameters.getInstance("AES");
            parameters.init(new IvParameterSpec(ivByte));
            cipher.init(Cipher.DECRYPT_MODE, spec, parameters);// 初始化
            byte[] resultByte = cipher.doFinal(dataByte);
            if (null != resultByte && resultByte.length > 0) {
                String result = new String(resultByte, "UTF-8");
                return JSONObject.fromObject(result);
            }
        }catch (NoSuchProviderException e) {
            e.printStackTrace();
        } catch (NoSuchAlgorithmException e) {
            e.printStackTrace();
        } catch (BadPaddingException e) {
            e.printStackTrace();
        } catch (InvalidKeyException e) {
            e.printStackTrace();
        } catch (InvalidAlgorithmParameterException e) {
            e.printStackTrace();
        } catch (NoSuchPaddingException e) {
            e.printStackTrace();
        } catch (InvalidParameterSpecException e) {
            e.printStackTrace();
        } catch (IllegalBlockSizeException e) {
            e.printStackTrace();
        } catch (UnsupportedEncodingException e) {
            e.printStackTrace();
        }
        return null;

    }
}
```

### 4.3 DTO

#### 1. 团购参与资格DTO

```java
public class GroupBuyQualificationResult {

    private boolean qualified;

    private int buyCount;

    private Long groupBuyRuleId;

    private Integer ruleLimitNumber;

    private String failMessage;

   private GroupBuyQualificationResult(boolean qualified, int buyCount, String failMessage) {
        this.qualified = qualified;
        this.buyCount = buyCount;
        this.failMessage = failMessage;
    }

    public GroupBuyQualificationResult(boolean qualified, int buyCount, Long groupBuyRuleId, String failMessage, Integer ruleLimitNumber) {
        this.qualified = qualified;
        this.buyCount = buyCount;
        this.groupBuyRuleId = groupBuyRuleId;
        this.failMessage = failMessage;
        this.ruleLimitNumber = ruleLimitNumber;
    }

    public boolean isQualified() {
        return qualified;
    }

    public static GroupBuyQualificationResult successWithCount(int count){
        return new GroupBuyQualificationResult(true, count,null);
    }
    public static GroupBuyQualificationResult successWithRuleId(Long ruleId, Integer ruleLimitNumber){
        return new GroupBuyQualificationResult(true, 0, ruleId, null, ruleLimitNumber);
    }

    public static GroupBuyQualificationResult fail(String failMessage){
       return new GroupBuyQualificationResult(false, 0, failMessage);
    }

}
```

### 4.4 文件上传模块

#### 1. 上传单个文件

**接口**

```java
@ApiOperation("用户上传单个文件")
@PostMapping(value = "/uploadFile")
public CommonResult uploadFile(MultipartFile file, HttpServletRequest request) throws Exception {
    FileVo fileVo = fdfsService.upload(file);
    return CommonResult.success(fileVo,"上传文件成功");
}
```

**服务层**

```java
@Override
public FileVo upload(MultipartFile file) throws Exception {
    String fileName = file.getOriginalFilename();
    log.info("上传文件：{}", fileName);
    String fileExtName = fileName.substring(fileName.lastIndexOf(".") + 1);
    StorePath storePath = fastFileStorageClient.uploadFile(file.getInputStream(), file.getSize(), fileExtName, null);
    String relativeAddress = storePath.getFullPath();
    return new FileVo(relativeAddress, getFileFullPath(relativeAddress));
}
```

```java
public static String getFileFullPath(String fileStorePath) {
    return FileConstant.fastDfsHost + fileStorePath;
}
```

上传成功后返回文件的相对路径，即group+storage路径，由getFileFullPath返回实际访问的url为：域名:端口/相对路径

### 4.5 vo

#### 1. 文件vo

```java
@Data
public class FileVo {
    private String tmpPath;
    private String fullPath;

    public FileVo(String tmpPath, String fullPath) {
        this.tmpPath = tmpPath;
        this.fullPath = fullPath;
    }
}
```

## 5. POJO-数据表实体类与数据层

### 5.1 数据表与实体类

（其他模块中叙述的实体类实际上也存放于此）

#### **1. sysLog 系统日志表**

```java
public class SysLog implements Serializable {

    private Integer id;

    private String description;//操作描述

    private String username;//操作人名称

    private Date startTime;

    private Integer spendTime;

    private String url;//请求地址

    private Object params;//请求参数

    private Object result;//结果
}
```

#### 2. 用户订单购买次数表

```java
public class UserGroupBuyRuleCount implements Serializable {
    private Long id;

    /**
     * 用户id
     */
    private Long userId;

    /**
     * 团购id
     */
    private Long groupBuyRuleId;

    /**
     * 参加某个团购规则id的次数
     */
    private Integer count;

    private Date createTime;

    private Date updateTime;

    private static final long serialVersionUID = 1L;
}
```

#### 3. 用户团购记录表

```java
public class GroupBuyRecordUser implements Serializable {
    private Long id;

    /**
     * 团购记录id
     */
    private Long recordId;

    /**
     * 用户id
     */
    private Long userId;

    /**
     * 用户姓名
     */
    private String username;

    /**
     * 用户头像
     */
    private String userPic;

    /**
     * 用户类型 0->发起者 1->参与者
     */
    private Integer userType;

    /**
     * 创建时间
     */
    private Date createTime;

    /**
     * 用户对应的订单id
     */
    private String orderId;

    private static final long serialVersionUID = 1L;
}
```

#### 4. 退款请求表

```java
public class RefundRequest implements Serializable {
    /**
     * 主键
     */
    private Long id;

    /**
     * 用户id
     */
    private Long userId;

    /**
     * 订单号
     */
    private String orderNo;

    /**
     * 产品id
     */
    private Long productId;

    /**
     * 退款金钱来源
     */
    private Integer refundSource;

    /**
     * 退款理由
     */
    private String reason;

    /**
     * 金额
     */
    private BigDecimal amount;

    /**
     * 退款状态
     */
    private Integer status;

    /**
     * 创建时间
     */
    private Date createTime;

    /**
     * 更新时间
     */
    private Date updateTime;

    /**
     * 是否删除
     */
    private Integer isDeleted;

    private static final long serialVersionUID = 1L;
}
```

## 6. 一些插件

### 6.1 pageHelper

**基本结构**

**包装类：**

```java
public class PageInfo<T> extends PageSerializable<T> {
    //当前页
    private int pageNum;
    //每页的数量
    private int pageSize;
    //当前页的数量
    private int size;

    //由于startRow和endRow不常用，这里说个具体的用法
    //可以在页面中"显示startRow到endRow 共size条数据"

    //当前页面第一个元素在数据库中的行号
    private int startRow;
    //当前页面最后一个元素在数据库中的行号
    private int endRow;
    //总页数
    private int pages;

    //前一页
    private int prePage;
    //下一页
    private int nextPage;

    //是否为第一页
    private boolean isFirstPage = false;
    //是否为最后一页
    private boolean isLastPage = false;
    //是否有前一页
    private boolean hasPreviousPage = false;
    //是否有下一页
    private boolean hasNextPage = false;
    //导航页码数
    private int navigatePages;
    //所有导航页号
    private int[] navigatepageNums;
    //导航条上的第一页
    private int navigateFirstPage;
    //导航条上的最后一页
    private int navigateLastPage;

    public PageInfo() {
    }

    /**
     * 包装Page对象
     *
     * @param list
     */
    public PageInfo(List<T> list) {
        this(list, 8);
    }
}
```

### 6.2 权限控制插件：Shiro

#### 6.2.1 DAO：Realm

**配置登录验证入口**

```java
protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException {
        //获取token，即前端传入的token
        String username = (String) authenticationToken.getPrincipal();
        SysUser sysUser = sysUserService.getUserByUsername(username); //用于校验账户密码
        ShiroSysUser cacheUser = userCustomMapper.getRedisCacheSysUserByUsername(username); //自定义需要的信息
        if (sysUser == null) {
            throw new UnknownAccountException("账号不存在！");
        }

        if (!SysStatusEnum.AVAILABLE.getCode().equals(sysUser.getStatus())) {
            throw new LockedAccountException("帐号已被锁定，禁止登录！");
        }

        return new SimpleAuthenticationInfo(// 返回后自动存于redis
                cacheUser,
                sysUser.getPassword(),
                getName()
        );

    }
```

| 参数                                    | 描述                                          |
| --------------------------------------- | --------------------------------------------- |
| AuthenticationToken authenticationToken | 用户提交的用于验证身份的表单 一般是账户和密码 |

该方法配置了登录验证的入口，shiro将其返回的结果与用户提交的表单进行匹配，如果匹配，shiro还会将info储存在session的缓存中

**权限获取入口**

```java
protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) {
        // 权限信息对象info,用来存放查出的用户的所有的角色（role）及权限（permission）
        SimpleAuthorizationInfo info = new SimpleAuthorizationInfo();
        ShiroSysUser user = (ShiroSysUser)principalCollection.getPrimaryPrincipal();
        //查出改用户对应的所有角色
        List<SysRole> roles = sysUserRoleService.listRolesByUserId(user.getAdminId());
        //查出用户所对应的角色
        List<SysResources> resourcesList = sysResourcesService.listResourcesByUserId(user.getAdminId());
        //添加到授权信息中
        roles.forEach(role -> {
            info.addRole(role.getName());
        });
        if (!CollectionUtils.isEmpty(resourcesList)) {
            Set<String> permissionSet = new HashSet<>();
            for (SysResources resources : resourcesList) {
                if (!StringUtils.isEmpty(resources.getPermission())) {//
                    permissionSet.add(resources.getPermission());
                }
            }
            info.setStringPermissions(permissionSet);
        }
        return info;
    }
```

| 参数                                    | 描述               |
| --------------------------------------- | ------------------ |
| PrincipalCollection principalCollection | 一般场景下代表用户 |

在登录过程中就会自动调用该方法，该方法通过自定的DAO方法查询该用户对应的角色和资源

#### 6.2.2 sessionManager

```java
public class MySessionManager extends DefaultWebSessionManager {
    private static final String AUTHORIZATION = "Authorization";

    private static final String REFERENCED_SESSION_ID_SOURCE = "Stateless request";

    @Override
    protected Serializable getSessionId(ServletRequest request, ServletResponse response) {
        String id = WebUtils.toHttp(request).getHeader(AUTHORIZATION);
        //如果请求头中有 Authorization 则其值为sessionId
        if (!StringUtils.isEmpty(id)) {
            request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID_SOURCE, REFERENCED_SESSION_ID_SOURCE);
            request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID, id);
            request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID_IS_VALID, Boolean.TRUE);
            return id;
        } else {
            //否则按默认规则从cookie取sessionId
            return super.getSessionId(request, response);
        }
    }
}
```

#### 6.2.3 自定义拦截器

```java
public boolean onPreHandle(ServletRequest request, ServletResponse response, Object mappedValue) throws Exception {
    return isAccessAllowed(request, response, mappedValue) || onAccessDenied(request, response, mappedValue);
}
```

```java
public class MyAuthFilter extends FormAuthenticationFilter {
    
    //判断是否是POST请求，是的话则放行
    @Override
    protected boolean isAccessAllowed(ServletRequest request, ServletResponse response, Object mappedValue){
        HttpServletRequest httpServletRequest = (HttpServletRequest)request;
        return httpServletRequest.getMethod().equals(RequestMethod.OPTIONS.name());
    }

    //判断是否有权限
    @Override
    protected boolean onAccessDenied(ServletRequest servletRequest, ServletResponse servletResponse) throws Exception {
        HttpServletRequest httpServletRequest = (HttpServletRequest)servletRequest;
        String token = httpServletRequest.getHeader("Authorization");//从请求头中获取token
        Subject subject = SecurityUtils.getSubject();
        if (StringUtils.isBlank(token) || !subject.isAuthenticated()) {
            HttpServletResponse httpResponse = (HttpServletResponse) servletResponse;
            httpResponse.setHeader("Access-Control-Allow-Credentials", "true");//跨域时携带cookie
            httpResponse.setHeader("Access-Control-Allow-Origin", httpServletRequest.getHeader("Origin"));
            httpResponse.setCharacterEncoding("UTF-8");
            CommonResult commonResult = CommonResult.unauthorized(null);
            String json = JSON.toJSONString(commonResult);
            httpResponse.getWriter().print(json);
            return false;
        }
        return true;
    }
}
```

本身由于配置了跨域请求的配置类，是不会发送CORS错误的，但是使用了shiro之后，如果跨域请求在被处理前先被shiro拦截，那么就会发生CORS错误；

在发送复杂请求（如POST请求）时，服务器首先会发送一个OPTION请求，然后再发送一次POST请求；而token存在第二次POST请求中，因此在拦截时，碰到OPTION请求便直接放行，然后再对第二次的POST请求进行校验；

| 方法            | 描述                                                         |
| --------------- | ------------------------------------------------------------ |
| isAccessAllowed | 判断是否是POST请求，是的话则放行                             |
| onAccessDenied  | //判断是否有权限，如果没有权限，则要添加Header否则返回会被浏览器拦截 |



#### 6.2.3 Shiro配置类

**shiro框架组成**

![img](%E5%8F%98%E6%9E%84%E5%9B%A2%E9%A1%B9%E7%9B%AE%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0.assets/3.png)

**配置Shiro的SecurityManager：**

```java
@Bean(name = "securityManager")
public SecurityManager securityManager() {
    DefaultWebSecurityManager securityManager = new DefaultWebSecurityManager();
    // 设置realm.
    securityManager.setRealm(myRealm());
    //设置缓存管理器
    securityManager.setCacheManager(redisCacheManager());
    // 自定义session管理 使用redis
    securityManager.setSessionManager(sessionManager());
    return securityManager;
}
```

securityManager是shiro框架的控制器，处理subject和其他组件之间的各种交互

需要为其配置的就是需要交互的组件：

1. realm： shiro框架的安全数据源，通过其获得验证权限相关的数据，如账户密码
2. CacheManager： shiro框架的缓存管理器，来管理如用户、角色、权限等的缓存的
3. SessionManager： 用于管理会话

**realm**

```java
@Bean("myRealm")
public MyRealm myRealm() {
    MyRealm myRealm = new MyRealm();
    myRealm.setCredentialsMatcher(hashedCredentialsMatcher());
    return myRealm;
}

@Bean("hashedCredentialsMatcher")
    public HashedCredentialsMatcher hashedCredentialsMatcher() {
        HashedCredentialsMatcher hashedCredentialsMatcher = new HashedCredentialsMatcher();
        // 散列算法:这里使用MD5算法;
        hashedCredentialsMatcher.setHashAlgorithmName("md5");
        // 散列的次数，比如散列两次，相当于 md5(md5(""));
        hashedCredentialsMatcher.setHashIterations(Md5Util.HASH_ITERATIONS);
        return hashedCredentialsMatcher;
}
```

就是上面自定义的realm

重点是设置了自定义的校验方法

```java
myRealm.setCredentialsMatcher(hashedCredentialsMatcher());
```

由于数据库储存的密码一定是加密的，而用户提交的是明文密码，在这需要配置校验器，校验器会对token进行包装，然后再匹配；这里用的是md5

相关源码：

```java
protected Object hashProvidedCredentials(AuthenticationToken token, AuthenticationInfo info) {
        Object salt = null;
        if (info instanceof SaltedAuthenticationInfo) {
            salt = ((SaltedAuthenticationInfo) info).getCredentialsSalt();
        } else {
            //retain 1.0 backwards compatibility:
            if (isHashSalted()) {
                salt = getSalt(token);
            }
        }
        return hashProvidedCredentials(token.getCredentials(), salt, getHashIterations());
}

protected Hash hashProvidedCredentials(Object credentials, Object salt, int hashIterations) {
        String hashAlgorithmName = assertHashAlgorithmName();
        return new SimpleHash(hashAlgorithmName, credentials, salt, hashIterations);
}
```

通过info获取盐，然后用盐对token进行加密

**CacheManager**

```java
@Bean
public RedisCacheManager redisCacheManager() {
    RedisCacheManager redisCacheManager = new RedisCacheManager();
    redisCacheManager.setRedisManager(redisManager());
    return redisCacheManager;
}
```

使用redis缓存管理器，这里是用了shiro-redis工具

**SessionManager**

```java
@Bean
public DefaultWebSessionManager sessionManager() {
    MySessionManager sessionManager = new MySessionManager();
    sessionManager.setSessionDAO(redisSessionDAO());
    sessionManager.setGlobalSessionTimeout(4 * 1800000L);
    return sessionManager;
}
```

使用的自定义的sessionManager，并设置了SessionDAO，用于实现session的持久化，这里使用redisSessionDAO

**redisSessionDAO**

```java
@Bean
public RedisSessionDAO redisSessionDAO() {
    RedisSessionDAO redisSessionDAO = new RedisSessionDAO();
    redisSessionDAO.setRedisManager(redisManager());
    redisSessionDAO.setSessionIdGenerator(sessionIdGenerator());
    return redisSessionDAO;
}

@Bean
public JavaUuidSessionIdGenerator sessionIdGenerator() {
    return new JavaUuidSessionIdGenerator();
}
```

**redisManager**

不管是redisSessionDAO还是redisCacheManager都需要配置redisManager来管理redis的交互

```java
@Bean
public RedisManager redisManager() {
    RedisManager redisManager = new RedisManager();
    redisManager.setHost(host+":"+port);
    redisManager.setDatabase(database);
    redisManager.setTimeout(timeout);
    if (StringUtils.isNotBlank(password)) {
        redisManager.setPassword(password);
    }
    return redisManager;
}
```

**AOP控制**

```java
//启动切面控制
@Bean
@DependsOn("lifecycleBeanPostProcessor")//告诉IOC容器该bean应该先被加载
public DefaultAdvisorAutoProxyCreator defaultAdvisorAutoProxyCreator() {
    DefaultAdvisorAutoProxyCreator creator = new DefaultAdvisorAutoProxyCreator();
    creator.setProxyTargetClass(true);
    return creator;
}

//相当于切点
@Bean
public AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor(SecurityManager securityManager) {
    AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor = new AuthorizationAttributeSourceAdvisor();
    authorizationAttributeSourceAdvisor.setSecurityManager(securityManager);
    return authorizationAttributeSourceAdvisor;
}
```

注解式的权限控制需要配置两个Bean，第一个是AdvisorAutoProxyCreator，代理生成器，需要借助SpringAOP来扫描@RequiresRoles和@RequiresPermissions等注解，生成代理类实现功能增强，从而实现权限控制。需要配合AuthorizationAttributeSourceAdvisor一起使用，否则权限注解无效。

**生命周期控制器**

```java
@Bean(name = "lifecycleBeanPostProcessor")
public static LifecycleBeanPostProcessor getLifecycleBeanPostProcessor() {
    return new LifecycleBeanPostProcessor();
}
```

### 6.3 swagger2

#### 6.3.1 config

**创建api文档**

```java
@Bean
public Docket createRestApi(){
    return new Docket(DocumentationType.SWAGGER_2)  //指定api文档为swagger2类型
                   .apiInfo(apiInfo())              //文档的汇总信息
                   .select()//select()函数返回一个ApiSelectorBuilder实例用来控制哪些接口暴露给Swagger来展现
                   .apis(basePackage("edu.whut.mall.admin.controller" + splitor + "edu.whut.mall.common.controller"))//扫描的包路径
                   .paths(PathSelectors.any())//扫描该包下的所有Controller定义的API，并产生文档内容（除了被@ApiIgnore定义的请求）
                   .build()
                   .securitySchemes(securitySchemes())//securitySchemes配置全局参数
                   .securityContexts(Lists.newArrayList(securityContext()));//设置需要使用securitySchemes参数的接口
}
```

**API文档描述**

```java
private ApiInfo apiInfo(){
    return new ApiInfoBuilder()
            .title("    ")
            .contact(new Contact("wayne","www.footbook.com","975615347@qq.com"))
            .description("d9lab商城")
            .version("1.0.0")
            .termsOfServiceUrl("www.footbook.com").build();
}
```

**设置全局参数**

```java
private List<ApiKey> securitySchemes() {
//        设置请求头
        List<ApiKey> result = new ArrayList<>();
        ApiKey apiKey = new ApiKey("Authorization", "Authorization", "header");
        result.add(apiKey);
        return result;
    }

    private SecurityContext securityContext() {
        //设置需要登录认证的路径
        return SecurityContext.builder()
                .securityReferences(defaultAuth())
                .forPaths(PathSelectors.any())
                .build();
    }

    private List<SecurityReference> defaultAuth() {
        List<SecurityReference> result = new ArrayList<>();
        AuthorizationScope authorizationScope = new AuthorizationScope("global", "accessEverything");
        AuthorizationScope[] authorizationScopes = new AuthorizationScope[1];
        authorizationScopes[0] = authorizationScope;
        result.add(new SecurityReference("Authorization", authorizationScopes));
        return result;
    }
```

设置了全局的参数，登录后在value中输入返回的token，之后每次发送请求都会自动在请求头中添加 Authorization：value，从而解决前后端分离时需要主动在请求头中添加token的问题

![image-20210622115236111](%E5%8F%98%E6%9E%84%E5%9B%A2%E9%A1%B9%E7%9B%AE%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0.assets/image-20210622115236111.png)

#### 6.3.2 Api描述

#### 6.3.3 扫描包路径配置

```java
.apis(basePackage("edu.whut.mall.admin.controller" + splitor + "edu.whut.mall.common.controller"))//扫描的包路径

public static Predicate<RequestHandler> basePackage(final String basePackage) { 
    return input -> declaringClass(input).transform(handlerPackage(basePackage)).or(true);
}

private static Function<Class<?>, Boolean> handlerPackage(final String basePackage)     {
    return input -> {
        // 循环判断匹配
        for (String strPackage : basePackage.split(splitor)) {
            boolean isMatch = input.getPackage().getName().startsWith(strPackage);
            if (isMatch) {
                return true;
            }
        }
        return false;
    };
}

private static Optional<? extends Class<?>> declaringClass(RequestHandler input) {
    return Optional.fromNullable(input.declaringClass());
}
```

在配置中，调用了basePackage方法，这个方法的返回结果是一个Predicate类型，即返回了是一个lambda表达式，每个进来的bean根据这个表达式进行筛选，符合true的保留；

接下来分析这个lambda表达式：

1. 首先调用declaringClass这个方法，实际上就是获取了bean的所在类并且将其装入Optional中（Guava）
2. 接下来执行Option.transform(handlerPackage(basePackage))，transform的作用就是将Option的引用作为参数执行transform中的函数，因此handlerPackage()返回的是一个函数，它判断了类所在包是否在我们所规定的包下，不同的包名用splitor隔开，因此重新分隔后进行循环判断；
3. .or的作用是判断引用是否是null，是则返回默认值，不是则返回引用

### 6.4 D9Lab接入API



## 7. 注解相关

### 2.1 spring注解

| 注解          | 描述                                         |
| ------------- | -------------------------------------------- |
| @RequestParam | 从请求头中获取参数                           |
| @RequestBody  | 从请求体中获取参数，如json数据，适合批量数据 |
|               |                                              |



### 2.2 JSR 305注解

| 注解      | 作用                                                         |
| --------- | ------------------------------------------------------------ |
| @NonNull  | 在方法或构造函数的参数上使用，生成一个空值检查语句           |
| @NotBlank | 只能作用在String上，不能为null,而且调用trim()后，长度必须大于0 |
|           |                                                              |
|           |                                                              |



### 2.3 swagger注解

## 8. 项目部署

### 8.1 通过idea的docker插件进行部署

**部署步骤：**

1. 开放服务器2375端口

2. 通过docker插件连接服务器docker

   ![image-20210708202523232](%E5%8F%98%E6%9E%84%E5%9B%A2%E9%A1%B9%E7%9B%AE%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0.assets/image-20210708202523232.png)

3. 修改pom配置，在\<plugin>中添加以下代码

   ```xml
   <plugin>
       <groupId>com.spotify</groupId>
       <artifactId>docker-maven-plugin</artifactId>
       <executions>
           <execution>
               <id>build-image</id>
               <phase>package</phase>
               <goals>
                   <goal>build</goal>
               </goals>
           </execution>
       </executions>
       <configuration>
           <dockerDirectory>${project.artifactId}</dockerDirectory>
           <imageTags>
               <imageTag>latest</imageTag>
           </imageTags>
           <baseImage>java:8</baseImage>
           <entryPoint>["java", "-jar", "-Dfile.encoding=utf-8", "-Dsun.jnu.encoding=UTF-8", "-Duser.timezone=GMT+8", "${project.build.finalName}.jar"]</entryPoint>
           <dockerHost>https://http://106.14.16.235:2375/</dockerHost>
           <resources>
               <resource>
                   <targetPath>/</targetPath>
                   <directory>${project.build.directory}</directory>
                   <include>${project.build.finalName}.jar</include>
               </resource>
           </resources>
           <!--                    <serverId>docker-hub</serverId>-->
           <!--                    <registryUrl>https://index.docker.io/v1</registryUrl>-->
       </configuration>
   </plugin>
   ```

4. 新建一个DockerFile文件

   ```
   FROM java:8
   VOLUME /tmp
   #源jar和目标jar的名字
   ADD target/mymbg-0.0.1-SNAPSHOT.jar app.jar
   ENTRYPOINT ["java","-Djava.security.egd=file:/dev/./urandom","-jar","/app.jar"]
   ```

5. 新建一个dockerFileConfigure

   ![image-20210708203950708](%E5%8F%98%E6%9E%84%E5%9B%A2%E9%A1%B9%E7%9B%AE%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0.assets/image-20210708203950708.png)

   ![image-20210730123958810](%E5%8F%98%E6%9E%84%E5%9B%A2%E9%A1%B9%E7%9B%AE%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0.assets/image-20210730123958810.png)

6. 将项目打包成jar，再执行创建好的dockerFile

   ![image-20210708204142733](%E5%8F%98%E6%9E%84%E5%9B%A2%E9%A1%B9%E7%9B%AE%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0.assets/image-20210708204142733.png)

   